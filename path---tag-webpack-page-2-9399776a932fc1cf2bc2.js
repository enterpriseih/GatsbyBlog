webpackJsonp([0xfa62ee07cab9],{1504:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录 问题及解决方案 标记为横线的为完成需求后发现现阶段不需要做的 跨域窗口间的通信： 编写底层通信库 、通过 url 传递 嵌入公司产品端：独立客服聊天组件的运行环境 设置新窗口位置：需要注意兼容分屏情况 监听新窗口打开情况： 通过底层库发消息 、获取 window.open 的 closed…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录</p>\n<h1 id="问题及解决方案"><a href="#%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题及解决方案</h1>\n<p>标记为横线的为完成需求后发现现阶段不需要做的</p>\n<ol>\n<li>跨域窗口间的通信：<s>编写底层通信库</s>、通过 url 传递</li>\n<li>嵌入公司产品端：独立客服聊天组件的运行环境</li>\n<li>设置新窗口位置：需要注意兼容分屏情况</li>\n<li>监听新窗口打开情况：<s>通过底层库发消息</s>、获取 window.open 的 closed 属性</li>\n<li><s>监听新窗口是否加载完成</s>：<s>通过底层库发消息</s></li>\n<li>聊天消息输入类 html 字符：匹配特定字符进行 html 渲染，其他字符按文本渲染</li>\n</ol>\n<h1 id="具体解决"><a href="#%E5%85%B7%E4%BD%93%E8%A7%A3%E5%86%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体解决</h1>\n<h2 id="跨域窗口间通信"><a href="#%E8%B7%A8%E5%9F%9F%E7%AA%97%E5%8F%A3%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域窗口间通信</h2>\n<h3 id="底层库编写"><a href="#%E5%BA%95%E5%B1%82%E5%BA%93%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>底层库编写</h3>\n<p>因为需要知道打开的是哪个技能组（相当于群），需要传递技能组的相关信息，首先需要编写底层库，核心代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76410281279781720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default class Bus {\n    private syncFns: Array<SyncFn> = []\n\n    constructor(public origin: string, syncFn: SyncFn | Array<SyncFn>) {\n        this.init()\n        this.syncFns = Array.isArray(syncFn) ? syncFn : [syncFn]\n    }\n\n    private init(): void {\n        window.addEventListener(&quot;message&quot;, this.receiveMsg.bind(this), false)\n    }\n\n    // 获取跨域消息\n    private receiveMsg(e) {\n        const { origin } = e\n        if (this.origin !== \'*\' && origin !== this.origin) return\n        const { name, data } = e.data\n        this.syncFns.forEach(item => {\n            if (item.name === name) {\n                item.fn(data, e)\n            }\n        })\n    }\n\n    // 发送跨域消息\n    postMessage(windowInstance: object, swMessage: SWMessage, targetOrigin: string) {\n        windowInstance && windowInstance.postMessage(swMessage, targetOrigin)\n    }\n}`, `76410281279781720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Bus</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> syncFns<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> origin<span class="token punctuation">:</span> string<span class="token punctuation">,</span> syncFn<span class="token punctuation">:</span> SyncFn <span class="token operator">|</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>syncFn<span class="token punctuation">)</span> <span class="token operator">?</span> syncFn <span class="token punctuation">:</span> <span class="token punctuation">[</span>syncFn<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">receiveMsg</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 获取跨域消息</span>\n    <span class="token keyword">private</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> e\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token string">\'*\'</span> <span class="token operator">&amp;&amp;</span> origin <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token keyword">return</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                item<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 发送跨域消息</span>\n    <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">windowInstance<span class="token punctuation">:</span> object<span class="token punctuation">,</span> swMessage<span class="token punctuation">:</span> SWMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        windowInstance <span class="token operator">&amp;&amp;</span> windowInstance<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>swMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="传递数据"><a href="#%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传递数据</h3>\n<p>注意加重部分，由于以上代码不知道什么时候新窗口加载完毕，提前发送消息会没效果，所以设置了延时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39424904727598770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  setTimeout(() => {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 2000);\n});`, `39424904727598770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-24}"\n              >\n                <span class="gatsby-code-button-language">js{13-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88752648107788550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);`, `88752648107788550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行效果：</p>\n<p><img src="/static/cross-origin-1-12fef4bc58b79e2c34b6982487f764b8.gif" alt="跨域传输"></p>\n<h3 id="监听新窗口是否加载完成"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口是否加载完成</h3>\n<p>setTimeout 设置的延时不够准确，需要采用以下方案</p>\n<h4 id="监听-windowopen-的-onload-事件（跨域下失效）"><a href="#%E7%9B%91%E5%90%AC-windowopen-%E7%9A%84-onload-%E4%BA%8B%E4%BB%B6%EF%BC%88%E8%B7%A8%E5%9F%9F%E4%B8%8B%E5%A4%B1%E6%95%88%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听 window.open 的 onload 事件（跨域下失效）</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68568243286364865000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  popup.onload = function() {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  };\n});`, `68568243286364865000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-24}"\n              >\n                <span class="gatsby-code-button-language">js{13-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  popup<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚开始打算监听 window.open 的 onload 事件，但是在不同域名下会报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-63438.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 13.785790031813361%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAlklEQVQI1zXGQQ6CMBBAUe5/ORQXJgIFKaVFhZmhtXSKpOLC5OXnZ+NYTXNHpAAkYk/YI0iCzpIiMq2SRgttmkGLx/MOqAEHmBXCcMhWUXB9CqLwoljbi2sKqvKpzo04v+5XVDcem6jKqGs+qJKN4LkPkwRVZsn5hEsimxaXyLH1YXGenCMb7HvnmHhLv/4nftK2H3bevrm4ptENSXdeAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 21 58 38" title="" data-src="/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-fee1c.png" data-srcset="/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-a67b7.png 200w,\n/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-0b187.png 400w,\n/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-fee1c.png 800w,\n/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-63438.png 943w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="跨域发送消息检测加载完成"><a href="#%E8%B7%A8%E5%9F%9F%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%A3%80%E6%B5%8B%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域发送消息检测加载完成</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22970208942148805000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar isLoaded = false;\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  },\n  {\n    name: \'newWindowLoad\',\n    fn: () => {\n      isLoaded = true;\n      console.log(\'新窗口加载完成\');\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  isLoaded = false;\n  var timer = setInterval(() => {\n    if (!isLoaded) {\n      return;\n    }\n    timer && clearInterval(timer);\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 0);\n});`, `22970208942148805000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,10-16,21-37}"\n              >\n                <span class="gatsby-code-button-language">js{2,10-16,21-37}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      isLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'新窗口加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71433774765614875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);\n\ncaller.postMessage(\n  window.opener,\n  {\n    name: \'newWindowLoad\'\n  },\n  \'http://localhost:10001\'\n);`, `71433774765614875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{21-27}"\n              >\n                <span class="gatsby-code-button-language">js{21-27}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  window<span class="token punctuation">.</span>opener<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token string">\'http://localhost:10001\'</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当新窗口的页面加载完毕时会发出 <code class="language-text">newWindowLoad</code> 消息，主页面接收后，标志变量 <code class="language-text">isLoaded</code> 置为 <code class="language-text">true</code>，此时尚在轮询的消息就可以发出。</p>\n<p><img src="/static/cross-origin-2-4340a95c494c85d0372f941fff11e3c5.gif" alt="跨域传输"></p>\n<h3 id="通过-url-传递数据"><a href="#%E9%80%9A%E8%BF%87-url-%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通过 url 传递数据</h3>\n<p>之后由于新窗口需要刷新后也要保持当前技能组的打开，以上方案在刷新新窗口后数据会丢失，所以通过 url 来传递数据</p>\n<h2 id="独立客服组件运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E5%AE%A2%E6%9C%8D%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立客服组件运行环境</h2>\n<p>由于客服组件需要嵌入公司产品端，因为采用的技术栈和公司产品端的技术栈一致，这时会遇到很多问题：</p>\n<ol>\n<li>react 和 react-lite 的冲突，react 16 与 react 15 不能同时引入到一个页面，具体见 <a href="https://github.com/facebook/react/issues/16029" target="_blank" rel="nofollow noreferrer noopener">https://github.com/facebook/react/issues/16029</a> <html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-50858.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.893106893106893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAOElEQVQI1x2K2wkAIAwD3X9GH622I6jph2AUjsAdSWG+c0W3GMSflkZFU1ThskP600/o4A1qZ64LhWw20TUfTUwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 22 25 58" title="" data-src="/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-fee1c.png" data-srcset="/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-a67b7.png 200w,\n/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-0b187.png 400w,\n/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-fee1c.png 800w,\n/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-50858.png 1001w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></li>\n<li>babel-polyfill 引入 2 次导致不能正常加载 <html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-8f59e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 6.003937007874017%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAASElEQVQI1wE9AML/AObk5OnMxOrJwenIwOrLw+rLw+vKwurGv/ji2v/x5v3s4v7w5v727P727PDo3+nh2Oni2ebe1u7n3tbPxzAzNIILCc3LAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 22 30 23" title="" data-src="/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-fee1c.png" data-srcset="/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-a67b7.png 200w,\n/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-0b187.png 400w,\n/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-fee1c.png 800w,\n/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-8f59e.png 1016w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></li>\n</ol>\n<h3 id="独立运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立运行环境</h3>\n<p>由于在开发服本地是正常的，编译为生产版本后冲突，首先想到了是不是生成文件 js 编号的冲突，于是做出以下修改</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82871321615860550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`optimization: {\n  // 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key\n  namedModules: true,\n  // 分包文件同理\n  namedChunks: true,\n}`, `82871321615860550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key</span>\n  namedModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token comment">// 分包文件同理</span>\n  namedChunks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后发现 react 和 react-lite 的共存时还是会报错，除非能保证客服组件的脚本能先于公司产品端去加载，这样的话就需要动到各个产品端的 index.html 文件，然而这样的话改动影响面会比较大，也不好在 index.html 中去读取到环境变量</p>\n<p>最后理了下思路，发现应该是产品端所有加载文件默认都在 webpackJsonp 变量下，需要将客服组件项目加载到不同的变量下才能做到环境上的隔绝</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51565689928398406000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: {\n  filename: \'[name].js\',\n  chunkFilename: \'[name].[chunkhash].chunk.js\',\n  // 关键的一步，使同一网页上的多个 webpack 运行，互不影响\n  jsonpFunction: \'ponyWebpackJsonp\',\n},`, `51565689928398406000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{5}"\n              >\n                <span class="gatsby-code-button-language">js{5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n  chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n  <span class="token comment">// 关键的一步，使同一网页上的多个 webpack 运行，互不影响</span>\n<span class="gatsby-highlight-code-line">  jsonpFunction<span class="token punctuation">:</span> <span class="token string">\'ponyWebpackJsonp\'</span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>具体的原理可参考：<a href="/module-federation-principle-research/">Module federation 原理研究</a></p>\n<h3 id="babel-polyfill-引入-2-次"><a href="#babel-polyfill-%E5%BC%95%E5%85%A5-2-%E6%AC%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel-polyfill 引入 2 次</h3>\n<p>这里的话因为引入了 babel-polyfil，所以需要将客服组件项目中的 <code class="language-text">global._babelPolyfill = true;</code> 这一行屏蔽掉，防止公司产品端报错，暂时未想到更好的办法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65758026314164790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// global._babelPolyfill = true;`, `65758026314164790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// global._babelPolyfill = true;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="设置新窗口位置"><a href="#%E8%AE%BE%E7%BD%AE%E6%96%B0%E7%AA%97%E5%8F%A3%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置新窗口位置</h2>\n<p>需要注意下分屏的情况，新窗口在副屏的定位是错的，需要做特殊处理，主屏上没问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84479875105917450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 兼容左右分屏情况\nconst { availTop, availLeft } = window.screen;\nif (availLeft) {\n  left += availLeft;\n}\nif (availTop) {\n  top += availTop;\n}`, `84479875105917450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 兼容左右分屏情况</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> availTop<span class="token punctuation">,</span> availLeft <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  left <span class="token operator">+=</span> availLeft<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  top <span class="token operator">+=</span> availTop<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://segmentfault.com/a/1190000017989734" target="_blank" rel="nofollow noreferrer noopener">chrome 弹窗在双屏情况下 left 居中定位异常分析</a></p>\n<h2 id="监听新窗口打开情况"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%89%93%E5%BC%80%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口打开情况</h2>\n<p>通过监听 window.open 的 closed 属性，因为有多个新窗口打开，需要遍历 window.open 数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92966839460729620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.popups = [];\nconst popup = window.open(url, \'\');\nthis.popups.push(popup);\n\n// 得到打开的新窗口\nthis.popups.filter((item) => !item.closed);`, `92966839460729620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>popups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>popup<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 得到打开的新窗口</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>item<span class="token punctuation">.</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="解决聊天框代码注入"><a href="#%E8%A7%A3%E5%86%B3%E8%81%8A%E5%A4%A9%E6%A1%86%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决聊天框代码注入</h2>\n<p>由于聊天表情是由有限的几个字符组成的，格式为 <code class="language-text">[高兴]</code>, 所以只要匹配这几个字符，然后以 dangerouslySetInnerHTML 渲染，其他字符以普通文本字符渲染就可以</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5670689233464587000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法\nrenderText = (text) => {\n  const renderContent = [];\n  text.replace(/\\[([^[\\]]+?)\\]|./g, (symbol) => {\n    if (/\\[([^[\\]]+?)\\]/.test(symbol) && EmojiList.find((item) => item.symbol === symbol)) {\n      renderContent.push(<span dangerouslySetInnerHTML={{ __html: symbolToHTML(symbol) }} />);\n    } else {\n      renderContent.push(symbol);\n    }\n  });\n  return <div>{renderContent}</div>;\n};`, `5670689233464587000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法</span>\n<span class="token function-variable function">renderText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> renderContent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]|./g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> EmojiList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>symbol <span class="token operator">===</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>span dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token function">symbolToHTML</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>renderContent<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果截图"><a href="#%E6%95%88%E6%9E%9C%E6%88%AA%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果截图</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-83c29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 89.75069252077562%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACDElEQVQ4y5VTy27TQBT177Fo+QIeCQsk1E2rwqIViAUP0Q3rrlgWaIpAICTUDaACoSA1NCVqUGMjSGvXSuyMPTOZh2eGO7FqUmyBOD4ejaw5c8992EGEfdhzt3a+vm91Pra7zd1us225vfft9XZr61OLMWaM0cZCCBGGIULIftHa2e315+6tLt1duXp7Ze7GrYuLy7XF5fq165eXbsJm4c79JEnzo7BKKY7DsPjitPto/llw5emwvh6eXzuqPz6+8NCvPQourYe1xvDFjq84yZTOMgWUWSbgzfdSOZ9/0HPPs7NPzEzDzG6YmRPC/kzDPHjjcYK41FxkZTqUUiWZUUBuNIe87KqY1gq8ffdcjImpgrWdEgJOICPwpoDa0u61LVLP9TD5LZZSYozBd148hxDKOc/roU/DlMQgA6e5GAC2x8koJpRWil3vlHgaSikHE8q4Bdz3z8jTmNimFCfJYDCoFB/03DTFlWI4b8XsBOCkFBmqXS22OYOr0QjlR8v4S85WDNWGR3AuJpmrKVjbrjuMkZCKcfkH7ZBAwQbDSEporZHKdrjgdM66BJFJG1mMidECil825gcBnXSxmKpJk+0ARTy2OTe95GUn2dxPN7u44Kt9/M4lh36Q/5JFe6IIbEpt1JforQO5HUWkF6SH8bgf0YI/I+rHEJVW1hLG9wB1nNwMXGb+B3AhZeYXi9D0x5Aq08YAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 23 11 11" title="" data-src="/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-83c29.png" data-srcset="/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-5b578.png 200w,\n/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-4dff0.png 400w,\n/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-83c29.png 722w" data-sizes="(max-width: 722px) 100vw, 722px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-a2194.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 750px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACMUlEQVQ4y31STWsUQRBtvfh3/A3eJQcPnlQEUUGQiEtEUBMXExD06kfOoh70pEtQTwY8KyQXzW52N9mdzM5Md093T3/OlzWbzbC7iT5qimGmX9WrfoUuN9cvNR5caTy8uvTo4u2l89cXF27euXCrsXBj8e7ac855eYSiKOoMyPMcvfw+fLXpPf3mrbT6zdbe8qfe8ud+c2N/ZcNb3xyI/5PPvbHXvpRnnpWnVkv0pESrVZxeK9Dj8uwLwRmVUhJCrLXlLNIsRx+3ktaf9P2WezcT9u12/uFn5HkeKGcszrKs7g/veYUMWcnL3BZOidDno4EIhhIHRaqgdEyjdqczHA4ojWvB1jlGyRCz1x2DQsqFsjzRIZW/PbnryyiWLNGJdn5Idto77XYnjHBRTz7O1JX3f2WIxFxpK5VJlA2YjTi8Wym1Ni6ISISx1hoGBpVHsqtMTHnvxxQZAhgQVSGpjU0PRuHe/kBrNfJ9pfR0Z5OVX7uz5DomZD/o9vpJklBKrTXThk2swrVsOR0V2fPD3W4vCEZCiPIYKqso4yAJhjTG1TEeM8UkZpynYxwng1+IcZEkQspk5keaQjDGCaFznBnZUqmqcpbVa1CfgKrs3+sJ5xEMN7c60PPQGGDGjIlE4Ag75+YkRIagCJOIwArFkMBVTCpvq4+YHPgjMgasdzHGdGeXOWSti4WE+4Ha8NgKkwzTwNHDfPKF5UVh0xyOQzsg1JdhjIEMJhd5ceLMXGV/AVIJsfFk9b2VAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 07 01 23 14 38" title="" data-src="/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-a2194.png" data-srcset="/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-2e341.png 200w,\n/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-e3a06.png 400w,\n/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-a2194.png 750w" data-sizes="(max-width: 750px) 100vw, 750px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>传递到新窗口的 url 过长需要编码</li>\n<li>独立运行环境部分的 react 冲突可能是作用域提升导致的冲突，待具体研究</li>\n<li>babel-polyfill 引入 2 次，如何复用 ployfill 的代码待研究</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/客服新窗口技术探索/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2020-07-01 20:15:50",path:"/new-window-technology-research/",tags:"前端, 跨域通信, webpack, 预研",title:"客服新窗口技术探索",draft:null}},{excerpt:"从 2017 年发出关于 v5 的投票开始，到 2019 年 10 月发布第一个 beta 版本，目前是 5.0.0-beta.16。现在在收集使用反馈、生态升级的过程中，相信不久后就可以正式发布了。这次升级重点：性能改进、Tree Shacking、Code Generation、Module Federation。 下面我们跟着 Changelog 来动手，测测重点内容~ 优化持久缓存 首先简单说 Webpack 中 graph 的概念： Webpack 在执行的时候，以配置的 entry…",html:'<p>从 2017 年发出关于 v5 的投票开始，到 2019 年 10 月发布第一个 beta 版本，目前是 5.0.0-beta.16。现在在收集使用反馈、生态升级的过程中，相信不久后就可以正式发布了。这次升级重点：性能改进、Tree Shacking、Code Generation、Module Federation。</p>\n<p>下面我们跟着 Changelog 来动手，测测重点内容~</p>\n<h1 id="优化持久缓存"><a href="#%E4%BC%98%E5%8C%96%E6%8C%81%E4%B9%85%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化持久缓存</h1>\n<p>首先简单说 Webpack 中 graph 的概念：</p>\n<p>Webpack 在执行的时候，以配置的 entry 为入口，递归解析文件依赖，构建一个 graph，记录代码中各个 module 之间的关系。每当有文件更新的时候，递归过程会重来，graph 发生改变。</p>\n<p>如果简单粗暴地重建 graph 再编译，会有很大的性能开销，Webpack 利用缓存实现增量编译，从而提升构建性能。</p>\n<p>缓存（内存 / 磁盘两种形式）中的主要内容是 module objects，在编译的时候会将 graph 以二进制或者 json 文件存储在硬盘上。每当代码变化、模块之间依赖关系改变导致 graph 改变时，Webpack 会读取记录做增量编译。</p>\n<h2 id="之前持久缓存的方式"><a href="#%E4%B9%8B%E5%89%8D%E6%8C%81%E4%B9%85%E7%BC%93%E5%AD%98%E7%9A%84%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前持久缓存的方式</h2>\n<p>之前可以使用 loader 设置缓存：</p>\n<ol>\n<li>使用 cache-loader 可以将编译结果写入硬盘缓存，Webpack 再次构建时如果文件没有发生变化则会直接拉取缓存</li>\n<li>还有一部分 loader 自带缓存配置，比如 babel-loader，可以配置参数 cacheDirectory 使用缓存，将每次的编译结果写进磁盘（默认在 node_modules/.cache/babel-loader 目录），UglifyJsPlugin 插件中的 cache 选项</li>\n<li>terser-webpack-plugin 开启缓存</li>\n<li>hard-source-webpack-plugin 插件</li>\n<li>webpack.DllPlugin 插件</li>\n</ol>\n<h2 id="现在的方案"><a href="#%E7%8E%B0%E5%9C%A8%E7%9A%84%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现在的方案</h2>\n<p>v5 中缓存默认是 memory，你可以修改设置写入硬盘：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69035677207719060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  cache: {\n    type: \'filesystem\',\n    // cacheDirectory 默认路径是 node_modules/.cache/webpack\n    cacheDirectory: path.resolve(__dirname, \'.temp_cache\')\n  }\n};`, `69035677207719060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cache<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> <span class="token string">\'filesystem\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// cacheDirectory 默认路径是 node_modules/.cache/webpack</span>\n    cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'.temp_cache\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注：对大部分 <code class="language-text">node_modules</code> 哈希处理以构建依赖项，代价昂贵，还降低 Webpack 执行速度。为避免这种情况出现，Webpack 加入了一些优化，默认会跳过 <code class="language-text">node_modules</code>，并使用 package.json 中的 version 和 name 作为数据源，有点类似于 webpack.DllPlugin</p>\n<h1 id="优化长期缓存"><a href="#%E4%BC%98%E5%8C%96%E9%95%BF%E6%9C%9F%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化长期缓存</h1>\n<p>Webpack 5 针对 moduleId 和 chunkId 的计算方式进行了优化，增加确定性的 moduleId 和 chunkId 的生成策略。moduleId 根据上下文模块路径，chunkId 根据 chunk 内容计算，最后为 moduleId 和 chunkId 生成 3 - 4 位的数字 id，实现长期缓存，生产环境下默认开启。</p>\n<h2 id="对比原来的-moduleid"><a href="#%E5%AF%B9%E6%AF%94%E5%8E%9F%E6%9D%A5%E7%9A%84-moduleid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对比原来的 moduleId</h2>\n<p>原来的 moduleId 默认值是自增 id，容易导致文件缓存失效。在 v4 之前，可以安装 HashedModuleIdsPlugin 插件覆盖默认的 moduleId 规则， 它会使用模块路径生成的 hash 作为 moduleId。在 v4 中，可以配置 optimization.moduleIds = ‘hashed’</p>\n<h2 id="对比原来的-chunkid"><a href="#%E5%AF%B9%E6%AF%94%E5%8E%9F%E6%9D%A5%E7%9A%84-chunkid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对比原来的 chunkId</h2>\n<p>原来的 chunkId 默认值自增 id。比如这样的配置下，如果有新的 entry 增加，chunk 数量也会跟着增加，chunkId 也会递增。之前可以安装 NamedChunksPlugin 插件来稳定 chunkId；或者配置 optimization.chunkIds = ‘named’</p>\n<h1 id="nodejs-的-polyfill-脚本被移除"><a href="#nodejs-%E7%9A%84-polyfill-%E8%84%9A%E6%9C%AC%E8%A2%AB%E7%A7%BB%E9%99%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NodeJS 的 polyfill 脚本被移除</h1>\n<p>最开始，Webpack 目标是允许在浏览器中运行 Node 模块。但是现在在 Webpack 看来，大多模块就是专门为前端开发的。在 v4 及以前的版本中，对于大多数的 Node 模块会自动添加 polyfill 脚本，polyfill 会加到最终的 bundle 中，其实通常情况下是没有必要的。在 v5 中将停止这一行为。</p>\n<p>比如以下一段代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72946973715320190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// index.js\nimport sha256 from \'crypto-js/sha256\';\n\nconst hashDigest = sha256(\'hello world\');\nconsole.log(hashDigest);`, `72946973715320190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// index.js</span>\n<span class="token keyword">import</span> sha256 <span class="token keyword">from</span> <span class="token string">\'crypto-js/sha256\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> hashDigest <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hashDigest<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 v4 中，会主动添加 crypto 的 polyfill，也就是 crypto-browserify。我们运行的代码是不需要的，反而最后的包变大，编译结果 <code class="language-text">417 kb</code>：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-15-19-bf4623ed1c02f090d14c72b3bd4b854b-6e10a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.8%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAElEQVQY04VQXW+DMBCDgpZQEsIllHxBESqMUbb///fmFq0S2kP9EOXu7JydJGe5neZmGMx1MDFWUgoh6rouiiJ5i7IsG601kSGylwdQQWyMwd17b+3evoQQ2raNMTrnUDZNkzDOKkApaHYBujjBa56AHiNQ2ifwBGj7KMFAKTX/YV3XZVmICKbSNH1jOz4QIBsQW+txHOEzz/Nd/MKLf+jAYwjR+wCnRFpK2XUdUjnrsizbBafTiTGGL+ScHzZrEvf7TIRI9dcykjbbtiFVpaWoz2fBlOJEyPUJa33fH8TTLc5Th49c12nb+vmmOf8YvuP1x5GvSsGclaLk2Pw/8i9lKhuJtE/JVAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 15 19" title="" data-src="/static/2020-06-23-12-15-19-bf4623ed1c02f090d14c72b3bd4b854b-fee1c.png" data-srcset="/static/2020-06-23-12-15-19-bf4623ed1c02f090d14c72b3bd4b854b-a67b7.png 200w,\n/static/2020-06-23-12-15-19-bf4623ed1c02f090d14c72b3bd4b854b-0b187.png 400w,\n/static/2020-06-23-12-15-19-bf4623ed1c02f090d14c72b3bd4b854b-fee1c.png 800w,\n/static/2020-06-23-12-15-19-bf4623ed1c02f090d14c72b3bd4b854b-6e10a.png 1000w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 v5 中，如果遇到了这样的情况，会提示你进行确认。如果确认不需要 node polyfill，按照提示 alias 设置为 false 即可。最后的编译结果仅有 <code class="language-text">5.69 kb</code>：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-15-57-da36cc606b3598c2f2a469651b741aff-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.01851851851852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABn0lEQVQoz41S2Y6bQBAEGzAYmPtgDjCXwUB8RPFD/v/L0qwSJU+bbZVarZKaquohcM4ZY6BjjL33MMRxHHyxjDPWWUopfCIvclUpWI6O0fF4DMJgxyfle2dqDZva6GrgxBZplmZZliTJ/5X7rn+/38/H83q9TvO0PG9157P0jEnJHY7T6LNlSlnXdcMwXC4X0GeMIYRAG7ECqzw8fOp7miznRYmwr+uqqqRSUkohJSEUC1TgPElOpzQF/Fs7czoFP173b+ttW5Z5HJXginOjlRKiUopRRFCpuDBqZ4zWQAK0lAAhRPBzXZdheC23W9dem8YyNnjfaDU4N7c70zvbOzd4d23qW9tOTQOkys8HsA0sk9LC+3oPvTKmshZsX9oWZgo3EAI6/+iEUkzIuSjoOYsOh0CVZYnQOI7TNMHBt21b1xX+FnCntD7nufwozvke8s/DF3EUhWFQcwYZX/c7xJ7G8bFt35/PZZ6t1oIzWIJ4zlQajgguCAHBQxjiJNmXLSVj7R/zBAmXvgfA4AT3QqBTAgq/EUV/5zjK4wgs/AKCSi9HvpO8xgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 15 57" title="" data-src="/static/2020-06-23-12-15-57-da36cc606b3598c2f2a469651b741aff-fee1c.png" data-srcset="/static/2020-06-23-12-15-57-da36cc606b3598c2f2a469651b741aff-a67b7.png 200w,\n/static/2020-06-23-12-15-57-da36cc606b3598c2f2a469651b741aff-0b187.png 400w,\n/static/2020-06-23-12-15-57-da36cc606b3598c2f2a469651b741aff-fee1c.png 800w,\n/static/2020-06-23-12-15-57-da36cc606b3598c2f2a469651b741aff-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>配置 <code class="language-text">resolve.alias: { crypto: false }：</code></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-16-18-c382949eb2312558db65901965f8b2f8-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.2962962962963%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABMElEQVQoz42R227CMAyGgR5IybFN0jRt0nbiUIREmSYYmxAS7/9U8wq7mAYa34XlJHb82x4RjGWWcsa0lCbPlVJSSrBaa2utMQZ8sEVRwLEYgIDxeDwCEEIY4yzL4CofSNMUDxBChBDT6TRJEvA55/iHIAi+k6uqcs71fb/dbruuO51Om81mNpuNngEKQlkQA3/HccwoU1JRyv5G3qT+Ss7lar3knDVNA11RRipfEkpAWBiGN3mPsK1puzqTadu0ulDlWsuaJwQxxqC3f/SDSEhbLBfQeWFNURlTa9PkEYrgdTKZhFEQofCOZgCGdD6fL5fL4XB4Px53u9f9/u3jcz+ft85XL6u67UvdZA9kW+u9Xw9472ChSgnvRGmFLoV0ApH4ftkrMBVK6XWrzy5p4As9lx7T8oYcawAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 16 18" title="" data-src="/static/2020-06-23-12-16-18-c382949eb2312558db65901965f8b2f8-fee1c.png" data-srcset="/static/2020-06-23-12-16-18-c382949eb2312558db65901965f8b2f8-a67b7.png 200w,\n/static/2020-06-23-12-16-18-c382949eb2312558db65901965f8b2f8-0b187.png 400w,\n/static/2020-06-23-12-16-18-c382949eb2312558db65901965f8b2f8-fee1c.png 800w,\n/static/2020-06-23-12-16-18-c382949eb2312558db65901965f8b2f8-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>浏览器执行结果：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-16-40-8423eecff963f4e61c67541cedeaee08-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAzElEQVQY06VQ2W7DMAzz/39kgQ2209SXJB9JIy+dnG7FtqehJQiBkCkZomLm2poP8eK81sYYq4Xa6EMYO92bCXBZ17YsP6luL2AM7/+AuA7//nf4+Z8RMcYIgHJ2SokIpEozhECEAAkARKeBYZBjBfeqpsnGEJyL2jpJaL7EXFqpg7UutQ6n91FrKxsACTETZYAsUPZ0nq1/e3fzTD5ke25UOCHX2pGYMlPpuTDg9i241B7i1vuH4mvfVpb1jzCOfH5Ftd/2R6xf70f9BPIEz3oSGxRyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 16 40" title="" data-src="/static/2020-06-23-12-16-40-8423eecff963f4e61c67541cedeaee08-fee1c.png" data-srcset="/static/2020-06-23-12-16-40-8423eecff963f4e61c67541cedeaee08-a67b7.png 200w,\n/static/2020-06-23-12-16-40-8423eecff963f4e61c67541cedeaee08-0b187.png 400w,\n/static/2020-06-23-12-16-40-8423eecff963f4e61c67541cedeaee08-fee1c.png 800w,\n/static/2020-06-23-12-16-40-8423eecff963f4e61c67541cedeaee08-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="更好的-treeshaking"><a href="#%E6%9B%B4%E5%A5%BD%E7%9A%84-treeshaking" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更好的 TreeShaking</h1>\n<p>现在有这样一段代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87613056343231820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// inner.js\nexport const a = \'aaaaaaaaaa\';\nexport const b = \'bbbbbbbbbb\';\n\n// module.js\nimport * as inner from \'./inner\';\nexport { inner };\n\n// index.js\nimport * as module from \'./module\';\nconsole.log(module.inner.a);`, `87613056343231820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// inner.js</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">\'aaaaaaaaaa\'</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token string">\'bbbbbbbbbb\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// module.js</span>\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> inner <span class="token keyword">from</span> <span class="token string">\'./inner\'</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> inner <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// index.js</span>\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> module <span class="token keyword">from</span> <span class="token string">\'./module\'</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 v4 中毫无疑问，以上代码 a、b 变量是被全部打包的：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-17-10-c49f37ae21ac76624aab439f20605f5c-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.37037037037037%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAb0lEQVQY05WQixHCMAzFskga+9mOnaY/Ctyx/2QcG2AtoJNK9zBfVdXMWmtLhgLI435t62CiJUlh5rnt4Q4x0c5M7W8KEc2xHnNHD7GgjP9nDh9uLgAzUtUFInFc7+f5uU8F11RzhENFVRioNTfsCy4HNJ2FRo3+AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 17 10" title="" data-src="/static/2020-06-23-12-17-10-c49f37ae21ac76624aab439f20605f5c-fee1c.png" data-srcset="/static/2020-06-23-12-17-10-c49f37ae21ac76624aab439f20605f5c-a67b7.png 200w,\n/static/2020-06-23-12-17-10-c49f37ae21ac76624aab439f20605f5c-0b187.png 400w,\n/static/2020-06-23-12-17-10-c49f37ae21ac76624aab439f20605f5c-fee1c.png 800w,\n/static/2020-06-23-12-17-10-c49f37ae21ac76624aab439f20605f5c-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>但我们只调用了 a 变量，理想情况应该是 b 被识别为 unused，不被打包。这一优化在 v5 中实现了。在 v5 中会分析模块 export 与 import 之间的依赖关系，最终的代码生成非常简洁：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-17-33-e3f5619861dd1660853633f5f2b1806b-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 8.148148148148147%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAUUlEQVQI12XMyQ2AMAxE0TQSjOMlMZGyQf+1YSFxQLzz/Al9nnP00exai0smlVrNshTlehgRAcD+A4+AJOwTREroJSl7aipF/CpjSjHG7QteNzSbEKrSTad2AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 17 33" title="" data-src="/static/2020-06-23-12-17-33-e3f5619861dd1660853633f5f2b1806b-fee1c.png" data-srcset="/static/2020-06-23-12-17-33-e3f5619861dd1660853633f5f2b1806b-a67b7.png 200w,\n/static/2020-06-23-12-17-33-e3f5619861dd1660853633f5f2b1806b-0b187.png 400w,\n/static/2020-06-23-12-17-33-e3f5619861dd1660853633f5f2b1806b-fee1c.png 800w,\n/static/2020-06-23-12-17-33-e3f5619861dd1660853633f5f2b1806b-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="module-federation"><a href="#module-federation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module Federation</h1>\n<p>让 Webpack 达到了线上 runtime 的效果，让代码直接在独立应用间利用 CDN 直接共享，不再需要本地安装 NPM 包、构建再发布了！</p>\n<h2 id="之前共享代码的处理方式"><a href="#%E4%B9%8B%E5%89%8D%E5%85%B1%E4%BA%AB%E4%BB%A3%E7%A0%81%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前共享代码的处理方式</h2>\n<h3 id="npm"><a href="#npm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NPM</h3>\n<p>维护一个 CommonComponents 的 NPM 包，在不同项目中安装、使用。如果 NPM 包升级，对应项目都需要安装新版本，本地编译，打包到 bundle 中。</p>\n<h3 id="umd"><a href="#umd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UMD</h3>\n<p>UMD 优点在 runtime。缺点也明显，体积优化不方便，容易有版本冲突。</p>\n<h3 id="微前端"><a href="#%E5%BE%AE%E5%89%8D%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微前端</h3>\n<p>独立应用间的共享也是问题。一般有两种打包方式：</p>\n<ol>\n<li>子应用独立打包，模块解耦了，但公共的依赖不易维护处理</li>\n<li>整体应用一起打包，能解决公共依赖；但庞大的多个项目又使打包变慢，后续也不好扩展</li>\n</ol>\n<h2 id="全新的解决方案"><a href="#%E5%85%A8%E6%96%B0%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全新的解决方案</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-20-30-bb5fdddb76e6d89b8169a91960ad8cc7-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.51851851851852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABDElEQVQY012R3XKCMBBGef8HqVf2os7ghZ3iSxStN3XUmRZBpkTyQwjSk4TaTsMBwrffJrsh6awrq0txLq+tsv3Q2V4bq00HSnems0F0l/qrOFdlVRNFsb2DxA3Mesvl3HC7ebjD4D2OYxSDx4MfCECijWETNmBiOoP7bbebP86z9fppsXjNc5Tg0XiU9l7w64dk/620kUpdpcR6PJ0eZrN0uUzTtK5rbIQwKG/1sMqUzBRY4OOzKKvqfb/PN/nqeQUvWbbZbg/HA8mNaGJ1PH+TY+s0LKUUQjRCsAFdoQB1trKlHaqLCtD51PPdF08iHtLfMQTDj20IuCn5fozg/4tzYwhEGFH/Z4tlfwMkoMsh9gJaWwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 20 30" title="" data-src="/static/2020-06-23-12-20-30-bb5fdddb76e6d89b8169a91960ad8cc7-fee1c.png" data-srcset="/static/2020-06-23-12-20-30-bb5fdddb76e6d89b8169a91960ad8cc7-a67b7.png 200w,\n/static/2020-06-23-12-20-30-bb5fdddb76e6d89b8169a91960ad8cc7-0b187.png 400w,\n/static/2020-06-23-12-20-30-bb5fdddb76e6d89b8169a91960ad8cc7-fee1c.png 800w,\n/static/2020-06-23-12-20-30-bb5fdddb76e6d89b8169a91960ad8cc7-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从图中可以看到，这个方案是直接将一个应用的 bundle，应用于另一个应用。</p>\n<p>应用可以模块化输出，就是说它本身可以自我消费，也可以动态分发 runtime 子模块给其他应用。</p>\n<p>理论比较抽象，我们动手试一下。</p>\n<h2 id="实践测试"><a href="#%E5%AE%9E%E8%B7%B5%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实践测试</h2>\n<p>现在有两个应用 app1 (localhost:3001)、app2 (localhost:3002)：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-20-56-3e6c5578ff81f97889e7056b431a58b9-0e897.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 578px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 152.59515570934258%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAIAAABoLHqZAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAClUlEQVQ4y5VUzW6bQBj0Y7SxUxtsfnexDSzsglkwGBuDmziHVDm1t54rtanUU++99ZAH7sROlbZSgEqfEFppmNn5ZhhcHr7Ojt/Sjz9uvjw0n34e7x+cu++vq8+Xh/tR0zEDNaz1+MotbtPrD8nVe17dWatrJajVsMGzfQa6qlDTIKbR7CsZi9HFq8nlUHkzwnOmjHV10jID3TBN0zYtOwh4Ve1XiczWxXa3r/b1fLGczjRNN16aga4blmVjPM9fr/MgCDkXq1USxytC6AxgTX9pHsG2TQzD4iIOQz4cjsbjiaKok4nSjnwCQzalJudzSE7TjLEAMJy3I5/BDrUYo1mWF8UGyjthz2DDsKljCUGlzLbbXZatYUGn5uc7U0v3PQ+0URSfyIO+YGKThW34ng9agMEchuF0Ouu89kDTDEopY1oUReDEqvEJvGBtMHx6WnQrM6FuLLmI8ryA20ByzrFqLHw+X3TemS7ljgV8t6tAm6ZpksiiKI7HG7y0XP4JTFkM8JkZeNO0kBNVnXbJ1nTIpm5wtmq5dF3Xw6oMw+w27GlVhDbNoSxLRVHgEzjB3DOeFqiQSlgtZQrD9vsaA7e63T4Vw0SrgMTT99m5Wzjv1SqQCxEDc3ExRKv+S7btOKbgDrKd5zniBRi09G0VKvm7VQUu36ePfzJbUbRI0xw5wbaRjXar/gITYoXho2ysus8P6J+fAWQ7SZLizsAD3Fc2KunoGmNhc3gbRSsoBzmi0g1GJQkhnmtivQg2RkopRHT+k/Xqs89sZHuz2ZTlFtlCmVFJgDtDoqNVfnkTiriua1QKSLiNqN7evoOQzkoS6gvXY6lM5WkcZ47DxWLZ7hxk68A6XIoo3pZbINEtpPVc5vZt/wJsQkhAWdZnAwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 20 56" title="" data-src="/static/2020-06-23-12-20-56-3e6c5578ff81f97889e7056b431a58b9-0e897.png" data-srcset="/static/2020-06-23-12-20-56-3e6c5578ff81f97889e7056b431a58b9-d60f6.png 200w,\n/static/2020-06-23-12-20-56-3e6c5578ff81f97889e7056b431a58b9-6689e.png 400w,\n/static/2020-06-23-12-20-56-3e6c5578ff81f97889e7056b431a58b9-0e897.png 578w" data-sizes="(max-width: 578px) 100vw, 578px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>入口文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29925723021010665000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app1 & app2: index.js\nimport App from \'./App\';\nimport React from \'react\';\nimport ReactDOM from \'react-dom\';\n\nReactDOM.render(<App />, document.getElementById(\'root\'));`, `29925723021010665000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app1 &amp; app2: index.js</span>\n<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">\'./App\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">;</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app2 生产了 Button 组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58978266582183170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app2: Button.js\nimport React from \'react\';\n\nconst Button = () => <button>App 2 Button</button>;\n\nexport default Button;`, `58978266582183170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app2: Button.js</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Button</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>button<span class="token operator">></span>App <span class="token number">2</span> Button<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Button<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app2 自身消费 Button 组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57529619505127470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app2: App.js\nimport LocalButton from \'./Button\';\nimport React from \'react\';\n\nconst App = () => (\n  <div>\n    <h1>Basic Host-Remote</h1>\n    <h2>App 2</h2>\n    <LocalButton />\n  </div>\n);\n\nexport default App;`, `57529619505127470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app2: App.js</span>\n<span class="token keyword">import</span> LocalButton <span class="token keyword">from</span> <span class="token string">\'./Button\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h1<span class="token operator">></span>Basic Host<span class="token operator">-</span>Remote<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h2<span class="token operator">></span>App <span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>\n    <span class="token operator">&lt;</span>LocalButton <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app1 引用 app2 的 Button 组件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6678247581025221000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app1: App.js\nimport React from \'react\';\nconst RemoteButton = React.lazy(() => import(\'app2/Button\'));\n\nconst App = () => (\n  <div>\n    <h1>Basic Host-Remote</h1>\n    <h2>App 1</h2>\n    <React.Suspense fallback=\'Loading Button\'>\n      <RemoteButton />\n    </React.Suspense>\n  </div>\n);\n\nexport default App;`, `6678247581025221000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app1: App.js</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> RemoteButton <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'app2/Button\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h1<span class="token operator">></span>Basic Host<span class="token operator">-</span>Remote<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>\n    <span class="token operator">&lt;</span>h2<span class="token operator">></span>App <span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>\n    <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>Suspense fallback<span class="token operator">=</span><span class="token string">\'Loading Button\'</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>RemoteButton <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>Suspense<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>先看生产了 Button 组件的 app2，其配置文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40610466552070080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app2：webpack.config.js\nconst HtmlWebpackPlugin = require(\'html-webpack-plugin\');\nconst { ModuleFederationPlugin } = require(\'webpack\').container;\nconst path = require(\'path\');\n\nmodule.exports = {\n  entry: \'./src/index\',\n  mode: \'development\',\n  devServer: {\n    contentBase: path.join(__dirname, \'dist\'),\n    port: 3002\n  },\n  output: {\n    publicPath: \'http://localhost:3002/\'\n  },\n  module: {\n    rules: [\n      // ...\n    ]\n  },\n  plugins: [\n    new ModuleFederationPlugin({\n      name: \'app2Lib\',\n      library: { type: \'var\', name: \'app2Lib\' },\n      filename: \'app2-remote-entry.js\',\n      exposes: {\n        Button: \'./src/Button\'\n      },\n      shared: [\'react\', \'react-dom\']\n    }),\n    new HtmlWebpackPlugin({\n      template: \'./index.html\'\n    })\n  ]\n};`, `40610466552070080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app2：webpack.config.js</span>\n<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> ModuleFederationPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./src/index\'</span><span class="token punctuation">,</span>\n  mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    contentBase<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">:</span> <span class="token number">3002</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    publicPath<span class="token punctuation">:</span> <span class="token string">\'http://localhost:3002/\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span><span class="token punctuation">,</span>\n      library<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      filename<span class="token punctuation">:</span> <span class="token string">\'app2-remote-entry.js\'</span><span class="token punctuation">,</span>\n      exposes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        Button<span class="token punctuation">:</span> <span class="token string">\'./src/Button\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      shared<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      template<span class="token punctuation">:</span> <span class="token string">\'./index.html\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段配置描述了，需要暴露出 Button 组件、需要依赖 react、react-dom。管理 exposes 和 shared 的模块为 app2Lib，生成入口文件名为 app-remote-entry.js。</p>\n<p>app1 的配置文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33128833691935957000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\nconst { ModuleFederationPlugin } = require(\'webpack\').container;\nconst path = require(\'path\');\n\nmodule.exports = {\n  entry: \'./src/index\',\n  mode: \'development\',\n  devServer: {\n    contentBase: path.join(__dirname, \'dist\'),\n    port: 3001\n  },\n  output: {\n    publicPath: \'http://localhost:3001/\'\n  },\n  module: {\n    rules: [\n      // ...\n    ]\n  },\n  plugins: [\n    new ModuleFederationPlugin({\n      name: \'app1\',\n      library: { type: \'var\', name: \'app1\' },\n      remotes: {\n        app2: \'app2Lib\'\n      },\n      shared: [\'react\', \'react-dom\']\n    }),\n    new HtmlWebpackPlugin({\n      template: \'./index.html\'\n    })\n  ]\n};`, `33128833691935957000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> ModuleFederationPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  entry<span class="token punctuation">:</span> <span class="token string">\'./src/index\'</span><span class="token punctuation">,</span>\n  mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n  devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    contentBase<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">:</span> <span class="token number">3001</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    publicPath<span class="token punctuation">:</span> <span class="token string">\'http://localhost:3001/\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span><span class="token punctuation">,</span>\n      library<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      remotes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        app2<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      shared<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react\'</span><span class="token punctuation">,</span> <span class="token string">\'react-dom\'</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      template<span class="token punctuation">:</span> <span class="token string">\'./index.html\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段配置描述了，使用远端模块 app2Lib，依赖 react、react-dom。</p>\n<p>最后一步：在 app1 html 中加载 app2-remote-entry.js：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2887682743004060700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<!-- app1: index.html -->\n<html>\n  <head>\n    <script src=&quot;http://localhost:3002/app2-remote-entry.js&quot;></script>\n  </head>\n  <body>\n    <div id=&quot;root&quot;></div>\n  </body>\n</html>`, `2887682743004060700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- app1: index.html --></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:3002/app2-remote-entry.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-24-41-059f46c6c68b482aba75065f363fec26-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA10lEQVQY012O207DMAyG+97TNHoaayuuYBzGHm3aTTuJtlmqnJzziqkACT5bsSPn959kt6sxi3K7Wq2rqqmrJsvLorxP02K9ye7SPMuK78y3dfPw+PTyvH89vB+Pb4ek79qbc/MvMc7zDZFgpAK3EGMMGF9ntM5Za7H3ISR8HIPW+H4RRgmgjdVGY1EA6geDV6Uk7pNScAELyfwXer22p5NgzBhDKZ2miRDS94MQgnMxjCNn7INQCVow/l+Ms+581gD4c6UAzVHWdpdhIN577NFQgfYhYvkE/UwHKN4O80wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 24 41" title="" data-src="/static/2020-06-23-12-24-41-059f46c6c68b482aba75065f363fec26-fee1c.png" data-srcset="/static/2020-06-23-12-24-41-059f46c6c68b482aba75065f363fec26-a67b7.png 200w,\n/static/2020-06-23-12-24-41-059f46c6c68b482aba75065f363fec26-0b187.png 400w,\n/static/2020-06-23-12-24-41-059f46c6c68b482aba75065f363fec26-fee1c.png 800w,\n/static/2020-06-23-12-24-41-059f46c6c68b482aba75065f363fec26-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-24-46-515d435260220c409fa86d76286fc7f1-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.759259259259256%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAlklEQVQI11VPyw7DIAzj/z9zu3QwFUoKCa8ww3aZhYhxEtmY4/kYtcw5dW7oUJ2qylJTyrW23vsYo++CUyG19lXM5WzLGeNYhJTyAjOXIiB4ppSICPwGw013JMIA52y2288V8N5ba0VWN4TgQ7DOHccrRsLueUK4oLNIuMjMf4iIdW9YgJdSEBHxsMMs6y/MyIzkqyvtAwFz6G6OBs0qAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 24 46" title="" data-src="/static/2020-06-23-12-24-46-515d435260220c409fa86d76286fc7f1-fee1c.png" data-srcset="/static/2020-06-23-12-24-46-515d435260220c409fa86d76286fc7f1-a67b7.png 200w,\n/static/2020-06-23-12-24-46-515d435260220c409fa86d76286fc7f1-0b187.png 400w,\n/static/2020-06-23-12-24-46-515d435260220c409fa86d76286fc7f1-fee1c.png 800w,\n/static/2020-06-23-12-24-46-515d435260220c409fa86d76286fc7f1-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="引用的-app2button-是如何找到的呢？"><a href="#%E5%BC%95%E7%94%A8%E7%9A%84-app2button-%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E7%9A%84%E5%91%A2%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>引用的 app2/Button 是如何找到的呢？</h2>\n<p>通过 app1 的配置文件，知道了 app2 是远端加载。在生成的 app1 main.js 描述为：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-25-08-4b95663a0f44ee978755bcc6b533481f-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.64814814814814%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABj0lEQVQoz4VQyZLbIBT0//9XDlOpLE4mninL1gpCRiAWsYlNoexU5uZp3qGroF93c1iWGcCxHm4tQGSZ+bqE6Pdczuc47Glfqez/tKQe3HzzZDYI6hvyWu2fbTgkYySaaQdJC8Zzj6+DgsDim+csaZWDfybOzsZto9V5uVQCjgJCNQKDkVdr3lx27pk4aENHigfCsJB0WQlhN8Yw53TVTGT/VFx6ObN1l/nHl8uvr/Xrt8vx5fTz5Xz63jZvndU2uFDCyTWI1RvjjPGr8lobpcNhf3xLDNN1ej/21bHt3kFXgfqtJsPoGDPaCaEZE1YZJ6UVwmkjpFXKHf5nsMoRJOG4TthwYf0jcCrIMcYU435nZfacY8rl4p+40IXqtpcQiQFwSjjndtt8zulp5ztSTKUepWahUopVCieF8c7HEO6uqTyIIaYQgw9litmHOOes0dz+7nE99KeueW1gBXAzkm5EV4iuA24m3CDcDMsABJyi1h/igs060C0IsTKcK1tab8Ukbq6QguIZvY8Pzwf+Au2LsFmLZO6aAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 25 08" title="" data-src="/static/2020-06-23-12-25-08-4b95663a0f44ee978755bcc6b533481f-fee1c.png" data-srcset="/static/2020-06-23-12-25-08-4b95663a0f44ee978755bcc6b533481f-a67b7.png 200w,\n/static/2020-06-23-12-25-08-4b95663a0f44ee978755bcc6b533481f-0b187.png 400w,\n/static/2020-06-23-12-25-08-4b95663a0f44ee978755bcc6b533481f-fee1c.png 800w,\n/static/2020-06-23-12-25-08-4b95663a0f44ee978755bcc6b533481f-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>看这里的 data 数组：</p>\n<p>data[1] 即 webpack/container/reference/app2，这里是返回 app2Lib 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19290572449085653000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = app2Lib;`, `19290572449085653000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app2Lib<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>data[0] 即 webpack/container/remote-overrides/a46c3e，这里提供了 app2 需要的 react、react-dom 依赖，并返回 app2Lib：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93704590119955530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = (external) => {\n  if (external.override) {\n    external.override(\n      Object.assign(\n        {\n          react: () => {\n            return Promise.resolve().then(() => {\n              return () => __webpack_require__(/*! react */ \'./node_modules/react/index.js\');\n            });\n          },\n          \'react-dom\': () => {\n            return Promise.resolve().then(() => {\n              return () => __webpack_require__(/*! react-dom */ \'./node_modules/react-dom/index.js\');\n            });\n          }\n        },\n        __webpack_require__.O\n      )\n    );\n  }\n  return external;\n};`, `93704590119955530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">external</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>external<span class="token punctuation">.</span>override<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    external<span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span>\n      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          <span class="token function-variable function">react</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! react */</span> <span class="token string">\'./node_modules/react/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token string">\'react-dom\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! react-dom */</span> <span class="token string">\'./node_modules/react-dom/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        __webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> external<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以最后 promise 的赋值变成了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11281378264013674000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var promise = app2Lib.get(\'Button\');`, `11281378264013674000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> promise <span class="token operator">=</span> app2Lib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'Button\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这么一看，app2Lib 是全局变量呀。</p>\n<p>继续看 app1 加载的 app2-remote-entry.js 内容。果然，生成了一个全局变量 app2Lib：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.648148148148145%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABQ0lEQVQY04VR2XLkIAz0//9dkkoyEx9rj8GAQJwGO/Ex0czT7tO2KJVKapVaoiolGw8SOQYI2WHQJoCNhgLtlXbSRQQvKUk0cNLPdj+2+xNVKUVZXrP3brq206Xhl8/hrWYfl+Htc3ilYJBtL5s/ou7Fw3N9o/6Yfci+muckQfac9dM4wuhnA24iFS6hT0ikeYnzkvIyky9rTiWSQKqmEirvXXOrudJGGMmV0tp4YufjOO7/Q+WcE8gCiggCGFNcWolOwvdSqHyS/YuTcH++83xMZvp27V8v/UvHP1r2HhPmHH5+1vN+HOf+5JOOfd+3R+PfkxEN3aCTbcO761i3U99O3RdrBjWAMwymEUiM0PQFic6uaPNlW7djiyVWaFGBSNbrUWkOTgcrwCqcY3bgUBojTTQmo/6OYU1hiaF4uwa/pPALK7jA10rqxbYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 27 39" title="" data-src="/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-fee1c.png" data-srcset="/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-a67b7.png 200w,\n/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-0b187.png 400w,\n/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-fee1c.png 800w,\n/static/2020-06-23-12-27-39-c7848d196ba8beb9e25f74efa9a72359-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>app2Lib 对象拥有两个方法，具体为：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-27-48-3a44c0a2e4c4c3b01b93b59fe8661f32-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 12.037037037037036%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAMUlEQVQI12P4+ePnuxcfXz5/+fLli8+fP//79+8/0YDh169fP77+evvm3ZcvIJ0kAQDxbnXluupwVgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 27 48" title="" data-src="/static/2020-06-23-12-27-48-3a44c0a2e4c4c3b01b93b59fe8661f32-fee1c.png" data-srcset="/static/2020-06-23-12-27-48-3a44c0a2e4c4c3b01b93b59fe8661f32-a67b7.png 200w,\n/static/2020-06-23-12-27-48-3a44c0a2e4c4c3b01b93b59fe8661f32-0b187.png 400w,\n/static/2020-06-23-12-27-48-3a44c0a2e4c4c3b01b93b59fe8661f32-fee1c.png 800w,\n/static/2020-06-23-12-27-48-3a44c0a2e4c4c3b01b93b59fe8661f32-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61615972999285916000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var get = (module) => {\n  return __webpack_require__.o(moduleMap, module)\n    ? moduleMap[module]()\n    : Promise.resolve().then(() => {\n        throw new Error(\'Module &quot;\' + module + \'&quot; does not exist in container.\');\n      });\n};\n\nvar override = (override) => {\n  Object.assign(__webpack_require__.O, override);\n};`, `61615972999285916000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> module<span class="token punctuation">)</span>\n    <span class="token operator">?</span> moduleMap<span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Module "\'</span> <span class="token operator">+</span> module <span class="token operator">+</span> <span class="token string">\'" does not exist in container.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> <span class="token function-variable function">override</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">override</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span><span class="token punctuation">,</span> override<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，app2/Button 实际就是 app2Lib.get(‘Button’)，然后根据映射找到模块，随后 <code class="language-text">__webpack_require__</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21830484918383420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var moduleMap = {\n  Button: () => {\n    return __webpack_require__\n      .e(\'src_Button_js\')\n      .then(() => () => __webpack_require__(/*! ./src/Button */ \'./src/Button.js\'));\n  }\n};`, `21830484918383420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> moduleMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">Button</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> __webpack_require__\n      <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">\'src_Button_js\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! ./src/Button */</span> <span class="token string">\'./src/Button.js\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后再说 shared: [‘react’, ‘react-dom’]：</p>\n<p>app2 中指明了需要依赖 react、react-dom，并期望消费的应用提供。如果 app1 没有提供，或没有提供指定版本，如下把代码注释：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49023820560116830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`plugins: [\n  new ModuleFederationPlugin({\n    name: \'app1\',\n    library: { type: \'var\', name: \'app1\' },\n    remotes: {\n      app2: \'app2Lib\'\n    }\n    // shared: [&quot;react&quot;, &quot;react-dom&quot;],\n    // 版本不一致同理\n    // shared: {\n    //   &quot;react-15&quot;: &quot;react&quot;,\n    //   &quot;react-dom&quot;: &quot;react-dom&quot;,\n    // },\n  }),\n  new HtmlWebpackPlugin({\n    template: \'./index.html\'\n  })\n];`, `49023820560116830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span><span class="token punctuation">,</span>\n    library<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'var\'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">\'app1\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    remotes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      app2<span class="token punctuation">:</span> <span class="token string">\'app2Lib\'</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// shared: ["react", "react-dom"],</span>\n    <span class="token comment">// 版本不一致同理</span>\n    <span class="token comment">// shared: {</span>\n    <span class="token comment">//   "react-15": "react",</span>\n    <span class="token comment">//   "react-dom": "react-dom",</span>\n    <span class="token comment">// },</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    template<span class="token punctuation">:</span> <span class="token string">\'./index.html\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么，刚才 app1 main.js 中的 data[0] 即 webpack/container/remote-overrides/a46c3e 会变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28410839051192414000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = (external) => {\n  if (external.override) {\n    external.override(__webpack_require__.O);\n    // external.override(Object.assign({\n    //   &quot;react&quot;: () => {\n    //     return Promise.resolve().then(() => {\n    //       return () => __webpack_require__(/*! react */ &quot;./node_modules/react/index.js&quot;)\n    //     })\n    //   },\n    //   &quot;react-dom&quot;: () => {\n    //     return Promise.resolve().then(() => {\n    //       return () => __webpack_require__(/*! react-dom */ &quot;./node_modules/react-dom/index.js&quot;)\n    //     })\n    //   }\n    // }, __webpack_require__.O))\n  }\n  return external;\n};`, `28410839051192414000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">external</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>external<span class="token punctuation">.</span>override<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    external<span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token constant">O</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// external.override(Object.assign({</span>\n    <span class="token comment">//   "react": () => {</span>\n    <span class="token comment">//     return Promise.resolve().then(() => {</span>\n    <span class="token comment">//       return () => __webpack_require__(/*! react */ "./node_modules/react/index.js")</span>\n    <span class="token comment">//     })</span>\n    <span class="token comment">//   },</span>\n    <span class="token comment">//   "react-dom": () => {</span>\n    <span class="token comment">//     return Promise.resolve().then(() => {</span>\n    <span class="token comment">//       return () => __webpack_require__(/*! react-dom */ "./node_modules/react-dom/index.js")</span>\n    <span class="token comment">//     })</span>\n    <span class="token comment">//   }</span>\n    <span class="token comment">// }, __webpack_require__.O))</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> external<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>app1 则从 app2 加载 react 依赖：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.907407407407405%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABL0lEQVQY032Qy3aEIAyGff+najdd9XTTRc9csKOOowgBuQgI6DROb3O66H9CyCLfT0hBKW2aZrfbE1JqrY3WjIOUcmDs0lGKF+NbcM4BhBBSKuACBADtC0IIAs45JFNKzlqlDQdVt3176fhNW++NwwMAaGOMHZUqEFuW5fqtMKOCtm6O0YdgrXV+8sFNbvLex5TjPKebQgjFD7auK+ayEQ/P7dMrPL7ww6kaBI4u3is6DGz2PseUYswp5ZzxyXt4yzjzsawHJpX2TVcLw6xyZF8rAd6qFPwS56/W6/UX/lTerGe0wrrta9BDtF5U54lDHMc0ijiKxTuMdUl/4fv/t30DhgXj6yN937fk7XQ+XmjVOSED7ngK/8FNVw2yw2LU/kCAlLTrlZ1wYWvOa4zrB3hGx7iWEIl5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 30 00" title="" data-src="/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-fee1c.png" data-srcset="/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-a67b7.png 200w,\n/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-0b187.png 400w,\n/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-fee1c.png 800w,\n/static/2020-06-23-12-30-00-34869dff6f594dbefff8b138d6b419b9-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2020-06-23-12-30-06-b35dcecf3d490d9cfe47c91dcf4f102b-34bc5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA20lEQVQY011Qa2uEMBD0//+t9sN5BY+DVu5Or+fbVPMgkajJmthNS1voMAzDsrMMG+V5rpSa5xkVABatpVRSyqYjTduPCEo558OIKrgQjDLGuZomqVSktXbO7T8w1sBmAczmNoBgAq0xFiyqWcEsZp0d7tg1+o15H5QQermUfcc/iHg8SFGQe96+31vSs6phWTmUrbgWQ0EmNP/DdcefDll6G9OMx0kdn+pDUj3HWXKuzld2fKMvKT+mLLlN8Sv9C3/jq+q67y5c89Y5rId/UNgZJ7sH7wLRW7N8AiH+Gfn4UHzzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2020 06 23 12 30 06" title="" data-src="/static/2020-06-23-12-30-06-b35dcecf3d490d9cfe47c91dcf4f102b-fee1c.png" data-srcset="/static/2020-06-23-12-30-06-b35dcecf3d490d9cfe47c91dcf4f102b-a67b7.png 200w,\n/static/2020-06-23-12-30-06-b35dcecf3d490d9cfe47c91dcf4f102b-0b187.png 400w,\n/static/2020-06-23-12-30-06-b35dcecf3d490d9cfe47c91dcf4f102b-fee1c.png 800w,\n/static/2020-06-23-12-30-06-b35dcecf3d490d9cfe47c91dcf4f102b-34bc5.png 1080w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>总结，根据 app2 配置的 exposes &#x26; shared 内容，产生对应的模块文件，以及模块映射关系，通过全局变量 app2Lib 进行访问；app1 通过全局变量 get 能知道应该去如何加载 button.js，override 能知道共享依赖的模块。</p>\n<p>以上，Federation 初看很像 DLL + External，但好处是你无需手动维护、打包依赖，代码运行时加载。这种模式下，调试也变得容易，不再需要复制粘贴代码或者 npm link，只需要启动应用即可。这里仅以 Button 组件为例，Button 可以是一个组件，也可以是一个页面、一个应用。Module Federation 的落地，结合自动化流程等系列工作，还需要大家在各自场景中实践。</p>\n<h1 id="其他特性"><a href="#%E5%85%B6%E4%BB%96%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他特性</h1>\n<ul>\n<li>Top Level Await</li>\n<li>SplitChunks 支持更灵活的资源拆分</li>\n<li>不包含 JS 代码的 Chunk 将不再生成 JS 文件</li>\n<li>Output 默认生成 ES6 规范代码，也支持配置为 5 - 11</li>\n</ul>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack5新特性/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2020-06-23 12:03:29",path:"/webpack-v5-new-feature/",tags:"前端, 前端构建工具, webpack",title:"Webpack5新特性",draft:null}},{excerpt:"需求背景 需求背景接上文  记一次组件打包为链接的实践 框架搭建接上文  Webpack 脚手架搭建笔记——记一次新项目搭建 组件轻量化 在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需求背景接上文 <a href="/components-pack-as-library/">记一次组件打包为链接的实践</a></p>\n<p>框架搭建接上文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a></p>\n<h2 id="组件轻量化"><a href="#%E7%BB%84%E4%BB%B6%E8%BD%BB%E9%87%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件轻量化</h2>\n<p>在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k，严重影响首页加载，导致加载此脚本的网站需要很长时间才能响应，所以有了这次的优化任务</p>\n<h2 id="移动端适配"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端适配</h2>\n<p>根据产品要求，此客服组件还需要兼容到移动端，微信端（微信网页、小程序）</p>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<ol>\n<li>组件异步加载，减少首屏加载大小，非首屏且较大的组件预加载，这里需要 nginx 的配合</li>\n<li>去除较大的库，改用轻量级的替代库或者不用</li>\n<li>所有用到的组件最好都由自己编写，有利于定制化功能、减小组件大小</li>\n<li>移动端可以和桌面端项目写在一起分开打包</li>\n<li>代码的分层尤其是 IM 层要分离出来，便于切换不同的 IM 提供商</li>\n<li>小程序端用 webview 加载的网页，需要注意在第三方小程序上配置 nginx</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="组件异步加载"><a href="#%E7%BB%84%E4%BB%B6%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件异步加载</h2>\n<p>需要修改 webpack 配置，由于之前是在 webpack2 上开发，不能很完美的做到异步加载。此时将框架升级到和本文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a> 的同一版本，具体修改如下：</p>\n<ol>\n<li>\n<p>去除 mini-css-extract-plugin，防止 css 单独抽离</p>\n</li>\n<li>\n<p>聚合初始加载脚本到一个文件，异步加载的在其他文件，且对异步加载的做 hash 处理</p>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74887845980558770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entry: {\n bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\noutput: {\n filename: \'[name].js\',\n chunkFilename: \'[name].[chunkhash].chunk.js\',\n},\n\n// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件\n// runtimeChunk: \'single\',\nsplitChunks: false,`, `74887845980558770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\noutput<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件</span>\n<span class="token comment">// runtimeChunk: \'single\',</span>\nsplitChunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>生成构建文件如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 539px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.137291280148425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA7ElEQVQY03WQ2W7DIBBF/SnOZmzMDDuG9rEPVZQ2iqqm//8pvUCk9qGVrq6AmTMLQ3x6OV9vLj4rW1adF05/i355k+Q0jEd1v4gQPQHmsJ/UARJ0EKqJ/tPutA67ie9v0nkrlNduI5vYbdplpSPbRG7D1fhsY4HXkM/KJLhYTYU/L9IHN1MACVXShF6ITDS+IBWyoZiAc0EJZSKiFf56ly7YWTXYpFUHeG9IrQlGQIneHxPhcSE3HuWwn/jjdcHY+ADAkr2qcM3oKyC7lrOp+2lmYFi47Swoz9Joz3XaiA8bWwAZD/2c8f7Aur4Bl0hM5Y3OZe0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 11 25 49" title="" data-src="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png" data-srcset="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-e7723.png 200w,\n/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-61f03.png 400w,\n/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png 539w" data-sizes="(max-width: 539px) 100vw, 539px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-b1a91.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA8klEQVQY033Q227DIAwG4DzLtuYA2GDAxpAmat//pUrSVdsuVumTZS7gNx50vSOV0cbL7C+L/5zwvY8RF0gY9WvGIVHdyy51c0GBdAGeXX5vsnk0qTcDexUqQDJDHm2aTJrst9nmw/+vDDnULTVujbYWWYOoP6GoS6UzyH9jj8zpNHCoShVTgazYSQ1JQ1QX1QBb4AWk/2VBMSeL5ajApl8OoTbeGzVt91RvmjepN77eO1lvm1y17Z5Xii2kFag+eV8A5ViYeHVBXDxYz44EcrFJ7Dk2cDEkCGLOmX820pOJVu/rDGV5wrO619G9ejwY1N8ehLJaU7IJP7EAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 11 26 45" title="" data-src="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-fee1c.png" data-srcset="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-a67b7.png 200w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-0b187.png 400w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-fee1c.png 800w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-b1a91.png 1200w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首页只会引入 bundle.js 文件，且异步组件在其他文件</p>\n<h2 id="较大组件预加载"><a href="#%E8%BE%83%E5%A4%A7%E7%BB%84%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>较大组件预加载</h2>\n<p>这里为了打开聊天组件时不会卡顿，使用了预加载，一定要注意要在主入口加载完成，也就是请求加载完成后在进行预加载，否则同样会造成首页加载时间过长</p>\n<p>这里采取的方案是请求完成后要提前知道加载哪个组件就立即预加载此组件（需要后端配合，不适用于点击后才知道加载哪个组件的情况。当然也可以全部预加载所有较大组件，不过为了省流就没这么做），不用等到点击后加载</p>\n<h2 id="精简依赖库"><a href="#%E7%B2%BE%E7%AE%80%E4%BE%9D%E8%B5%96%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>精简依赖库</h2>\n<h3 id="打包前依赖"><a href="#%E6%89%93%E5%8C%85%E5%89%8D%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包前依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92144449804368770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;antd&quot;: &quot;^3.11.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;^2.2.5&quot;,\n &quot;element-resize-event&quot;: &quot;^2.0.9&quot;,\n &quot;immutable&quot;: &quot;3.8.1&quot;,\n &quot;invariant&quot;: &quot;2.2.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;md5&quot;: &quot;^2.2.1&quot;,\n &quot;moment&quot;: &quot;^2.18.1&quot;,\n &quot;prop-types&quot;: &quot;^15.6.2&quot;,\n &quot;raf&quot;: &quot;^3.4.1&quot;,\n &quot;react&quot;: &quot;16.6.0&quot;,\n &quot;react-dom&quot;: &quot;16.6.0&quot;,\n &quot;react-helmet&quot;: &quot;5.2.0&quot;,\n &quot;react-player&quot;: &quot;^1.6.4&quot;,\n &quot;react-redux&quot;: &quot;5.1.0&quot;,\n &quot;react-router&quot;: &quot;3.2.1&quot;,\n &quot;react-router-redux&quot;: &quot;4.0.6&quot;,\n &quot;react-router-scroll&quot;: &quot;0.4.4&quot;,\n &quot;redux&quot;: &quot;3.6.0&quot;,\n &quot;redux-immutable&quot;: &quot;3.0.8&quot;,\n &quot;redux-saga&quot;: &quot;0.16.2&quot;,\n &quot;reselect&quot;: &quot;2.5.4&quot;,\n &quot;rxjs&quot;: &quot;5.5.3&quot;,\n &quot;smoothscroll-polyfill&quot;: &quot;^0.3.6&quot;,\n &quot;warning&quot;: &quot;3.0.0&quot;,\n &quot;whatwg-fetch&quot;: &quot;2.0.1&quot;\n},`, `92144449804368770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"antd"</span><span class="token punctuation">:</span> <span class="token string">"^3.11.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"element-resize-event"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.9"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"invariant"</span><span class="token punctuation">:</span> <span class="token string">"2.2.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"md5"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"moment"</span><span class="token punctuation">:</span> <span class="token string">"^2.18.1"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"^15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"raf"</span><span class="token punctuation">:</span> <span class="token string">"^3.4.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-dom"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-helmet"</span><span class="token punctuation">:</span> <span class="token string">"5.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-player"</span><span class="token punctuation">:</span> <span class="token string">"^1.6.4"</span><span class="token punctuation">,</span>\n <span class="token string">"react-redux"</span><span class="token punctuation">:</span> <span class="token string">"5.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router"</span><span class="token punctuation">:</span> <span class="token string">"3.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-redux"</span><span class="token punctuation">:</span> <span class="token string">"4.0.6"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-scroll"</span><span class="token punctuation">:</span> <span class="token string">"0.4.4"</span><span class="token punctuation">,</span>\n <span class="token string">"redux"</span><span class="token punctuation">:</span> <span class="token string">"3.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.0.8"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-saga"</span><span class="token punctuation">:</span> <span class="token string">"0.16.2"</span><span class="token punctuation">,</span>\n <span class="token string">"reselect"</span><span class="token punctuation">:</span> <span class="token string">"2.5.4"</span><span class="token punctuation">,</span>\n <span class="token string">"rxjs"</span><span class="token punctuation">:</span> <span class="token string">"5.5.3"</span><span class="token punctuation">,</span>\n <span class="token string">"smoothscroll-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"^0.3.6"</span><span class="token punctuation">,</span>\n <span class="token string">"warning"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"2.0.1"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="打包后依赖"><a href="#%E6%89%93%E5%8C%85%E5%90%8E%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包后依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99478171085443320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;array-tree-filter&quot;: &quot;^2.1.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;2.2.5&quot;,\n &quot;immutable&quot;: &quot;3.8.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;prop-types&quot;: &quot;15.6.2&quot;,\n &quot;rc-dialog&quot;: &quot;^7.5.7&quot;,\n &quot;rc-notification&quot;: &quot;^3.3.1&quot;,\n &quot;rc-select&quot;: &quot;^9.2.0&quot;,\n &quot;rc-tooltip&quot;: &quot;^3.7.3&quot;,\n &quot;rc-upload&quot;: &quot;^2.8.1&quot;,\n &quot;react-lite&quot;: &quot;^0.15.40&quot;,\n &quot;react-loadable&quot;: &quot;5.5.0&quot;,\n &quot;rmc-cascader&quot;: &quot;^5.0.3&quot;,\n &quot;rmc-feedback&quot;: &quot;^2.0.0&quot;,\n &quot;rmc-picker&quot;: &quot;^5.0.10&quot;,\n &quot;whatwg-fetch&quot;: &quot;3.0.0&quot;\n},`, `99478171085443320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"array-tree-filter"</span><span class="token punctuation">:</span> <span class="token string">"^2.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-dialog"</span><span class="token punctuation">:</span> <span class="token string">"^7.5.7"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-notification"</span><span class="token punctuation">:</span> <span class="token string">"^3.3.1"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-select"</span><span class="token punctuation">:</span> <span class="token string">"^9.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-tooltip"</span><span class="token punctuation">:</span> <span class="token string">"^3.7.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-upload"</span><span class="token punctuation">:</span> <span class="token string">"^2.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-lite"</span><span class="token punctuation">:</span> <span class="token string">"^0.15.40"</span><span class="token punctuation">,</span>\n <span class="token string">"react-loadable"</span><span class="token punctuation">:</span> <span class="token string">"5.5.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-cascader"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-feedback"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-picker"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.10"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="主要变化"><a href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主要变化</h3>\n<ol>\n<li>\n<p>去除比较大的依赖库 antd、moment、rxjs</p>\n</li>\n<li>\n<p>替换 react 为 react-lite</p>\n<p>其中需要对 react-lite 做下兼容处理，不影响之前依赖 react 的代码</p>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11610066038793398000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'react\': path.resolve(process.cwd(), \'node_modules/react-lite\'),\n\'react-dom\': path.resolve(process.cwd(), \'node_modules/react-lite\'),`, `11610066038793398000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'react\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token string">\'react-dom\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="组件自编写"><a href="#%E7%BB%84%E4%BB%B6%E8%87%AA%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件自编写</h2>\n<p>此项目的所有组件使用 antd、antd-mobile 的底层组件，以便优化包大小、自定义功能，组件接口尽量保持一致</p>\n<h3 id="antd-引入方式兼容"><a href="#antd-%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F%E5%85%BC%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>antd 引入方式兼容</h3>\n<p>之前的项目用到 antd，这里采用了和 antd 一样的引用方式。</p>\n<p>作用：有利于代码分割，不会将 antd 的组件代码分割到主入口，antd-mobile 同理。</p>\n<p>.babelrc</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1607249375128061400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd&quot;\n],\n[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd-mobile&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd-mobile&quot;\n],`, `1607249375128061400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd-mobile"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd-mobile"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>文件目录如下</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 323px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 169.3498452012384%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAIAAADQyG7qAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC+ElEQVRIx5VV2W7TQBTNbwBq0tSJHdvjbbyNd3sSr4mzlbRViApVEUKIF9545Rf4Yq7TAuIB25Xu6/FZ5tzrgayT/f0nnYTxPF8UK5pW2PKGV7MrFo2nYvsMkGK5cR6XO5NEfpyrhseJOi8ZMDOkt88AqbYdpEm1t9wkTApeMsesxHAKDCtg+FDLDFhBhXn84iw3ETajtGyUJ2mVFmse4dFEaJM9mSlTXqFZlNc1Ui3bi8AzUkxBNhhO6vDMcDInqEhzl7cf3HAe0yJZlDOEL8Zcd2CTmczyimK41duTqjuAlzG5bFX7D5gTVYTJYn1oZLuRpFl9kH/B2Pa3p4+2F6fFyiDBC8AgW8KELvdINb1wDuG/hFlQwfPy5l7RCU1LCPn1aNrH9pm5AXvF/mg6YZKWxE8imkPgnfhnZpCdbm4V3QG85UZBkk55uRvMnAPTILB3j7YLgdXzbAm16bMbfwJz4Kk00zVsXzO9nq/17FnW3Xx3pxku0Ppx5sdpr5V8Ttv0y6e0s4p4yXA8ewGzqpnbqkZa0zBseuC5H5iTppJuC9rPdWg4ARyTRb5qyPsEBk8ymqD310JGsWqEbkhhJUFOL2bo05ARH65ZGsqmO08WhRvMR4wwYvhuMA+vBPEWd5oZeCHV7QAaVtU7CA+UQ09aBsCGZodZnXsxdcKU+HM3SoOk0EnEinr7DLAVaWb87Xt+e6q9uF7vj/nqsCj3q+3RcKigEDgy/5vmAPKSrpjB8nAPmv0ohZIEcSZrNsQBR6pl4J0lTtTOi3ED9QySjHgxbDU09LwYbdOUBE4sXIH67kExHCegry4mb0bTXmk/1VNUrajYADPQKphw/Y7Jb2bL3xwfwDNtzn3d83fVgOFoNGfocNIsD26IbvuXE/Hsqp9sGdvZ5qAaDkQFYDB8yfCdthuwgLCIo83pM6iF3wUEXiy35WoHKtqVD847IK0zFEcWUh1YSeCHzsL7sV2L2YAvGPHH19l1pQa0Xm328H8Ew8MrkN1h+xe7D2/fwFmjrAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 30 51" title="" data-src="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png" data-srcset="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-82faf.png 200w,\n/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png 323w" data-sizes="(max-width: 323px) 100vw, 323px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="桌面移动端分离打包"><a href="#%E6%A1%8C%E9%9D%A2%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面移动端分离打包</h2>\n<p>考虑到桌面移动端的复用逻辑较多，所以将桌面移动端写在一个项目中，这里就涉及到了多平台分离打包</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<p>总体上来说分为 3 个文件夹，分别是公用组件、移动端组件、桌面端组件</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 355px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 147.88732394366195%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAIAAACjcKk8AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACmklEQVQ4y42UWW/bMBCE/S+KJqlt2bpFUhJ1UyKp247TxEkQJ216IEALBEXQvrY/v+s2zzaBfR1pZvZbTmyb0muW3ogsq3WbvNOs2dLRDE9lJiDwaFz0YxAzEmY+zZGfLC2sKMYuibuLO5rxvKx5Mxa8Nd1griJemMiwcSb6YXsfxkUpuneaeTY3pwtrrruHZ+KSlFDG2s1wtWNiaMcrmoqs7JKisVFyeCagDFMuV9erm0+yuxgv7trV9vL28fxyh2mJwuLATJYW2I7bET99ZwVfeX50MtWh8+nCPp4ZijVsPxfV9v46jMukEChIDJsotQ1i2wvSahSrWyhMNKNsV/u2dVdFjCwniluy/VbnrE+ZgKqVIbGwg6Jq6Pkg44xnZW04PuwPRokwCCnXdw6uRDOAZ8sLzzRTBdK9bc0Ixw3+8VO6hIl2zKsGkleyh+8eTr4vzHJ8Kpvxw4MfZLweMrb3j8P0qHPAEzsunsfvteY5ipJSDoB3KXtIftT5ZAGrchDqH6qvf9K0kN0aZCczQ3FVWDNREGQd7xImGW99mkGFRwO/iqcmDnSr1peU1SVvGe/aYeNgetw23PPbGVq31q8nh8S1bAe4aqhKcVVYt4OSFzUP/KikCaNJaThEFRLYSn/1SPPBJfTN6eJ0ZsBVwahkRguA5Bw/v3CARLZjxmomuqJqlCCBk4zqev1xF9Ac2AIZEB7EhRIkroe1ZLvsXuI4qWoAc4CXDGKrQIJcJ5jLijzcsFzIfg2/BbdKhf0jjBjVGN5+CYJEtCt4wDUF5avYsj3S7OTn30VRAZ7Qk+J78J8wBIR1ppnwDtRwFXW3dpAKYSDWUU69rfBIUhVVHWUVPGZQ2PE9A54nc7wZXMAzyoduPIeTVsTzL9kaOuxEzI+RAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 31 53" title="" data-src="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png" data-srcset="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-d1052.png 200w,\n/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png 355w" data-sizes="(max-width: 355px) 100vw, 355px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="优化环境变量配置"><a href="#%E4%BC%98%E5%8C%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化环境变量配置</h3>\n<p>将所有的环境变量整合到一个文件</p>\n<p>boot\\internals\\scripts\\get-build-map.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90252733435274630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconst prodEnv = process.env.PROD_ENV || \'pc\';\nconst globalJSON = require(path.resolve(process.cwd(), \'global.json\'));\n\nconst varsEnv = process.env.SERVER || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\n\nconst RESOLVE_MODULES_MAP = {\n  pc: [\'src/common\', \'src/pc\', \'node_modules\'],\n  mobile: [\'src/common\', \'src/mobile\', \'node_modules\']\n};\n\nconst OUTPUT_PATH_MAP = {\n  pc: \'build/pc\',\n  mobile: \'build/mobile\'\n};\n\nconst resolveModules = RESOLVE_MODULES_MAP[prodEnv];\nconst outputPath = OUTPUT_PATH_MAP[prodEnv];\n\nconst INDEX_ENTRY_MAP = {\n  pc: \'src/pc/index.js\',\n  mobile: \'src/mobile/index.js\'\n};\n\nconst INDEX_HTML_MAP = {\n  pc: \'src/pc/index.html\',\n  mobile: \'src/mobile/index.html\'\n};\n\nconst indexEntry = INDEX_ENTRY_MAP[prodEnv];\nconst indexHtml = INDEX_HTML_MAP[prodEnv];\n\nmodule.exports = {\n  resolveModules,\n  outputPath,\n  indexEntry,\n  indexHtml,\n  globalVars\n};`, `90252733435274630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> prodEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_ENV</span> <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SERVER</span> <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">RESOLVE_MODULES_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/pc\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/mobile\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">OUTPUT_PATH_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'build/pc\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'build/mobile\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resolveModules <span class="token operator">=</span> <span class="token constant">RESOLVE_MODULES_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> outputPath <span class="token operator">=</span> <span class="token constant">OUTPUT_PATH_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_ENTRY_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.js\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_HTML_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.html\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.html\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> indexEntry <span class="token operator">=</span> <span class="token constant">INDEX_ENTRY_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> indexHtml <span class="token operator">=</span> <span class="token constant">INDEX_HTML_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  resolveModules<span class="token punctuation">,</span>\n  outputPath<span class="token punctuation">,</span>\n  indexEntry<span class="token punctuation">,</span>\n  indexHtml<span class="token punctuation">,</span>\n  globalVars\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用环境变量进行分离打包"><a href="#%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用环境变量进行分离打包</h3>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51456578284647330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\noutput: Object.assign({ // Compile into js/build.js\n // 根据环境变量输出到不同平台\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output), // Merge with env dependent settings\n\nresolve: {\n  // 根据环境变量决定相对路径的查找方式\n  modules: buildMap.resolveModules,\n},`, `51456578284647330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\noutput<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// Compile into js/build.js</span>\n <span class="token comment">// 根据环境变量输出到不同平台</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Merge with env dependent settings</span>\n\nresolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据环境变量决定相对路径的查找方式</span>\n  modules<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>resolveModules<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下都是根据环境变量输出到不同平台的文件夹下</p>\n<p>boot\\internals\\webpack\\webpack.dev.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97004135046548340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\n// Add hot reloading in development\nentry: [\n  \'eventsource-polyfill\', // Necessary for hot reloading with IE\n  \'webpack-hot-middleware/client?reload=true\',\n  path.join(process.cwd(), buildMap.indexEntry), // Start with src/index.js\n],\n\nnew HtmlWebpackPlugin({\n   inject: true, // Inject all files that are generated by webpack, e.g. bundle.js\n   template: buildMap.indexHtml,\n}),`, `97004135046548340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Add hot reloading in development</span>\nentry<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n  <span class="token string">\'eventsource-polyfill\'</span><span class="token punctuation">,</span> <span class="token comment">// Necessary for hot reloading with IE</span>\n  <span class="token string">\'webpack-hot-middleware/client?reload=true\'</span><span class="token punctuation">,</span>\n  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Start with src/index.js</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Inject all files that are generated by webpack, e.g. bundle.js</span>\n   template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68689463686834350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\nentry: {\n   bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\nnew HtmlWebpackPlugin({\n  template: buildMap.indexHtml,\n  minify: {\n    removeComments: true,\n    collapseWhitespace: true,\n    removeRedundantAttributes: true,\n    useShortDoctype: true,\n    removeEmptyAttributes: true,\n    removeStyleLinkTypeAttributes: true,\n    keepClosingSlash: true,\n    minifyJS: true,\n    minifyCSS: true,\n    minifyURLs: true,\n  },\n  inject: true,\n}),`, `68689463686834350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nentry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n   bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n  minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeRedundantAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    useShortDoctype<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    keepClosingSlash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyJS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyURLs<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化打包脚本"><a href="#%E4%BC%98%E5%8C%96%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化打包脚本</h3>\n<h4 id="优化编译脚本"><a href="#%E4%BC%98%E5%8C%96%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化编译脚本</h4>\n<p>以下是其中一个脚本，主要是根据参数传递来进行打包</p>\n<p>boot/scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5346075512974857000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst \\$_SERVER = argv.server || \'master\';\nconst \\$_NODE_ENV = argv.env || \'production\';\nconst \\$_PROD_ENV = argv.prod || \'pc\';\n\nshelljs.exec(\n  \\`rimraf ./build/\\${\\$_PROD_ENV}/* && cross-env NODE_ENV=\\${\\$_NODE_ENV} SERVER=\\${\\$_SERVER} PROD_ENV=\\${\\$_PROD_ENV} webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress\\`,\n  { stdio: \'inherit\' }\n);`, `5346075512974857000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_NODE_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>env <span class="token operator">||</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_PROD_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>prod <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>\n  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rimraf ./build/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/* &amp;&amp; cross-env NODE_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_NODE_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> SERVER=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> PROD_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="多平台并行编译"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%B9%B6%E8%A1%8C%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台并行编译</h4>\n<p>采用 concurrently 三方库进行多平台的编译，唯一的缺点就是进度会刷屏，暂时未找到解决方案</p>\n<p>global.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7546439366461288000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;APPS&quot;: {\n &quot;dev&quot;: [\n   &quot;pc&quot;, &quot;mobile&quot;\n ],\n}`, `7546439366461288000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"APPS"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n   <span class="token string">"pc"</span><span class="token punctuation">,</span> <span class="token string">"mobile"</span>\n <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\scripts\\pre-build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30163147600598237000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst path = require(\'path\');\nconst \\$_SERVER = argv.server || \'master\';\nconst APPS = require(path.resolve(process.cwd(), \'global.json\')).APPS[\\$_SERVER];\n\nconsole.log(\\`build environment: \\${\\$_SERVER}\\`, \\`build apps: \\${APPS}\\`);\n\nconst cmd = APPS.map((APP) => \\`&quot;node boot/scripts/build --server=\\${\\$_SERVER} --prod=\\${APP}&quot;\\`);\n\n// 进度输出刷屏，待优化\n// https://github.com/kimmobrunfeldt/concurrently/issues/188\n// https://github.com/kimmobrunfeldt/concurrently/issues/85\nshelljs.exec(\\`concurrently \\${cmd.join(\' \')}\\`, { stdio: \'inherit\' });`, `30163147600598237000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">APPS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">APPS</span><span class="token punctuation">[</span>$_SERVER<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build environment: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build apps: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APPS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token constant">APPS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">APP</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"node boot/scripts/build --server=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --prod=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 进度输出刷屏，待优化</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/188</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/85</span>\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">concurrently </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里调用会并行编译 pc、mobile 两个平台的代码</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25067853761268412000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n &quot;build:dev&quot;: &quot;node boot/scripts/pre-build --server=dev&quot;,\n}`, `25067853761268412000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n <span class="token property">"build:dev"</span><span class="token operator">:</span> <span class="token string">"node boot/scripts/pre-build --server=dev"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>编译速度：2 个平台同时编译的情况下第一次 30~40s，第二次 8~10s</p>\n<h2 id="分离打包的-nginx-配置"><a href="#%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分离打包的 nginx 配置</h2>\n<h3 id="nginx-配置"><a href="#nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置</h3>\n<p>由于之前第三方平台只用引入一个文件，这里的异步加载需要引入不止一个文件，所以要改下 nginx 配置，这里和主产品在一个域名下，故这里用前缀 /im/ 来代表加载客服组件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74942924787574600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set \\$root_dir &quot;/home/frontend/pony/pc/&quot;;\n# 根据 \\$http_user_agent 来判断加载哪个目录下的脚本\nif ( \\$http_user_agent ~ &quot;(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)&quot; )\n{\n   set \\$root_dir &quot;/home/frontend/pony/mobile/&quot;;\n}\n\n# 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码\nlocation = /im/bundle.js {\n   expires -1;\n   add_header Pragma no-cache;\n   alias &quot;\\${root_dir}/bundle.js&quot;;\n}\n\n# 其他文件照常做缓存处理，并映射到 /im 路径\nlocation ^~ /im {\n alias \\$root_dir;\n}`, `74942924787574600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/pc/"</span><span class="token punctuation">;</span>\n<span class="token comment"># 根据 $http_user_agent 来判断加载哪个目录下的脚本</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$http_user_agent</span> ~ <span class="token string">"(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)"</span> <span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n   <span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/mobile/"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码</span>\nlocation <span class="token operator">=</span> /im/bundle.js <span class="token punctuation">{</span>\n   expires -1<span class="token punctuation">;</span>\n   add_header Pragma no-cache<span class="token punctuation">;</span>\n   <span class="token builtin class-name">alias</span> <span class="token string">"<span class="token variable">${root_dir}</span>/bundle.js"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 其他文件照常做缓存处理，并映射到 /im 路径</span>\nlocation ^~ /im <span class="token punctuation">{</span>\n <span class="token builtin class-name">alias</span> <span class="token variable">$root_dir</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="webpack-配合修改"><a href="#webpack-%E9%85%8D%E5%90%88%E4%BF%AE%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 配合修改</h3>\n<p>webpack 也需要做下 public 的映射，否则资源访问不到，注意这里的 <code class="language-text">buildMap.globalVars.customerServiceOrigin</code> 代表主产品的域名</p>\n<p>webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19796225928756093000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: Object.assign({\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output),`, `19796225928756093000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="代码分层"><a href="#%E4%BB%A3%E7%A0%81%E5%88%86%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码分层</h2>\n<p>这里主要对 IM 层、消息提醒功能做了分层。其他的桌面与移动端复用率不高，没有分层</p>\n<h3 id="im-层"><a href="#im-%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IM 层</h3>\n<p>主要把所有与第三方提供商、调用后台的接口整合到一个类中，各种消息的回调采用消息订阅的方式进行分发调用</p>\n<h3 id="消息提醒类"><a href="#%E6%B6%88%E6%81%AF%E6%8F%90%E9%86%92%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息提醒类</h3>\n<p>将公共的消息提醒逻辑抽成一个类</p>\n<p>src\\common\\utils\\TitleMessage\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79172278419646450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import utils from \'utils\';\nimport { filePrefix } from \'containers/App/constants\';\n\nimport tungeeLogo from \'./images/tungee-logo.jpg\';\n\nclass TitleMessage {\n  constructor() {\n    // 闪烁前标题\n    this.originTitle = document.title;\n    // 计数\n    this.count = 0;\n    // 计时器\n    this.timer = null;\n    // 提示音\n    this.alertPlayer = document.createElement(\'audio\');\n    this.alertPlayer.src = \\`\\${filePrefix}message_alert.wav\\`;\n    this.alertPlayer.style.display = \'none\';\n    document.body.appendChild(this.alertPlayer);\n  }\n\n  start(msg) {\n    // 提示音\n    this.alertPlayer.play();\n    // 网页提示\n    utils.showNotification(msg, {\n      icon: tungeeLogo\n    });\n    this.stop();\n    this.timer = setInterval(() => {\n      if (this.count % 2 === 0) {\n        document.title = msg;\n      } else {\n        document.title = this.originTitle;\n      }\n      this.count += 1;\n    }, 1000);\n  }\n\n  stop() {\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = null;\n      this.count = 0;\n    }\n    document.title = this.originTitle;\n  }\n}\n\nexport default TitleMessage;`, `79172278419646450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">\'utils\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> filePrefix <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'containers/App/constants\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> tungeeLogo <span class="token keyword">from</span> <span class="token string">\'./images/tungee-logo.jpg\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">TitleMessage</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 闪烁前标题</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle <span class="token operator">=</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n    <span class="token comment">// 计数</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 计时器</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'audio\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">message_alert.wav</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 网页提示</span>\n    utils<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      icon<span class="token punctuation">:</span> tungeeLogo\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> msg<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> TitleMessage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="小程序部署代理配置"><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小程序部署代理配置</h2>\n<p>小程序用到 webview 限制了接口调用必须是第三方的域名，需要更改第三方域名指向的服务器配置</p>\n<p>这里以 nginx 为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48584089602588934000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location ^~ /im {\n  # 反代到组件所在的域名，并把参数传递过去\n  proxy_pass 组件所在的域名/im/\\$1;\n  # 传递 http_user_agent 参数，否则不能判断移动端\n  proxy_set_header User-Agent \\$http_user_agent;\n}`, `48584089602588934000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location ^~ /im <span class="token punctuation">{</span>\n  <span class="token comment"># 反代到组件所在的域名，并把参数传递过去</span>\n  proxy_pass 组件所在的域名/im/<span class="token variable">$1</span><span class="token punctuation">;</span>\n  <span class="token comment"># 传递 http_user_agent 参数，否则不能判断移动端</span>\n  proxy_set_header User-Agent <span class="token variable">$http_user_agent</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="优化效果"><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化效果</h1>\n<h2 id="优化前"><a href="#%E4%BC%98%E5%8C%96%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化前</h2>\n<p>优化前包大小如下图，首页/全部加载大小都为 644.58kb。</p>\n<p>加载速度（不限速）540ms，3g low（限速 120 kb/s）40.75s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-72d75.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.645833333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB8klEQVQoz02Q23OaYBDF/cf7kIe+Ne1Dm5e00bHqNE2LRo03vGuEIkQLKqLggILcRKMoiCi2X9KpyZkzszs785vdPb6l3HGthbMxds725IO78/bu42I+HDDdDiVPJcu2wNyx7b3rAIPeNE2fvV54B3d/8GaarIi8IgnieNTCUapNPDRRpF7huf6YZ/nRUBaFAd1u1PL3VXjYbxvGzPfnWUfPMwxFngq9bpumycmEk6djXVc1TVktF7IE2C5Dt+rlZDwajEPBRjWla8p/+Hh03d1z9TzvACZb27KstWVtTHOlqxLLkARWzqevs8kIcCHzXTvBQK7r4jhOEATHcYIgOFvLmOnmajmgWy2iht7DpRyUgIKxH1exmy/peFiTxRfYcZweTVMURZIkwzC2vZnPZ8ZMxdHiA1bB0VIlH7u7/ZqAAnHIn05ENGny+mznX+8dns7WVKnzG+v3WuyAAjxSTRdzPzOJyF0smIQCcOqb9vrn1SPIT9HVqSqLI7YLyBHbHzIUhuSbSIH4VcYacDjw4fLibejqPOx/Pz1tBri9tddrkJClKRJSzxbhqMCzDN0uZG4atQxazzbRAoaWMvFQAvJ/PH8j8KOXzTvnSSBzcczVyoly4bZLYul4CE5dl+AogFvNKlLPhf3vLj+dfb44k8TxX9Ge/9+DNMidAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 10 25 53" title="" data-src="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-fee1c.png" data-srcset="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-a67b7.png 200w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-0b187.png 400w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-fee1c.png 800w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-b1a91.png 1200w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-95179.png 1600w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-72d75.png 1920w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-ad506.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.81278538812785%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/klEQVQY06WQy07FMAxE8///w5JfYIMQlwVXLPoiTdqmsfPsg2nCAiR2HFXuWPFIHouUs1FKdt04jm3bNk1zf/+4Pz13r7e+76WUwzDgSSk1z/P6G3GeJ1kL0yilKszTNGk1afwmGKbCZ8EYY61d7Tfi8UG9vawxO2LywccUz784jmPfd9TSnFWIURoL1xZjDBQ9xUwhccwxpW3bcs61gpRSTpmDp+DROOeE80S8Yh9XYOed9/OyMDNSQWPnZVmgsScRLcasREjjmAUxIzOe4Qze1w9zaGvFFbTWiI5pjMFvClhVnP/gMiMV8lyhQ/gpqr5uGGIYdWKHqDV9vcIXe7DLvuDDBk0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 25 47" title="" data-src="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-fee1c.png" data-srcset="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-a67b7.png 200w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-0b187.png 400w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-fee1c.png 800w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-ad506.png 1095w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-74b93.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 31.74366616989568%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA5ElEQVQY01WQ627DIAyF8/5vN2lTtU7aqi3N6CWEAL4CzYyWPzUf1sFY5ohh27ZHa/PF3a/Xafodx/Hz8H4+fjjnLracu91ufvbrc8R19X4Zph8ZT3y/eu9nK1qk2O9M5JyJ6L+biZhpz50uh8NreHtZQiJgBNpJiBkhI4oqixALSxesalpFqm2mQRRYcohpBYpICXlJOXRgiem+BDt2Ymc2T4DfczwHcCENRIJoz2VhLqqGCRsr3RhZc4ZsJhEAESyr6inIMehX4KG21qlNS3miVrOoGQugTdzbWiulPh61f3Ipf9oPVumHRIeSAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 46 52" title="" data-src="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-fee1c.png" data-srcset="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-a67b7.png 200w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-0b187.png 400w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-fee1c.png 800w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-b1a91.png 1200w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-74b93.png 1342w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="优化后"><a href="#%E4%BC%98%E5%8C%96%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化后</h2>\n<h3 id="桌面端"><a href="#%E6%A1%8C%E9%9D%A2%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面端</h3>\n<p>优化后，首页加载 107.08kb，全部加载 356.46kb。</p>\n<p>加载速度（不限速） 246ms，3g low （限速 120 kb/s）7s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a0f42.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.42271293375394%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNklEQVQoz2WP209SARzH+Tt6rZ7aury4HnqqLVdrqd1zri22VsEEq9mgFplT09IWyzZZcXB0IkWkYgQEHRBIhHO4g1yEIFoIR87hcD+icE7EQ7X87rfvvi+f/b5fBkEUarkQ1dyiaJqiG2Tux5pC6ZVKvdI3fhCExQACSFoZAQAPCCJiYBV4LX6R5PDL/KE8I08UyWqhSVGNJt2kabJYTMwvJOfk3+WKCPjWB8y280JqURl4JnQ9nli5x5vguZkD9SvXiwwURTGcqNXIarVGbtbJQmEdMqUNUMvjak1So1uHjD/1hhgo+3rnrm2Q94XVLxMujzzf7OzGGKVSCcMwvK08QZRyORRGMnZHBoYzDjjrQFCnK21acgkeGW+w9NdYEJs1dAs+cqp8+NgGg/4jqrWa3q5UQwaDV6MJ6HR+rTao+xzU60Mqlevh8Lvus+CFyyYO+wEX7jhe2nsw/D+8VangTg+OuHHEk3e2z+VFTVaEL5g70fXxXJ/6Yi+fZTvaU95zwP8XpujfcLVessbfW+NKa0Jpjiug8BwUnLfGFiHPrNYuklueqJCpvpvuXbtD+zq+7YAbZUd+ybihhgkznLU6UDOYnBYlxsSpKWFCMBzhDPjOcF8ae65iJy/B/9Ruw2SjGi36LLlPvpx9Ne0N4R5ZanomOiKJTo55uPddzK6ZQ/1OS2+qEUCcOz5vl6HsB0nyqSmtdqM2N7b8KjY+7r0tWhudjAwyTZ2nxfvZ4ZXzeCPstP8CuQTKZbxKTaYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 14 38 30" title="" data-src="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-fee1c.png" data-srcset="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a67b7.png 200w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-0b187.png 400w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-fee1c.png 800w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-b1a91.png 1200w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-95179.png 1600w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a0f42.png 1902w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-e4a38.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.08736349453978%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAklEQVQY021QW27DIBD0sXuZnqVH6Gf7k0iJmsh2eJhdXgu4dHDUr3aEBhjNLrNMvXcy5jHPy7Lcbl+Xy/X28Tmfz7iu6wpWSllr3X+YUMzk4NoOMBE5B2ZmzwPmQAzxD8LkS2epSWIuOZfS9r1974OPNdD22mquRcANjgodvtb26eWtv75L75FSzlnQ0EWmECgkjnlIIi762SnF2+KN9s75yCGllKc19uuyOauRKxywxo64hK8w9/tda83EG0Qi9VApJqbtpLUhP2YOnvArGBg+FGBqvIfGUKC31qQW6OgLQ61VikQpmnkUIxj/wnv/ZGxOWfPYSNlkzDP/EzhXEUT4AQlZjkeKWe+qAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 36 51" title="" data-src="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-fee1c.png" data-srcset="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-a67b7.png 200w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-0b187.png 400w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-fee1c.png 800w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-b1a91.png 1200w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-e4a38.png 1282w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-166cd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.20728534258456%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABGElEQVQY001Q7W7DIAzMo+4h97PPME390WnqtC6pugSS8GliTAKZqVStJ2TdYRt8bvZ910KMfT8MQ9d117b9fDv+vB9/21ZI2fe9lHKeZ2OMfYJzVk664WajtRjEf5rJnXvv+ZIfVUqFBwDgQUJtRiIIkLdtLyXnXEphwqyKe9y2LT+BFR+uaF5ey+GylZwcJo8EkWMcHPiYQkwsA61QSU05pIVSXlMkSuvWHC776WaCd0uMGKMHUFob5xyAHMdpmrVhW+zCKaXBgzDuS9pMuOJSx7Z6kqJ6Zm/TNHJFdQbQXa/WWUo0K8UrGAZBcbFIH6P/Nnjz1OSyIyL4Cv6PI8t4n8Jqg2EhjME5XBZeEqU6MyGeTTzb9Q9bC42MbmEgJwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 38 36" title="" data-src="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-fee1c.png" data-srcset="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-a67b7.png 200w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-0b187.png 400w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-fee1c.png 800w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-166cd.png 1153w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="移动端"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端</h3>\n<p>优化后，首页加载 105.89kb，全部加载 306.3kb。</p>\n<p>加载速度（不限速）236ms，3g low（限速 120 kb/s）6.98s。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-c3264.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.454688318491364%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACLElEQVQoz2WR3U9SARjG+Wf6A7pok3lTa627WtLUlWuGAw1lwNxcGFg6kSA+jthFBRMRQUSPWcSHIIgnioOCgMCBwznEOJRaCK44TtnoEGZX9Ox99179nj3PXtrJjyRVP6OoBkX9rp9WimlbBn6NhfVoSJeGtUhQm4bfYGGD2ZBXKUrPJYhoFJZJMUD53Wk/pp2dklSToxoXU0wtoZ9keEi955fFfFIcVmNBJR6aNuqz0klifCytkKOAEn8mJub1JVqpdESSJ9VqlSTJWq1WiOvRLVHcOwatDu84hGhgAtl8ErGxP3qx+bmjkWF8bfXQbitxH2GSCZxWLpePz1VpbtMiH9UhvpGY+3HgrSADiRC/KGwbCIK9oAV9KjroZiBiYYE/mGM+yJgXDmiNf6IuDr6tiTrY8XVezMVNePhBsGdz4a7PeHvRkFApCNlUjsNG73Ume3vSs9r9Vji3Mx13shJu7t76YNLDC1gYq0CbFbgOLsVNpqJl8SunP9vZkexipGaAb61wAlJ4TfehZRZk7QuA/T7jHRCga8RXzdrUS3lFMrrf14kybkTplz9PjqOtcBZWb79j7to5kQ8DUccQtNgBqq9IBG3L8PZckHixlhW8irI0+akZzL2O/Rc7pIrZmX9jD513Xum2qtp1U9fkua2Hh7s3CxtdqEf5qxFKJ+p5pBUmkpYM1HzPaMzFj7l44fdMp+6WfbZbmvXTI/ZLG4b2Fa2w2vChX34SxB86lbnYVroPKgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 40 29" title="" data-src="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-fee1c.png" data-srcset="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-a67b7.png 200w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-0b187.png 400w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-fee1c.png 800w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-b1a91.png 1200w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-95179.png 1600w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-c3264.png 1909w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-7169a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.113712374581944%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABC0lEQVQY01VQ2Y7EIAzr/3/haHdfVppuL0oIRzgCdEJH87AWVFWMLTtTSimGcMzzsW3rtj2fz795nh+P9ftn33el1LIs67oCAP6HMThd19Va0wDGmHyjyGXOXMRX/ikEa22MkYtgsOWDt7gWFkHpvTNz7Y2rzFpvLQvTKtcxLJW5DWqwrddahzjmit65SGJKKVoKGCKllFOa4VhQaQsnIZJHT44SuDDYnCexM6GMVlo756SMPrVFlKjSReobDRatOg7QcCqVYlRofkGTD5NE55INnPd7K81FL7ZEJF7nqboE5mwsvq0LsxwJ+GWW6V5C8V5yD4j+8x0TtB58hgO80tE7WaH4jkWmjMG/AM88kKE+GpBtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 43 18" title="" data-src="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-fee1c.png" data-srcset="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-a67b7.png 200w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-0b187.png 400w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-fee1c.png 800w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-7169a.png 1196w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-29961.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.02329450915141%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAklEQVQY002Q227DIAxA8//ftodJ0x47bavWZCVAYoJvQDqTVlOPLLCNrwybkcCN0+zcNE3f5/Pn6ePr7f3ndBqnzjiO3vsQwvoEwOp8HG63277vS4wWAQCpAwlgOzSrPBtuNgUx3/lXHslailaj1faQUhuLsgixZEJWOZy1y/Haau3JWttGlIgTyUYCyIB3s0tmjRljttYMmVImZdpVRHjYW12wTL/XdYmIfaIYQ58fwBYZL5cYgnkM72eLWVJ6uayvjpYNB6tQVIO3vWaLcs5uT9YQ0b7p6pwNaB8QjwLWXlRXUo/yHmhQVbNZuM/xhPntpBUYkp1KpAfWqZVSiwLpHxBlj9DumN8wAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 10 29 15 44 43" title="" data-src="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-fee1c.png" data-srcset="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-a67b7.png 200w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-0b187.png 400w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-fee1c.png 800w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-b1a91.png 1200w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-29961.png 1202w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="优化总结"><a href="#%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化总结</h1>\n<p>待优化的点：组件化复用做的不够好、以原生方式写客服组件体积会更小等等</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/构建多平台轻量化组件的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:12,frontmatter:{date:"2019-10-29 09:51:53",path:"/building-platform-lightweight-components/",tags:"前端, 组件轻量化, webpack, 预研",title:"构建多平台轻量化组件的实践",draft:null}},{excerpt:"接上文  Webpack 升级优化——记一次产品端升级 最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点 babel 编译兼容 IE 在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错 脚本运行颜色 在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上 参数 webpack 加速构建 在 webpack.base.babel.js 文件中添加 hard…",html:'<p>接上文 <a href="/webpack-upgrade-about-product/">Webpack 升级优化——记一次产品端升级</a></p>\n<p>最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点</p>\n<h1 id="babel-编译兼容-ie"><a href="#babel-%E7%BC%96%E8%AF%91%E5%85%BC%E5%AE%B9-ie" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel 编译兼容 IE</h1>\n<p>在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61530584568070050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;env&quot;: {\n    &quot;production&quot;: {\n      &quot;only&quot;: [\n        &quot;src&quot;,\n        &quot;unicorn&quot;\n      ],\n      &quot;plugins&quot;: [\n        &quot;transform-react-remove-prop-types&quot;,\n        &quot;transform-react-constant-elements&quot;,\n        &quot;transform-react-inline-elements&quot;\n      ]\n    },\n  },\n  &quot;plugins&quot;: [\n    [\n      &quot;import&quot;,\n      {\n        &quot;libraryName&quot;: &quot;antd&quot;,\n        &quot;libraryDirectory&quot;: &quot;es&quot;,\n        &quot;style&quot;: true\n      }\n    ],\n    &quot;transform-decorators-legacy&quot;,\n    &quot;lodash&quot;\n  ],\n  &quot;presets&quot;: [\n    [\n      &quot;latest&quot;,\n      {\n        &quot;es2015&quot;: {\n          &quot;modules&quot;: false\n        }\n      }\n    ],\n    &quot;es2015-ie&quot;,\n    &quot;react&quot;,\n    &quot;stage-0&quot;\n  ]\n}`, `61530584568070050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{36}"\n              >\n                <span class="gatsby-code-button-language">js{36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"production"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">"only"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"src"</span><span class="token punctuation">,</span>\n        <span class="token string">"unicorn"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"transform-react-remove-prop-types"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-constant-elements"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-inline-elements"</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"import"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n        <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"es"</span><span class="token punctuation">,</span>\n        <span class="token string">"style"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token string">"transform-decorators-legacy"</span><span class="token punctuation">,</span>\n    <span class="token string">"lodash"</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"latest"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"es2015"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"es2015-ie"</span><span class="token punctuation">,</span></span>    <span class="token string">"react"</span><span class="token punctuation">,</span>\n    <span class="token string">"stage-0"</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="脚本运行颜色"><a href="#%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本运行颜色</h1>\n<p>在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上<code class="language-text">--color</code>参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80922887502103020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\n\nshelljs.exec(\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\', {\n  stdio: \'inherit\'\n});`, `80922887502103020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">shelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-加速构建"><a href="#webpack-%E5%8A%A0%E9%80%9F%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 加速构建</h1>\n<p>在 webpack.base.babel.js 文件中添加 hard-source-webpack-plugin 插件，启用了之后构建速度由第二次的 30~40s 缩短到第二次的 3~5s 左右</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56082118926389590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new HardSourceWebpackPlugin({\n  // Either an absolute path or relative to webpack\'s options.context.\n  cacheDirectory: path.resolve(process.cwd(), \'node_modules/.cache/hard-source/[confighash]\'),\n  // Either a string of object hash function given a webpack config.\n  configHash(webpackConfig) {\n    // node-object-hash on npm can be used to build this.\n    return require(\'node-object-hash\')({ sort: false }).hash({\n      webpackConfig,\n      globalVars,\n    });\n  },\n  // Either false, a string, an object, or a project hashing function.\n  environmentHash: {\n    root: process.cwd(),\n    directories: [],\n    files: [\'package-lock.json\', \'yarn.lock\'],\n  },\n  // An object.\n  info: {\n    // \'none\' or \'test\'.\n    mode: \'none\',\n    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n    level: \'debug\',\n  },\n  // Clean up large, old caches automatically.\n  cachePrune: {\n    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n    // be at least this (default: 2 days) old in milliseconds.\n    maxAge: 2 * 24 * 60 * 60 * 1000,\n    // All caches together must be larger than \\`sizeThreshold\\` before any\n    // caches will be deleted. Together they must be at least this\n    // (default: 50 MB) big in bytes.\n    sizeThreshold: 50 * 1024 * 1024,\n  },\n}),\n\n// 这里会对 svg 生成造成影响，暂时关闭\n// You can optionally exclude items that may not be working with HardSource\n// or items with custom loaders while you are actively developing the\n// loader.\n// new HardSourceWebpackPlugin.ExcludeModulePlugin([\n//   {\n//     // HardSource works with mini-css-extract-plugin but due to how\n//     // mini-css emits assets, assets are not emitted on repeated builds with\n//     // mini-css and hard-source together. Ignoring the mini-css loader\n//     // modules, but not the other css loader modules, excludes the modules\n//     // that mini-css needs rebuilt to output assets every time.\n//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,\n//   },\n// ]),`, `56082118926389590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n  cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/.cache/hard-source/[confighash]\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n  <span class="token function">configHash</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      webpackConfig<span class="token punctuation">,</span>\n      globalVars<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n  environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// An object.</span>\n  info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// \'none\' or \'test\'.</span>\n    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Clean up large, old caches automatically.</span>\n  cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 这里会对 svg 生成造成影响，暂时关闭</span>\n<span class="token comment">// You can optionally exclude items that may not be working with HardSource</span>\n<span class="token comment">// or items with custom loaders while you are actively developing the</span>\n<span class="token comment">// loader.</span>\n<span class="token comment">// new HardSourceWebpackPlugin.ExcludeModulePlugin([</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     // HardSource works with mini-css-extract-plugin but due to how</span>\n<span class="token comment">//     // mini-css emits assets, assets are not emitted on repeated builds with</span>\n<span class="token comment">//     // mini-css and hard-source together. Ignoring the mini-css loader</span>\n<span class="token comment">//     // modules, but not the other css loader modules, excludes the modules</span>\n<span class="token comment">//     // that mini-css needs rebuilt to output assets every time.</span>\n<span class="token comment">//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ]),</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-进度显示异常"><a href="#webpack-%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 进度显示异常</h1>\n<p>在 npm run build 执行时 simple-progress-webpack-plugin 插件会不停的刷屏显示，造成不好的体验，所以暂时只把它写在 webpack.dev.babel.js 中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72902407144940650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new SimpleProgressWebpackPlugin({\n  format: \'minimal\',\n}),`, `72902407144940650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">SimpleProgressWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  format<span class="token punctuation">:</span> <span class="token string">\'minimal\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="lodash-插件优化异常"><a href="#lodash-%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lodash 插件优化异常</h1>\n<p>在开启 lodash-webpack-plugin 插件后，lodash.get 不能正常执行，加入 <code class="language-text">paths: true</code> 即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29387898885975773000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Deep property path support for methods like _.get, _.has, & _.set.\n// lodash优化由592.53k到240k\nnew LodashModuleReplacementPlugin({\n  paths: true,\n}),`, `29387898885975773000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Deep property path support for methods like _.get, _.has, &amp; _.set.</span>\n<span class="token comment">// lodash优化由592.53k到240k</span>\n<span class="token keyword">new</span> <span class="token class-name">LodashModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  paths<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-9-17 20:43:04</code></p>\n<hr>\n<h1 id="react-loadable-优化"><a href="#react-loadable-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-loadable 优化</h1>\n<h2 id="withref-方法报错"><a href="#withref-%E6%96%B9%E6%B3%95%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>withRef 方法报错</h2>\n<p>当 react-loadable 应用到组件为 function 类型，此时 withRef 方法会报错，因为 function 组件是没有 ref 的，此时要做下兼容处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26649598530405007000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        const { isPureReactComponent, isReactComponent } = Component.prototype;\n        let refProps = null;\n        if (isPureReactComponent || isReactComponent) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `26649598530405007000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{21-32}"\n              >\n                <span class="gatsby-code-button-language">js{21-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> isPureReactComponent<span class="token punctuation">,</span> isReactComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPureReactComponent <span class="token operator">||</span> isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          refProps <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span></span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="阻止-setstate"><a href="#%E9%98%BB%E6%AD%A2-setstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻止 setState</h2>\n<p>因为组件卸载时继续网络请求会导致 setState 报错，因为采用的是 promise 方法，不能取消请求，所以需要在卸载时将 setState 置空，以下分别针对页面、组件级别将其置空</p>\n<h3 id="页面级别"><a href="#%E9%A1%B5%E9%9D%A2%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面级别</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47110659124384210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* eslint-disable no-param-reassign */\nimport React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        let refProps = null;\n        // 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空\n        if (Component.prototype && (Component.prototype.isPureReactComponent || Component.prototype.isReactComponent)) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n              if (!r) {\n                return;\n              }\n              const cb = r.componentWillUnmount;\n              r.componentWillUnmount = () => {\n                r.setState = () => {\n                  // eslint-disable-next-line no-useless-return\n                  return;\n                };\n                cb && cb.call(r);\n              };\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `47110659124384210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{29-40}"\n              >\n                <span class="gatsby-code-button-language">js{29-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* eslint-disable no-param-reassign */</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token comment">// 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isPureReactComponent <span class="token operator">||</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          refProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">const</span> cb <span class="token operator">=</span> r<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              r<span class="token punctuation">.</span><span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                r<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  <span class="token comment">// eslint-disable-next-line no-useless-return</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="组件级别"><a href="#%E7%BB%84%E4%BB%B6%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件级别</h3>\n<p>src\\runtime\\preventSetState.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84570257028791500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\n\nexport default function preventSetState(WrappedComponent) {\n  return class Hoc extends React.PureComponent {\n    componentWillUnmount = () => {\n      this.wrappedComponent.setState = () => {\n        // eslint-disable-next-line no-useless-return\n        return;\n      };\n    };\n\n    render() {\n      return (\n        <WrappedComponent\n          ref={(r) => {\n            this.wrappedComponent = r;\n          }}\n          {...this.props}\n        />\n      );\n    }\n  };\n}`, `84570257028791500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Hoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-useless-return</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">WrappedComponent</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent <span class="token operator">=</span> r<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">this</span><span class="token punctuation">.</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49718405273316520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\n@preventSetState\nexport default class Component extends React.PureComponent {}`, `49718405273316520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n@preventSetState\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96360584444005320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\nclass Component extends React.PureComponent {}\n\nexport default preventSetState(Component);`, `96360584444005320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>待拓展的功能：react-hook 替换 mobx、HTML 内实现 Loading 态或者骨架屏、动态 polyfill、编译到 ES2015+（提高运行效率）、LazyLoad、三方库 external 化</p>\n<h1 id="重置报错状态"><a href="#%E9%87%8D%E7%BD%AE%E6%8A%A5%E9%94%99%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置报错状态</h1>\n<p>单个组件报错时不影响其他页面的加载</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35670222240909943000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Component } from \'react\';\nimport PropTypes from \'prop-types\';\n\nimport styles from \'./styles.css\';\n\nclass ErrorBoundary extends Component {\n  state = {\n    hasError: false\n  };\n\n  componentWillReceiveProps() {\n    // 重置未报错状态\n    this.setState({\n      hasError: false\n    });\n  }\n\n  componentDidCatch(error) {\n    this.setState({\n      hasError: true\n    });\n\n    console.error(error);\n    if (window.__bl) {\n      window.__bl.error(error);\n    }\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className={styles.error}>\n          <div className={styles.title}>抱歉，页面出错了！</div>\n        </div>\n      );\n    }\n    return this.props.children;\n  }\n}\n\nErrorBoundary.propTypes = {\n  children: PropTypes.node\n};\n\nexport default ErrorBoundary;`, `35670222240909943000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx{11-16}"\n              >\n                <span class="gatsby-code-button-language">jsx{11-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.css\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    hasError<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 重置未报错状态</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      hasError<span class="token punctuation">:</span> <span class="token boolean">false</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      hasError<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__bl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>__bl<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>error<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>\n<span class="token plain-text">          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">抱歉，页面出错了！</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>\n<span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nErrorBoundary<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorBoundary<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="stylelint-无效"><a href="#stylelint-%E6%97%A0%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stylelint 无效</h1>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98002941238519680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint src/**/*.css&quot;`, `98002941238519680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint src/**/*.css"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当在苹果电脑上运行以上命令时，没有任何效果，即使 css 格式错误也直接通过，同时提交代码前的报错信息也没有颜色，需要做下特殊处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23993770244501488000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint \\&quot;src/**/*.css\\&quot; --color&quot; # src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色\n&quot;lint&quot;: &quot;npm run lint:js && npm run lint:css&quot;,\n&quot;pre-commit&quot;: &quot;lint&quot;,`, `23993770244501488000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint <span class="token entity" title="\\&quot;">\\"</span>src/**/*.css<span class="token entity" title="\\&quot;">\\"</span> --color"</span> <span class="token comment"># src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色</span>\n<span class="token string">"lint"</span><span class="token builtin class-name">:</span> <span class="token string">"npm run lint:js &amp;&amp; npm run lint:css"</span>,\n<span class="token string">"pre-commit"</span><span class="token builtin class-name">:</span> <span class="token string">"lint"</span>,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack脚手架搭建笔记——记一次新项目搭建/index.md absPath of file >>> MarkdownRemark",timeToRead:6,frontmatter:{date:"2019-10-10 21:46:40",path:"/webpack-template-new-project/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack脚手架搭建笔记——记一次新项目搭建",draft:null}},{excerpt:"接上文  Webpack 配置笔记 分包策略 在分支   上启动   脚本，得到分包策略如下： 首屏加载对比 原始首屏加载 升级后加载 分包优化步骤 echarts 只提取需要的包 immutable 指向同一份，避免 draft 与 antd 重复打包 分大模块改写法 根据路由来分 这里原来的路由引用模块已经是   形式的了，所以我在   里的   加了如下策略 经实验，可以看到各个页面只加载所需的包 根据组件来分 对其中比较大的组件进行了懒加载处理，react-player/draft…",html:'<p>接上文 <a href="/webpack-config-note/">Webpack 配置笔记</a></p>\n<h1 id="分包策略"><a href="#%E5%88%86%E5%8C%85%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包策略</h1>\n<p>在分支 <code class="language-text">feature/optimize_webpack</code> 上启动 <code class="language-text">yarn analyze</code> 脚本，得到分包策略如下：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-de767.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.45840605002909%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACbUlEQVQozwFiAp39AO/kz/n28fv8/vr58eqrkuGBXtqBYeKDYeR5T+mZlNyfwN2WsdqV1sp728du1qhr6JBQ5IxU4YBW/25A+wD29vT7/P77/f/5/f/tvKnvkG7rgFnqd07iWCTtm43ptNTehKfWgs7FYt23UsifXOZ/NONxOMhrP+9VJ9oA8/T0+Pj4+Pj4+/397b+v7IZf7HZL6nBE3lkl5JCF46bH24Gl1aTPzavcwqberJThnYjqi3zpaGH5UkvqAN/f3+Hh4eXj4/j+/+6rl+trQuxwSPJwR9pPI9eWg97V1djFwOTW4tC13sW15LWq5p6W7IyH8klK+S802wDj4+Pk5OTo6Of7/P/q2KnkvnLguHPkvHTetmfm0a7q3N/cw77Gvc2lpcmssNuRmtmImOR3i+ZffPNNad4A5eXl5ubm6Ojo9vb49PbJ9vq25+yy5eq/+P3K8vPWz9HDzMu1wczOprnMssbfn7fgmLToh6jsbJn4RXvtAOLi4uPj4+jo6fz8+ff16fb06/Xzy+bkyuXixeTpyKvPoY/AeqrTup3QzKrU3arU6KHO7pLH9Xm0+Vyj/QDi4uLh4eHm5ub4+Pfz99vu89Lp6qrq6p/y8KXb6qmm0qCUwoGw2b604dWX3Nyb3ued3PGP1PeX2f6Mz/4A5eXl5ubm5+fm9PL32/qowPJstupite5bpN4+od92iN6MdNZwnN+wrejSjuXVkujljOjzru373sDA39bYAOTk5Obm5unp6Pz5/9f5or34YLLzSafxMn3CB4HBWG3gcEzFRXDVk2XapYbozIvy43329a/3/em+uuTa2O+lwnzOuk/fAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="分包策略" title="" data-src="/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-fee1c.png" data-srcset="/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-a67b7.png 200w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-0b187.png 400w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-fee1c.png 800w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-b1a91.png 1200w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-95179.png 1600w,\n/static/2019-08-20-14-39-37-7859d5fffe6130839ec4ea995f4afe9a-de767.png 1719w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="首屏加载对比"><a href="#%E9%A6%96%E5%B1%8F%E5%8A%A0%E8%BD%BD%E5%AF%B9%E6%AF%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>首屏加载对比</h1>\n<h2 id="原始首屏加载"><a href="#%E5%8E%9F%E5%A7%8B%E9%A6%96%E5%B1%8F%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原始首屏加载</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-ed146.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.993127147766323%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAkklEQVQI102O2xLDIAhE8/8fmnhBrUREaTvtxvShZxzcGdiF7fAxUKEQYip4++H24CLFlFLOmZnPP1prd8XHtW7o8hpRe6pqE4m9NpWxUB3SdZpdevyYc6Ka2XYn5VwoRoSg8Xm9L9NCRLz3tsAY0rHH5uzSu+oyny0/ig+eiCozDDgEfgDtnLv3QC/ztWDqwI1fXa3kU7K0VbQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="原始首屏加载大小" title="" data-src="/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-fee1c.png" data-srcset="/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-a67b7.png 200w,\n/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-0b187.png 400w,\n/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-fee1c.png 800w,\n/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-b1a91.png 1200w,\n/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-95179.png 1600w,\n/static/2019-08-20-14-42-05-a2bf22d39e0e36b58ed042d4b584c141-ed146.png 1746w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="升级后加载"><a href="#%E5%8D%87%E7%BA%A7%E5%90%8E%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>升级后加载</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-009aa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.851851851851855%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAoklEQVQY03VPyw7DIAzr/38oJVBKeCa0l7mwSrvMQigxsWO2nQ4foiNHPtARzL4TkfPOgw4h5ZT/IDFvORecmFPtrWpXVVHtgHQReVqR67r0xSIBkFsppdYa4wmgBnvfN7Q6LfDkvV961CiwEwatPQNfcYgnOYfpMdFamxEET8YY3BBjcomHDuQa7+YSmWmCmWGxIkjvcLHWov3dPBBK8Cv9AF+YHUoLUXbjAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="升级后加载大小" title="" data-src="/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-fee1c.png" data-srcset="/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-a67b7.png 200w,\n/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-0b187.png 400w,\n/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-fee1c.png 800w,\n/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-b1a91.png 1200w,\n/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-95179.png 1600w,\n/static/2019-08-20-14-42-42-9d4635b500dadc398310cd08fe4408c1-009aa.png 1728w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="分包优化步骤"><a href="#%E5%88%86%E5%8C%85%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包优化步骤</h1>\n<h2 id="echarts-只提取需要的包"><a href="#echarts-%E5%8F%AA%E6%8F%90%E5%8F%96%E9%9C%80%E8%A6%81%E7%9A%84%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>echarts 只提取需要的包</h2>\n<p><code class="language-text">app\\components\\ECharts\\component.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94172769320012550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import echarts from \'echarts/lib/echarts\';\nimport \'echarts/lib/chart/bar\';\nimport \'echarts/lib/chart/line\';\nimport \'echarts/lib/chart/pie\';\n\nimport \'echarts/lib/component/tooltip\';\nimport \'echarts/lib/component/legendScroll\';`, `94172769320012550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> echarts <span class="token keyword">from</span> <span class="token string">\'echarts/lib/echarts\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/chart/bar\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/chart/line\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/chart/pie\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/component/tooltip\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token string">\'echarts/lib/component/legendScroll\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="immutable-指向同一份，避免-draft-与-antd-重复打包"><a href="#immutable-%E6%8C%87%E5%90%91%E5%90%8C%E4%B8%80%E4%BB%BD%EF%BC%8C%E9%81%BF%E5%85%8D-draft-%E4%B8%8E-antd-%E9%87%8D%E5%A4%8D%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>immutable 指向同一份，避免 draft 与 antd 重复打包</h2>\n<p><code class="language-text">internals/webpack/webpack.base.babel.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96706854926905930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'immutable\': path.resolve(process.cwd(), \'node_modules/immutable\'),`, `96706854926905930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'immutable\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/immutable\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="分大模块改写法"><a href="#%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9D%97%E6%94%B9%E5%86%99%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分大模块改写法</h2>\n<h3 id="根据路由来分"><a href="#%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E6%9D%A5%E5%88%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>根据路由来分</h3>\n<p>这里原来的路由引用模块已经是 <code class="language-text">import().then()</code> 形式的了，所以我在 <code class="language-text">webpack</code> 里的 <code class="language-text">splitChunks</code> 加了如下策略</p>\n<p><code class="language-text">internals/webpack/webpack.prod.babel.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36382572251233047000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`splitChunks: {\n  chunks: \'all\', // 不管文件是动态还是非动态载入，统一将文件分离。当页面首次载入会引入所有的包\n  maxInitialRequests: 10, // 最大初始化请求数\n  minSize: 0, // 默认30000，为了不合并 chunk\n  cacheGroups: {\n    vendor: {\n      test: /[\\\\/]node_modules[\\\\/]/,\n      name(module) {\n        const packageName = module.context.match(\n          /[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|\\$)/,\n        )[1];\n        return \\`npm.\\${packageName.replace(\'@\', \'\')}\\`; // 提取各个第三方组件，只在需要时提取\n      },\n    },\n  },\n},`, `36382572251233047000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  chunks<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span> <span class="token comment">// 不管文件是动态还是非动态载入，统一将文件分离。当页面首次载入会引入所有的包</span>\n  maxInitialRequests<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 最大初始化请求数</span>\n  minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 默认30000，为了不合并 chunk</span>\n  cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    vendor<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/]/</span><span class="token punctuation">,</span>\n      <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> packageName <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>\n          <span class="token regex">/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'@\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 提取各个第三方组件，只在需要时提取</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>经实验，可以看到各个页面只加载所需的包</p>\n<h3 id="根据组件来分"><a href="#%E6%A0%B9%E6%8D%AE%E7%BB%84%E4%BB%B6%E6%9D%A5%E5%88%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>根据组件来分</h3>\n<p>对其中比较大的组件进行了懒加载处理，react-player/draft/echarts</p>\n<p>其中有一个比较大的问题就是懒加载组件引用不到 ref 的问题，经多次实验，更改写法如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92845374134225650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        return (\n          <Component\n            ref={(r) => {\n              withRef && withRef(r);\n            }}\n            {...rest}\n          />\n        );\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `92845374134225650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{16-23}"\n              >\n                <span class="gatsby-code-button-language">js{16-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">          <span class="token operator">&lt;</span>Component</span><span class="gatsby-highlight-code-line">            ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span><span class="token punctuation">}</span>\n            <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span>\n          <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用法：</p>\n<p><code class="language-text">app\\components\\GraphHintTextArea\\index.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2496369585909131000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import loadComponent from \'utils/loader\';\n\nexport default loadComponent(() => import(/* webpackChunkName: &quot;c-graph-hint-text-area&quot; */ \'./component\'), null);`, `2496369585909131000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> loadComponent <span class="token keyword">from</span> <span class="token string">\'utils/loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "c-graph-hint-text-area" */</span> <span class="token string">\'./component\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58381277464347140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<GraphHintTextArea\n  withRef={(r) => {\n    this.graphHintTextArea = r;\n  }}\n/>`, `58381277464347140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="jsx"\n              >\n                <span class="gatsby-code-button-language">jsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">GraphHintTextArea</span></span>\n  <span class="token attr-name">withRef</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>graphHintTextArea <span class="token operator">=</span> r<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="antd-只加载需要的-icon"><a href="#antd-%E5%8F%AA%E5%8A%A0%E8%BD%BD%E9%9C%80%E8%A6%81%E7%9A%84-icon" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>antd 只加载需要的 icon</h2>\n<p><code class="language-text">internals/webpack/webpack.base.babel.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42685844188690300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'@ant-design/icons/lib/dist\\$\': path.resolve(\'app/icons\'),`, `42685844188690300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'@ant-design/icons/lib/dist$\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'app/icons\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">app/icons/index.js</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79558764641658650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// fill\nexport { default as ExclamationCircleFill } from \'@ant-design/icons/lib/fill/ExclamationCircleFill\';\n// outline\nexport { default as QuestionCircleOutline } from \'@ant-design/icons/lib/outline/QuestionCircleOutline\';\n// twotone\nexport { default as ProfileTwoTone } from \'@ant-design/icons/lib/twotone/ProfileTwoTone\';`, `79558764641658650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// fill</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> ExclamationCircleFill <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons/lib/fill/ExclamationCircleFill\'</span><span class="token punctuation">;</span>\n<span class="token comment">// outline</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> QuestionCircleOutline <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons/lib/outline/QuestionCircleOutline\'</span><span class="token punctuation">;</span>\n<span class="token comment">// twotone</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> ProfileTwoTone <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons/lib/twotone/ProfileTwoTone\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Webpack升级优化——记一次产品端升级/index.md absPath of file >>> MarkdownRemark",timeToRead:4,frontmatter:{date:"2019-08-20 14:33:00",path:"/webpack-upgrade-about-product/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack升级优化——记一次产品端升级",draft:null}}],length:13,tag:"webpack",pagesSum:3,page:2}}}});