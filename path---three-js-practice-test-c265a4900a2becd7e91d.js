webpackJsonp([0xb943fd16fa68],{1656:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlUlEQVRIx11WaWxU1xWewbQlrdofkSIhGiBpMPZ4Vs/2lpm3zupZPOOZ8Sz2YGzANkaAKaYQUrMkLYgiIlxCQjCYQAwYEoMQNJAIFBxaQgUhoCopYceBJo1pKFVDCbOc0/fesOZKV+fM1Tvf/c56R0VYOZW8lvAxtSybvbExAu1+mndGuaDQ2F4rNHVFhCZJZlMeZ1Qrf9Mt+H+qur/ihFORAFA64J0pVTcXVcDmcKFfruIzZ7rY1H89fAZivjbM1MzFxkAnZqWd9M7KJcTmv7zCN44sY+tflm12C79WLxLCqidWN9cwWpYvsfXL13vasZudgm4mgX4hW6h1teRjnrZCwjOzWO/twIR/FjZ7WnEZ35JvcUSeU4gwSXV7W1sJzEH6R8nSRArlXjr6r7S1DqNUvMAzCXCzSfDxDRAUmyDkaoawtEPi1LxHyGLMkby5gEqUy7atjnq1roosAXqE6Yq7DBXa7RLS6HRG8y4hhbwzDiJbj4IkXUwS5e1h07IOorMePUL6ruiKGmRblg2PesJlq9nxrJMMfydIbhIWP9jMPrBLkrIHgXfG0CdmgKMjwFARFKVvHEQo5xUyKDDRN2T7aE17mV5rfZQYm1lM0EQYWUe0aNTxoKl0Qnk5jVqNA/VaFu3SBS7SB7Ju0ougr2KKWg2DBi17mbCaxyghMzgeMTTp2W7CGkTKHshZqn0Q5Osg6opBhAmAzcADY/NheyQJBi2D8mXVehYMOgEsJg9aTIxSN2YTO+ohQ62G6rGZa5AmAjmj0YvzG5vhVP8f4fTO12FtVxfMjTfC6zPbwOsIQNybhK6GlmLCm5DA6cu2aoeSaaOeVheLxRKgpoJcZ5UAly94MeeiQ+jnQtBCcTBTZ8Ght9fDfy58DDdOHIRj2zdA/4uzYWBpZ6Fr6jR8/lfWP8n2usqA2mQgH7msr3Ks0WgEfGvN6lz/q6tgXqgZjgpZOGSLwsldA4CFG4j3rmP/osU47xkdrm5pLfjdETm+p64cf0fJME34HiVFV+VYajF50UGGc/Nnz4XDfW/ArQ09+M++XsCblwD+fQEL356HswuWwdedS+Dg2p5ilZQwa7VrpCHZ9nOl7Ojg44B0hxxg0hbMjx2rh2iwDk4feReKI58hfn8V8c5lwNyXiF+dRbz4Z1jY1g4TJ1rQbnHfc/ORihJDr5q0kw8AyVqDjpeSEpJLAyaMN6HRwMDuTa/B1fcPwcfbBuHc8SPw+cnDsGvzeim7HOg0DpAYoouPBWUMJxUo65y18X4MtbYJOo3zjgQoxwWen1iNDdPmwPu9+2BvfCXsXbQRehf9Hly0B8aN04OuioGqCipvt/hQ5GLzS4Dh0Tdv3+/nvm0qVVUlfUouboOWK8jxmaznMBXIwpbfroWN63th384tcHTfDpj0gg21lQxoK+m8TQGMb5UxAt6OUYSVkUuGK5MPKiuIHicZwWqDmNNqpE6pIFBjpGDxsqXwuxUroWtBN5w4NgSbNvcDIRW61CUFu9UrtV/si7Fjf/ajUmICSvxKgJMtdQxVK2XOU9RpGNBL3VBeQWIqPR3SjR3QOW8xrFmxCnrWbYJMaobEkr1HE/4zIpv4nrK7NIrbpF+tspoYZdpMLte+wNPRu6S1Bs1GqV/1DOqMPFjIMFbq3dg6cyFkGmagqZqHaoOAHF2XZ6ngWg+XBM4RVoLHOWrLVG4uWpo4FvsvfHz6NktFkbT6QafnQGsUoFLHYm1dFj44cgwYPgQVkymkbP6RWl+LNIRjL/uFhltuNjEoYySCXaNUojOsMPSw4aqwa+o9ga5DggiC1RFDmyMG1bYQVlTSIIhRMJq9RaPZJ4VF+DQZ6MCAmOkLurJ/DYiNt/R67VMKs4hrqjL+o+6mjrj0hjBEOG+1h8FOxcFO1oHVFgazPYQGqdfNthBYpUqwEME78nsT4tP7o96WwWSwA1nKb35iyCZ8M85EXE3oYBO3ab4RKWcSKCaFJJMCQprSpPQcUFwKzWQUKo1+lC9x0r7Fcc+0OVOj8zEkNrY8BAuLDV11ruZvDXrhuJ3NIu+bAYK/FXjfdOA8zegUp6DdmQKNMQD+8HTseW1LYeijE/jB4Q+/Wry8a5L01B6MeaetUcDSjfVjjOVM7da+bTMPvHfkbmrKb5DksjkLncmZqXTe6siAnWmAmkhbYUPvQP7cufO5L69fxyvD/8Ctb+/aI2PU8AmvRGqZAoiIityzb8/T165d3X3t2vD/Pjr+KW7b+R6u2/AOrli9CQfePYQXLg3jpSvDeOLkWTxw6Oh3uwYPrJTMlNHlFcLPeNk6/UOXZ7cuGP1A397fP/7v584vvzJ8o+dvn33+Zm/v9q9X/2EDbN+19+ybm3ds33/ww5f63uovf/D9woVL1A90P5dQqYaGhpQfg4N71BJbteoHqyk7Z+e8zlfuSupPHj+/eO2bso5ZcxQ9Fsiqgny6ZOv3+VTfjIwo+iefnFYN7BxQf3FxuEwGH1c+fgxBuIZnTFuIIh9U2qt3844fb9y0Vf0gXPKm7bzKzYZ+wGTKFFWNz1/6v8OLUiuaFKMJz00yEvaa/RQZnK086s6MutpEqRLx+kcT+rH1f+YikeeNfqnwAAAAAElFTkSuQmCC",aspectRatio:.6666666666666666,src:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png",srcSet:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-8a97b.png 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-0fdf3.png 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png 600w",srcWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp",srcSetWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-5d70e.webp 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-d1677.webp 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="测试一"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试一</h1>\n<p>画 3 个带有反光的立方体</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3btjsn?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二</h1>\n<p>对 3 个带有反光的立方体做响应式处理，要求满足下面条件</p>\n<ol>\n<li>窗口任意大小立方体不会被拉伸</li>\n<li>不能出现明显的锯齿（块状化）</li>\n<li>支持高分屏</li>\n</ol>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nebf1k?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三</h1>\n<p>绘制常见的图元</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/gcewxz?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试四"><a href="#%E6%B5%8B%E8%AF%95%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试四</h1>\n<p>太阳，地球，月球模拟</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/w4pi5h?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试五"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试五</h1>\n<p>实现坦克多视角切换</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/msmdwo?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试六"><a href="#%E6%B5%8B%E8%AF%95%E5%85%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试六</h1>\n<p>实现常见的不同材质</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/cuu62y?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试七"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试七</h1>\n<p>多个纹理加载</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/v163we?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试八"><a href="#%E6%B5%8B%E8%AF%95%E5%85%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试八</h1>\n<p>实现过滤和 mipmaps</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fqi2f6?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试九"><a href="#%E6%B5%8B%E8%AF%95%E4%B9%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试九</h1>\n<p>重复，偏移，旋转，包裹一个纹理</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xtlriw?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十</h1>\n<p>创建环境光</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/17q625?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十一"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十一</h1>\n<p>创建半球光</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x1b9cp?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十二"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十二</h1>\n<p>创建方向光</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/v7e67l?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十三"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十三</h1>\n<p>创建点光源</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1j3e52?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十四"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十四</h1>\n<p>创建聚光灯</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/pc9zx5?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十五"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%BA%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十五</h1>\n<p>创建矩形区域光</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/m38c3f?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十六"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E5%85%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十六</h1>\n<p>模拟实际的光照衰减</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x2elr4?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十七"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B8%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十七</h1>\n<p>实现透视摄像</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/edblhq?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十八"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E5%85%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十八</h1>\n<p>z 冲突实例</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0xmclm?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试十九"><a href="#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B9%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试十九</h1>\n<p>实现正交摄像</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/h7ggwm?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十</h1>\n<p>正交摄像模拟实现 2d canvas</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6ssft6?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十一"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十一</h1>\n<p>假阴影贴图实现</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/o11cmu?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十二"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十二</h1>\n<p>定向光阴影</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zonbfj?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十三"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十三</h1>\n<p>聚光灯阴影</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/qjtuhk?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十四"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十四</h1>\n<p>点光源阴影</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ozl5m4?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十五"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%BA%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十五</h1>\n<ol>\n<li>实现 2 种雾</li>\n<li>是否受雾的影响参数</li>\n</ol>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/uj4rui?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十六"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E5%85%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十六</h1>\n<p>雾的各项参数</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0mztb3?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十七"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B8%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十七</h1>\n<p>实现简单的渲染目标</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vre5qz?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十八"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E5%85%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十八</h1>\n<p>创建一个使用 BufferGeometry 的方块</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/rs3i1j?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试二十九"><a href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B9%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试二十九</h1>\n<p>使用 BufferGeometry 方块的重复顶点数据索引化</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/woj5g0?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十</h1>\n<p>使用类型数组 TypedArrays 动态更新顶点数据的任何一部分</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0mo4ci?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十一"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十一</h1>\n<p>按需渲染（不使用 requestAnimationFrame）</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/b6ekgv?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十二"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十二</h1>\n<p>canvas 截图：</p>\n<ol>\n<li>截图前调用一次渲染代码</li>\n<li>防止 canvas 被清空（即使使用 <code class="language-text">preserveDrawingBuffer: true</code> 切换横竖屏、切换分辨率还是会清空）</li>\n</ol>\n<p>这里使用方案一，方案二不推荐</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zen3n2?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十三"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十三</h1>\n<p>canvas 获取键盘输入</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ft38nj?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十四"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十四</h1>\n<p>透明化 canvas</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7qylxp?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十五"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%BA%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十五</h1>\n<p>大量对象的优化方案：合并几何体</p>\n<p>优化前：</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kz8rg3?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>优化后：</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/8gd7k1?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十六"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E5%85%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十六</h1>\n<p>优化对象的同时保持动画效果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ur1myu?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十七"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B8%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十七</h1>\n<p>离屏渲染画布</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/wdp7bt?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十八"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E5%85%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十八</h1>\n<p>加载 .OBJ 文件</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/blxxwe?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试三十九"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B9%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试三十九</h1>\n<p>加载 .gltf 文件</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/qob9yy?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试四十"><a href="#%E6%B5%8B%E8%AF%95%E5%9B%9B%E5%8D%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试四十</h1>\n<p>透明图片背景，使用 css</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4ci0m3?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>透明图片背景，使用 threejs 渲染，可被后期效果影响</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nnnrpf?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="测试四十一"><a href="#%E6%B5%8B%E8%AF%95%E5%9B%9B%E5%8D%81%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试四十一</h1>\n<p>立方体贴图实现天空盒</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/jyhq0y?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>等距矩形贴图实现天空盒</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/e9dxl1?codemirror=1&amp;hidenavigation=1&amp;module=index.js&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>// TODO threejs 练手测试</p>',
excerpt:"测试一 画 3 个带有反光的立方体 测试二 对…",timeToRead:5,tableOfContents:'<ul>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%80">测试一</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C">测试二</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89">测试三</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%9B%9B">测试四</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%94">测试五</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%85%AD">测试六</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%83">测试七</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%85%AB">测试八</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B9%9D">测试九</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81">测试十</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B8%80">测试十一</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%BA%8C">测试十二</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B8%89">测试十三</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E5%9B%9B">测试十四</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%BA%94">测试十五</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E5%85%AD">测试十六</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B8%83">测试十七</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E5%85%AB">测试十八</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%8D%81%E4%B9%9D">测试十九</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81">测试二十</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B8%80">测试二十一</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%BA%8C">测试二十二</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B8%89">测试二十三</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E5%9B%9B">测试二十四</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%BA%94">测试二十五</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E5%85%AD">测试二十六</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B8%83">测试二十七</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E5%85%AB">测试二十八</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%BA%8C%E5%8D%81%E4%B9%9D">测试二十九</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81">测试三十</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B8%80">测试三十一</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%BA%8C">测试三十二</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B8%89">测试三十三</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E5%9B%9B">测试三十四</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%BA%94">测试三十五</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E5%85%AD">测试三十六</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B8%83">测试三十七</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E5%85%AB">测试三十八</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E4%B8%89%E5%8D%81%E4%B9%9D">测试三十九</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%9B%9B%E5%8D%81">测试四十</a></li>\n<li><a href="/three-js-practice-test/#%E6%B5%8B%E8%AF%95%E5%9B%9B%E5%8D%81%E4%B8%80">测试四十一</a></li>\n</ul>',wordCount:{words:199},frontmatter:{date:"2022-12-19 17:29:39",path:"/three-js-practice-test/",tags:"前端, three.js, WebGL, 练手测试",title:"Three.js练手测试",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验</p>\n<h1 id="核心功能"><a href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心功能</h1>\n<ol>\n<li>cra 配置优化（webpack 配置优化）</li>\n<li>Dockerfile 配置缓存优化</li>\n<li>npm 切换到 pnpm</li>\n<li>npm install 校验命令</li>\n<li>针对线上使用的 <code class="language-text">hard-source-webpack-plugin</code> 硬缓存插件报错的修复过程</li>\n<li>preload-webpack-plugin 失效处理</li>\n<li>分包失效问题</li>\n<li>修复 fastRefresh 在 worker 报错</li>\n</ol>\n<h1 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h1>\n<h2 id="cra-配置优化"><a href="#cra-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra 配置优化</h2>\n<p>核心：thread-loader 加快首次编译速度，hard-source-webpack-plugin 加快二次编译速度</p>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57321086856009250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   addWebpackModuleRule,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst HardSourceWebpackPlugin = require(\'hard-source-webpack-plugin\');\n\nconst packageJson = require(\'./package.json\');\nconst FixHardSourceWebpackPlugin = require(\'./plugins/FixHardSourceWebpackPlugin\');\n// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')\n// const smp = new SpeedMeasurePlugin()\n\n// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭\nconst { DISABLE_HARD_SOURCE_PLUGIN } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\n// 打印 webpack 的相关配置，便于调试\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\n// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.1.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\n// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nconst getHardSourceWebpackPlugins = (env) =>\n   !DISABLE_HARD_SOURCE_PLUGIN\n      ? [\n           addWebpackPlugin(\n              new HardSourceWebpackPlugin({\n                 // Either an absolute path or relative to webpack\'s options.context.\n                 cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}/[confighash]\\`),\n                 // Either a string of object hash function given a webpack config.\n                 configHash: (webpackConfig) => {\n                    // node-object-hash on npm can be used to build this.\n                    // 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存\n                    return require(\'node-object-hash\')({ sort: false }).hash({\n                       webpackConfig,\n                       dependencies: packageJson.dependencies\n                    });\n                 },\n                 // Either false, a string, an object, or a project hashing function.\n                 environmentHash: {\n                    root: process.cwd(),\n                    directories: [],\n                    files: []\n                 },\n                 // An object.\n                 info: {\n                    // \'none\' or \'test\'.\n                    mode: \'none\',\n                    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n                    level: \'debug\'\n                 },\n                 // Clean up large, old caches automatically.\n                 cachePrune: {\n                    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n                    // be at least this (default: 2 days) old in milliseconds.\n                    maxAge: 2 * 24 * 60 * 60 * 1000,\n                    // All caches together must be larger than \\`sizeThreshold\\` before any\n                    // caches will be deleted. Together they must be at least this\n                    // (default: 50 MB) big in bytes.\n                    sizeThreshold: 50 * 1024 * 1024\n                 }\n              })\n           ),\n           env === \'production\' &&\n              // 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明\n              addWebpackPlugin(\n                 new FixHardSourceWebpackPlugin({\n                    cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}\\`)\n                 })\n              )\n        ]\n      : [];\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            javascriptEnabled: true\n            // modifyVars: { \'@primary-color\': \'#1DA570\' }\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         addWebpackModuleRule({\n            // test: /StreamDataWorker\\.js/,\n            test: /(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/,\n            use: { loader: \'worker-loader\', options: { filename: \'worker.[hash].js\' } }\n         }),\n         // TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致\n         // addWebpackModuleRule({\n         //   test: /\\.worker\\.js\\$/,\n         //   use: { loader: \'worker-loader\' }\n         // }),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         // TODO 以下分包策略不是最优解\n         // isProd &&\n         //   setWebpackOptimizationSplitChunks({\n         //     chunks: \'all\',\n         //     maxInitialRequests: 10,\n         //     minSize: 0,\n         //     cacheGroups: {\n         //       vendor: {\n         //         test: module => {\n         //           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大\n         //           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {\n         //             return false\n         //           }\n         //           return /[\\\\/]node_modules[\\\\/]/.test(module.context)\n         //         },\n         //         name: module => {\n         //           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|\\$)/)[1]\n         //           return \\`npm.\\${packageName.replace(\'@\', \'\')}\\`\n         //         }\n         //       }\n         //     }\n         //   }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         // 显示编译进度\n         addWebpackPlugin(new WebpackBarPlugin()),\n         ...getHardSourceWebpackPlugins(env)\n      )(config);\n\n      // 注入 thread-loader\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      // 限制编译范围\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n\n      // 本地开发采用更轻量级的 cheap-module-eval-source-map\n      if (!isProd) {\n         localConfig.devtool = \'cheap-module-eval-source-map\';\n      }\n\n      // if (isProd) {\n      //   localConfig.optimization = {\n      //     ...localConfig.optimization,\n      //     nodeEnv: \'production\',\n      //     sideEffects: true,\n      //     concatenateModules: true,\n      //     runtimeChunk: \'single\'\n      //   }\n      // }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.quiet = false;\n\n      // 显示构建耗时\n      config.stats = {\n         errors: true,\n         children: false,\n         warnings: false,\n         colors: true,\n         assets: false,\n         modules: false,\n         entrypoints: false\n      };\n\n      // 关闭 host 检测，以免非 localhost 域名访问时热更新不生效\n      config.disableHostCheck = true;\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `57321086856009250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   addWebpackModuleRule<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> HardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'hard-source-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> FixHardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/FixHardSourceWebpackPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')</span>\n<span class="token comment">// const smp = new SpeedMeasurePlugin()</span>\n\n<span class="token comment">// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 打印 webpack 的相关配置，便于调试</span>\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数</span>\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.1.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分</span>\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getHardSourceWebpackPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token operator">!</span><span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span>\n      <span class="token operator">?</span> <span class="token punctuation">[</span>\n           <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n              <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                 <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n                 cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/[confighash]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n                 <span class="token function-variable function">configHash</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n                    <span class="token comment">// 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存</span>\n                    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                       webpackConfig<span class="token punctuation">,</span>\n                       dependencies<span class="token punctuation">:</span> packageJson<span class="token punctuation">.</span>dependencies\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n                 environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// An object.</span>\n                 info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// \'none\' or \'test\'.</span>\n                    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n                    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n                    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Clean up large, old caches automatically.</span>\n                 cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n                    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n                    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n                    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n                    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n                    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n                    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>\n                 <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n           <span class="token punctuation">)</span><span class="token punctuation">,</span>\n           env <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">&amp;&amp;</span>\n              <span class="token comment">// 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明</span>\n              <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n                 <span class="token keyword">new</span> <span class="token class-name">FixHardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">)</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token comment">// modifyVars: { \'@primary-color\': \'#1DA570\' }</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackModuleRule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// test: /StreamDataWorker\\.js/,</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">{</span> loader<span class="token punctuation">:</span> <span class="token string">\'worker-loader\'</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token string">\'worker.[hash].js\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致</span>\n         <span class="token comment">// addWebpackModuleRule({</span>\n         <span class="token comment">//   test: /\\.worker\\.js$/,</span>\n         <span class="token comment">//   use: { loader: \'worker-loader\' }</span>\n         <span class="token comment">// }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 以下分包策略不是最优解</span>\n         <span class="token comment">// isProd &amp;&amp;</span>\n         <span class="token comment">//   setWebpackOptimizationSplitChunks({</span>\n         <span class="token comment">//     chunks: \'all\',</span>\n         <span class="token comment">//     maxInitialRequests: 10,</span>\n         <span class="token comment">//     minSize: 0,</span>\n         <span class="token comment">//     cacheGroups: {</span>\n         <span class="token comment">//       vendor: {</span>\n         <span class="token comment">//         test: module => {</span>\n         <span class="token comment">//           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大</span>\n         <span class="token comment">//           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {</span>\n         <span class="token comment">//             return false</span>\n         <span class="token comment">//           }</span>\n         <span class="token comment">//           return /[\\\\/]node_modules[\\\\/]/.test(module.context)</span>\n         <span class="token comment">//         },</span>\n         <span class="token comment">//         name: module => {</span>\n         <span class="token comment">//           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/)[1]</span>\n         <span class="token comment">//           return `npm.${packageName.replace(\'@\', \'\')}`</span>\n         <span class="token comment">//         }</span>\n         <span class="token comment">//       }</span>\n         <span class="token comment">//     }</span>\n         <span class="token comment">//   }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 显示编译进度</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token operator">...</span><span class="token function">getHardSourceWebpackPlugins</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 注入 thread-loader</span>\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 限制编译范围</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>mainFields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'jsnext:main\'</span><span class="token punctuation">,</span> <span class="token string">\'main\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 本地开发采用更轻量级的 cheap-module-eval-source-map</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>devtool <span class="token operator">=</span> <span class="token string">\'cheap-module-eval-source-map\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// if (isProd) {</span>\n      <span class="token comment">//   localConfig.optimization = {</span>\n      <span class="token comment">//     ...localConfig.optimization,</span>\n      <span class="token comment">//     nodeEnv: \'production\',</span>\n      <span class="token comment">//     sideEffects: true,</span>\n      <span class="token comment">//     concatenateModules: true,</span>\n      <span class="token comment">//     runtimeChunk: \'single\'</span>\n      <span class="token comment">//   }</span>\n      <span class="token comment">// }</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>quiet <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 显示构建耗时</span>\n      config<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n         errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 关闭 host 检测，以免非 localhost 域名访问时热更新不生效</span>\n      config<span class="token punctuation">.</span>disableHostCheck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="dockerfile-配置缓存优化"><a href="#dockerfile-%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 配置缓存优化</h2>\n<h3 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>为了充分利用缓存，采用 docker 的缓存策略</p>\n<h3 id="背景知识"><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景知识</h3>\n<p><a href="/docker-introduce-learning/">Docker 入门学习</a></p>\n<h3 id="第一版"><a href="#%E7%AC%AC%E4%B8%80%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一版</h3>\n<p>这里的主要问题在于一旦改了源码需要编译的时候，缓存失效了</p>\n<p>原因是标红行部分复制了文件，再进行构建的时候，因为已经是新的文件了，所以这里 build 的时候不能使用缓存</p>\n<p>Dockerfile-client</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39533108671408490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:14-alpine as builder\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry https://registry.npmmirror.com\n\nWORKDIR /home/\n\n# 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install\nCOPY package.json package-lock.json ./\n# 安装依赖\nRUN npm i\n\n# 复制剩余文件\nCOPY . .\n\nRUN ls && npm run build && ls\n\nFROM nginx:alpine\nCOPY --from=builder /home/build /usr/share/nginx/html/\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `39533108671408490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{14}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install</span>\n<span class="token keyword">COPY</span> package.json package<span class="token punctuation">-</span>lock.json ./\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> npm i\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">COPY</span> . .</span>\n<span class="token keyword">RUN</span> ls &amp;&amp; npm run build &amp;&amp; ls\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /home/build /usr/share/nginx/html/\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="第二版"><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二版</h3>\n<p>由于第一版的问题，所以需要想办法在 build 过程中也要尽可能的使用缓存</p>\n<p>这里由于缓存容易损坏（由上面提到的 hard-source-webpack-plugin 造成），需要给缓存一个版本的概念，同时也要控制是否使用缓存</p>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10962799526694433000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖同时读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\n# build 并读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\n# 以下是二阶段\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `10962799526694433000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="token keyword">RUN</span> pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖同时读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token comment"># build 并读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token comment"># 以下是二阶段</span>\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最终采用第二版，同时为了减少构建上下文，需要添加如下的文件</p>\n<p>.dockerignore</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89279140041288520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`*\n# 静态文件\n!public\n# 为了兼容老版本的 jenkins 不报错，实际上不该加\n!build\n\n# 源码\n!src\n\n# 构建相关\n!.env.production\n!config-overrides.js\n!plugins\n!scripts\n\n# 依赖库\n!package.json\n!pnpm-lock.yaml\n\n# nginx\n!nginx.conf`, `89279140041288520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">*\n<span class="token comment"># 静态文件</span>\n!public\n<span class="token comment"># 为了兼容老版本的 jenkins 不报错，实际上不该加</span>\n!build\n\n<span class="token comment"># 源码</span>\n!src\n\n<span class="token comment"># 构建相关</span>\n!.env.production\n!config<span class="token punctuation">-</span>overrides.js\n!plugins\n!scripts\n\n<span class="token comment"># 依赖库</span>\n!package.json\n!pnpm<span class="token punctuation">-</span>lock.yaml\n\n<span class="token comment"># nginx</span>\n!nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="调用"><a href="#%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用</h3>\n<ol>\n<li><code class="language-text">BUILDKIT_CACHE_MOUNT_NS</code> 就类似于缓存版本的概念</li>\n<li>可以传入 <code class="language-text">--no-cache</code> 来控制不使用缓存，默认使用（这里的 docker 18 版本的 <code class="language-text">--no-cache</code> 不对 <code class="language-text">type=cache</code> 生效，20 版本的反而生效）</li>\n<li>以上 2 个参数可以配合 jenkins 来控制</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55434265549242974000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;build&quot;: &quot;node scripts/build.js&quot;,\n      &quot;docker:build&quot;: &quot;DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit .&quot;,\n      &quot;docker:run&quot;: &quot;docker run -it -p 3000:3000 --rm frontend&quot;,\n      &quot;docker:start&quot;: &quot;npm run docker:build && npm run docker:run&quot;\n   }\n}`, `55434265549242974000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node scripts/build.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:build"</span><span class="token operator">:</span> <span class="token string">"DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit ."</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:run"</span><span class="token operator">:</span> <span class="token string">"docker run -it -p 3000:3000 --rm frontend"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:start"</span><span class="token operator">:</span> <span class="token string">"npm run docker:build &amp;&amp; npm run docker:run"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="npm-切换到-pnpm"><a href="#npm-%E5%88%87%E6%8D%A2%E5%88%B0-pnpm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 切换到 pnpm</h2>\n<h3 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>在公司的 jenkins 平台上打包时发现 npm install 的过程特别慢，主要是老项目的依赖库太多，故考虑转向安装速度更快的 pnpm</p>\n<h3 id="实现方式"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h3>\n<ol>\n<li>因为老项目里面已有 package-lock.json，所以通过 <code class="language-text">pnpm import</code> 可以实现一键迁移，当然有些三方库使用错误导致白屏，这些库需要特殊处理</li>\n<li>配合上面的 dockerfile 可实现深度缓存</li>\n<li>由于上面提到的是否使用缓存一部分是由 package.json 里面的 dependencies 决定，所以需要规范 dependencies 的用法</li>\n</ol>\n<h2 id="npm-install-校验命令"><a href="#npm-install-%E6%A0%A1%E9%AA%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm install 校验命令</h2>\n<h3 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>为了统一库的安装工具，防止团队成员使用别的库安装工具</p>\n<h3 id="实现方式-1"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h3>\n<ol>\n<li>通过 volta 限制只能使用 pnpm（截止 2022-11-21 11:21:42 <a href="https://github.com/volta-cli/volta/issues/737" target="_blank" rel="nofollow noreferrer noopener">不支持 pnpm</a>）</li>\n<li>手动写 hook 脚本</li>\n</ol>\n<p>最终 2 种方式都采用</p>\n<h3 id="volta"><a href="#volta" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volta</h3>\n<p>安装过程见 <a href="/frontend-devlopment-environment-setting/#volta">volta</a></p>\n<p>同时在 package.json 加如下几行，这样切入项目目录就会自动切换构建工具</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94748206243024730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;volta&quot;: {\n      &quot;node&quot;: &quot;14.20.0&quot;,\n      &quot;pnpm&quot;: &quot;7.14.1&quot;\n   }\n}`, `94748206243024730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"volta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"14.20.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm"</span><span class="token operator">:</span> <span class="token string">"7.14.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="hook-脚本"><a href="#hook-%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook 脚本</h3>\n<p>scripts/node-check-version.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49592602055115400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { exec } = require(\'child_process\');\nexec(\'node -v\', (err, stdout) => {\n   if (err) throw err;\n   if (parseInt(stdout.slice(1)) !== 14) {\n      // NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.\n      throw new Error(\\`[ERROR] You need node version @=14 but you have \\${stdout}\\`);\n   }\n});`, `49592602055115400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'node -v\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stdout<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need node version @=14 but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/only-allow.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58346998077064135000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const pmFromUserAgent = (userAgent) => {\n   const pmSpec = userAgent.split(\' \')[0];\n   const separatorPos = pmSpec.lastIndexOf(\'/\');\n   return {\n      name: pmSpec.substr(0, separatorPos),\n      version: pmSpec.substr(separatorPos + 1)\n   };\n};\n\nif (!process.env.npm_config_user_agent) {\n   throw new Error(\'[ERROR] Please check your npm!\');\n}\n\nconst [name, version] = process.argv.slice(2);\n\nconst pm = pmFromUserAgent(process.env.npm_config_user_agent);\n\nif (name !== pm.name) {\n   const errors = [\\`[ERROR] You need \\${name}\\`];\n\n   const urlMap = {\n      pnpm: \'https://pnpm.js.org/\',\n      yarn: \'https://yarnpkg.com/\'\n   };\n\n   if (urlMap[name]) {\n      errors.push(\\`Please go to \\${urlMap[name]}\\`);\n   }\n\n   throw new Error(errors.join(\', \'));\n}\n\nif (parseFloat(pm.version) < version) {\n   throw new Error(\\`[ERROR] You need \\${name} version @>=\\${version} but you have \\${pm.version}\\`);\n}`, `58346998077064135000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">pmFromUserAgent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">userAgent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> pmSpec <span class="token operator">=</span> userAgent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> separatorPos <span class="token operator">=</span> pmSpec<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> separatorPos<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      version<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>separatorPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'[ERROR] Please check your npm!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> version<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> pm <span class="token operator">=</span> <span class="token function">pmFromUserAgent</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> pm<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> urlMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n      pnpm<span class="token punctuation">:</span> <span class="token string">\'https://pnpm.js.org/\'</span><span class="token punctuation">,</span>\n      yarn<span class="token punctuation">:</span> <span class="token string">\'https://yarnpkg.com/\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Please go to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\', \'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> version @>=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pm<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62464908302060150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;preinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;node-check-version&quot;: &quot;node scripts/node-check-version.js&quot;,\n      &quot;only-allow&quot;: &quot;node scripts/only-allow.js pnpm 7&quot;,\n      &quot;pnpm:devPreinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;verify-version&quot;: &quot;npm run node-check-version && npm run only-allow&quot;\n   }\n}`, `62464908302060150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"preinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"node-check-version"</span><span class="token operator">:</span> <span class="token string">"node scripts/node-check-version.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"only-allow"</span><span class="token operator">:</span> <span class="token string">"node scripts/only-allow.js pnpm 7"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm:devPreinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"verify-version"</span><span class="token operator">:</span> <span class="token string">"npm run node-check-version &amp;&amp; npm run only-allow"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里要注意，由于 pnpm 下的 preinstall 是 install 后才执行的，所以增加了 <code class="language-text">pnpm:devPreinstall</code>，同时生产环境通过添加 <code class="language-text">--ignore-scripts=true</code> 参数不运行此钩子</p>\n<p>以上就可以限制只能通过 pnpm 来进行 install（以上脚本还限制了版本）</p>\n<h2 id="hard-source-webpack-plugin-的线上修复"><a href="#hard-source-webpack-plugin-%E7%9A%84%E7%BA%BF%E4%B8%8A%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hard-source-webpack-plugin 的线上修复</h2>\n<h3 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>在使用了 hard-source-webpack-plugin 作缓存加速时，有以下比较明显的问题</p>\n<ol>\n<li>二次编译有时不能正常停止</li>\n<li>二次编译会出现各种编译报错，清空缓存后重新编译却正常</li>\n</ol>\n<h3 id="实现方式-2"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h3>\n<p>针对以上问题，有以下解决方式</p>\n<ol>\n<li>二次编译时识别到 done 即编译完成，此时调用 <code class="language-text">process.exit(0)</code> 手动结束</li>\n<li>二次编译时一旦编译报错则认为是缓存损坏，此时清空缓存，重启 build 命令</li>\n</ol>\n<p>scripts/const.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35822715872093823000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const CACHE_ERROR_CODE = 10;\n\nmodule.exports = {\n   CACHE_ERROR_CODE\n};`, `35822715872093823000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token constant">CACHE_ERROR_CODE</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85876269900141770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nconst { CACHE_ERROR_CODE } = require(\'./const\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'react-app-rewired\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      // 接受到缓存损坏信号，重启命令\n      if (code === CACHE_ERROR_CODE) {\n         spawn(mainModule);\n         // 除了正常停止的 0 外，其他错误码均认为异常\n      } else if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--max-old-space-size=4096\', \'build\']);`, `85876269900141770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'react-app-rewired\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 接受到缓存损坏信号，重启命令</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">spawn</span><span class="token punctuation">(</span>mainModule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 除了正常停止的 0 外，其他错误码均认为异常</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--max-old-space-size=4096\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>plugins/FixHardSourceWebpackPlugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52799058017011900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const rimraf = require(\'rimraf\');\nconst { get } = require(\'lodash\');\nconst { CACHE_ERROR_CODE } = require(\'../scripts/const\');\n\nclass FixHardSourceWebpackPlugin {\n   constructor(options) {\n      this.options = options || {};\n      // 是否读取了上次的缓存\n      this.cacheRead = false;\n   }\n\n   apply(compiler) {\n      compiler.hooks.hardSourceLog.tap(\'hardSourceLog\', (message) => {\n         // eslint-disable-next-line no-useless-call\n         // console[message.level].call(console, message)\n\n         const id = get(message, \'data.id\');\n\n         if (id === \'confighash--reused\') {\n            this.cacheRead = true;\n         }\n      });\n\n      const handleClearCache = () => {\n         // 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令\n         // 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令\n         const { cacheDirectory } = this.options;\n         console.log(\'[FixHardSourceWebpackPlugin] Clearing Cache\', cacheDirectory);\n         rimraf.sync(cacheDirectory);\n         console.log(\'[FixHardSourceWebpackPlugin] Cache Cleared\');\n         if (this.cacheRead) {\n            console.log(\'[FixHardSourceWebpackPlugin] Restarting...\');\n            process.exit(CACHE_ERROR_CODE);\n         }\n      };\n\n      // 找不到具体的模块时会调用，比如随便导入一个不存在的模块\n      // import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）\n      compiler.hooks.failed.tap(\'FixHardSourceWebpack Cache Error\', () => {\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Failed\');\n         handleClearCache();\n      });\n\n      // 导出一个不存在的模块并使用时会调用\n      // import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）\n      compiler.hooks.done.tap(\'FixHardSourceWebpack Cache Error\', (stats) => {\n         const hasErrors = stats.hasErrors();\n         if (!hasErrors) {\n            return;\n         }\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Done\');\n         handleClearCache();\n      });\n\n      compiler.hooks.done.tap(\'FixHardSourceWebpackPlugin Force Stop\', (stats) => {\n         if (!this.cacheRead) {\n            return;\n         }\n\n         // 编译完成强制结束\n         // HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因\n         setTimeout(() => {\n            console.log(\'[FixHardSourceWebpackPlugin] Force Stop\');\n            process.exit(0);\n         });\n      });\n   }\n}\n\nmodule.exports = FixHardSourceWebpackPlugin;`, `52799058017011900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> rimraf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'rimraf\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">FixHardSourceWebpackPlugin</span> <span class="token punctuation">{</span>\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否读取了上次的缓存</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>hardSourceLog<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'hardSourceLog\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// eslint-disable-next-line no-useless-call</span>\n         <span class="token comment">// console[message.level].call(console, message)</span>\n\n         <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">\'data.id\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">\'confighash--reused\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">handleClearCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令</span>\n         <span class="token comment">// 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDirectory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Clearing Cache\'</span><span class="token punctuation">,</span> cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Cache Cleared\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Restarting...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 找不到具体的模块时会调用，比如随便导入一个不存在的模块</span>\n      <span class="token comment">// import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>failed<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Failed\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 导出一个不存在的模块并使用时会调用</span>\n      <span class="token comment">// import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> hasErrors <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasErrors<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Done\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpackPlugin Force Stop\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// 编译完成强制结束</span>\n         <span class="token comment">// HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因</span>\n         <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Force Stop\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> FixHardSourceWebpackPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="后续问题"><a href="#%E5%90%8E%E7%BB%AD%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续问题</h3>\n<p>在代码变动之后，如果通过缓存生成，查看编译后的代码还是之前的老代码，需要暂时关闭缓存待以后解决</p>\n<h2 id="preload-webpack-plugin-失效处理"><a href="#preload-webpack-plugin-%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>preload-webpack-plugin 失效处理</h2>\n<h3 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>此插件在 pnpm 下不生效，在 npm 下反而生效</p>\n<h3 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h3>\n<p>require 指向的 html-webpack-plugin 不是同一个，导致 hook 不能被调用，具体见 <a href="https://github.com/jantimon/html-webpack-plugin/issues/1091#issuecomment-434708455" target="_blank" rel="nofollow noreferrer noopener">issue</a></p>\n<h3 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h3>\n<p>升级到 3.0.0-beta.4 即可，对比可知源码做了以上处理</p>\n<p>3.0.0-beta.3 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97282859010846260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n   hook = HtmlWebpackPlugin.getHooks(compilation).beforeEmit;\n}`, `97282859010846260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>3.0.0-beta.4 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52694130877948170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const [HtmlWebpackPlugin] = compiler.options.plugins.filter(\n      (plugin) => plugin.constructor.name === \'HtmlWebpackPlugin\'\n   );\n   assert(HtmlWebpackPlugin, \'Unable to find an instance of \' + \'HtmlWebpackPlugin in the current compilation.\');\n   hook = HtmlWebpackPlugin.constructor.getHooks(compilation).beforeEmit;\n}`, `52694130877948170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>HtmlWebpackPlugin<span class="token punctuation">]</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n      <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'HtmlWebpackPlugin\'</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">assert</span><span class="token punctuation">(</span>HtmlWebpackPlugin<span class="token punctuation">,</span> <span class="token string">\'Unable to find an instance of \'</span> <span class="token operator">+</span> <span class="token string">\'HtmlWebpackPlugin in the current compilation.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="分包失效问题"><a href="#%E5%88%86%E5%8C%85%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包失效问题</h2>\n<h3 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>发现分包结果和原来的不一致，比原来大很多，比如看下面的三方库</p>\n<p>原来的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.109375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACzElEQVQozyWS3U/TYBjF+9fpFcEbidyYkHihRi4wYQZkJopOiLoZxAuixjgBIcBwDANMPgZzMka3dd3Wteu6dt9rN9rStesnq+8kOTl5b05+53meF2rz7TIRrjWqgiRdyp2OIvcM/VpXmgbU0zTbttuRUGnGWV1w456X9W+fClMOdOIxxPIXxXoTeNc0ZENTDV1XFE2WdUXWgcsKcMu2iz9Xo7dv4I4H2OQoPfs8eutm4s4gRDfbZJ1jOyona62u0ZZ1QVR4QRZFRRT6EgS5Y9jMr03k3hA17Ug7xxq+FXp1kV72QpVGJZsnUtkMXiA5gQdkQ1X1rnLNt0BzVe3ZNrfrz43eLbyawB33xd2tWjhUOdiDeJHNEjkYSWbwXDKDFhma51i2Vm2Uy1y9ZqndnmH0Z0aR4rKX8W9UAv7GD+/v4UH44Qh00a7ieRzNZnIE0eBYSZKuDMPS+3wTrMo0LQuMbGcZYWmPDEQqgaRIhs9pj4tZmIOENotl0vD5eSqZJAmiWqmUaJoiSapQkESxZ1m60Q9vR+qjc1nPWml2tYzGClzkqHh8CKlCmSKwDILkMQyNxxmKUjuS1pEMcDNd72mqrvVrb582nO6zue/E2y0+thaMPhpBpsYhvlnEM2g6kcihKN9sSjwvtDgTjKpplqqCbZmGCcJp+mIjiO3+YfaxS+rwGH06RrpdEM82MTQVPzsDWBLDSBwvUQVd7lyHLU29svpkisf9+fW9UuCQDZYYWIxFm7G/kCQIoDACw9lUCkujaDJBkyQg26ZxLfNKB+Gj1sFYevQ1/uJdzRMNf8WmnbBrEpBLmRRydnqKJOLJOExTxVq5fMnzWv/O4HspiqpYVi/UDD3LTs0T772tlZOtuZ2hgdXhAcgfRtb2Y0s7kZXgKZAvFPefJH1H8MZ/gcd6CN48SX0Ibo/755/4Ps7sry0sLn558eazy/0P0amGPG/S4poAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 51 16" title="" data-src="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png" data-srcset="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a67b7.png 200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-0b187.png 400w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png 800w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-b1a91.png 1200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>新的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.9375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAC/klEQVQ4y02SW4+bVhDH+ez5AH1oVGkbrZRKURsp6UMeojbVpvJmk+zaqzX3A4eDuWPAcLituRiMoYOdh0o/Hc+5zMx//oYpn6uALAtf7o+ncRimcQTG0+n/nIYBgNu+7/ZV1QbbVsetbTBFvrdW73z+43a7y2nynOdFlrZVNZ1fj8fjD6B23499P01T8fiwe/+2+HbLFEkSRzQMdnkSd01zqCqga+pT2w59d2zqY9sMh3Y4HGbgcBzpzd/+1c/xh3cMjXeOsQlcp2vaoeuPhw7ogfbQd31X11Bxji807XE4pYub4LdX8fvfGdeLdMP3gyxJ63BXxrRKs4ZeKA4J3dO0umzhPKZ1UXXZ7U30+tf04ZZ5LosoCJM4oQmID9umuRg2OzednRtO02kERmCAaKp0rV4tvYwwZRYRrEiiJAoCwdh1nK3vA67r+J7ruS7EnufpOnFs27Es23HqwJuI+d3/xHT73CRYU1SiKERVkSBgRQFknscISTyvyjLwuFwiUZQ4FhOS3H3Orq8X5E/mUHiegU19Y+m6Z9uB60bbLRA4TggSbDv03NDzbMOAK9+yYkqTxT/JLy/vzY9MHnmKwCGBlzhOV9Ut5HgepPlQaF4tyAGgNFxB8jYI6ZfPyasr2bpj2n1pEg0EAzqG6aVLDCJBPBTVkAz6n1YrVZIQTIG14u7f9M31XpaYag/mwQNZQUjDWFUUnRAAAk3TYCXwo2F2vcZQEcmw2RlWpHt0dc+UaWRuCLwALMNIkyTPsiLLMkrzecnSLAfCaEdpGidpllJWyz7JvbP4yjRlBm7PVivKRpv1G4QA85YQpGqqpqtYX7MCnMhINU3jw13w4o1tIpupy4IgBBMqMCTIOv9DWJYlnoNZWE7kRQR8u18KggQlVKwuHsOf3loE+3OycW4IVkNn7dwfOmsI6RqREYa2wNOaRyqRkLrZ6It1cvUX3Sx5pioLTZkbwveAJElkWfgkQIXIcZIorqGzIHOC9PX7A8/y6zUHnt6y8R9fMvdJ+A+6oH9QRieClwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 52 53" title="" data-src="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png" data-srcset="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a67b7.png 200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-0b187.png 400w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png 800w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-b1a91.png 1200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="原因-1"><a href="#%E5%8E%9F%E5%9B%A0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h3>\n<p>经分析 treeShaking 失效，说明 main 没有识别到 es6 的语法</p>\n<h3 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h3>\n<p>需要注释掉 mainFields 这一行，默认 cra 已做了 es6 语法的处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9288246074601570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];`, `9288246074601570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="修复-fastrefresh-在-worker-报错"><a href="#%E4%BF%AE%E5%A4%8D-fastrefresh-%E5%9C%A8-worker-%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 fastRefresh 在 worker 报错</h2>\n<h3 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>如果一个文件导出函数时被前端代码和 worker 同时使用时报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.986754966887418%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY0yWNyXKEIBQA/f/fSg6zqUQYXHgEcMFlxBGUaGUuMUlVV9+6OrCrX8xkWNmgvA2pjNLwQuIL+TghGmVpAvhGgUBXaj/OfrKLmVczu8d0ENhlneZF905gzqOUJsAwpAmjcabKBy5qlCoKTSF0IdvDVfeUjRntPrrvv9h5Y7eBQndFFcnziBBEUYjjECdJxnjFpGZC87IDqZt+1oPtzDJMa+CO2PrBeJ2L4hxnMaWn+H4j17fz7f1KUIrvgCi/F4qyimSCq6HsnqIZK21+z7Pzzm1TP+aF4KA4V/BZ5iBB1VzWqmrduttlP3zgt9f69fr3D+qQCTlnM4VyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 58 09" title="" data-src="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" data-srcset="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-765e7.png 200w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-c9f48.png 400w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="原因-2"><a href="#%E5%8E%9F%E5%9B%A0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h3>\n<p>在 development 模式下，如果一个文件里面的 function 同时被 worker 和前端文件使用（即被前端的 <code class="language-text">babel-loader/react-refresh</code> 处理过，此时就有了 fastRefresh 的插件代码），而 fastRefresh 里面没有针对 worker 运行环境的处理，此时会报错</p>\n<h3 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h3>\n<p>需要对 <code class="language-text">$RefreshReg$</code> 做兼容处理，即确保只在开发环境的 worker 添加以下代码（注意这里的代码必须写成单独的文件并使用 import 放在 worker 的第一行，否则会因为执行时机的问题不起作用）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90580086227698860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`global.\\$RefreshReg\\$ = () => {};\nglobal.\\$RefreshSig\\$ = () => {};`, `90580086227698860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">global<span class="token punctuation">.</span><span class="token function-variable function">$RefreshReg$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nglobal<span class="token punctuation">.</span><span class="token function-variable function">$RefreshSig$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ol>\n<li>不对 worker 文件做 babel 处理（此方案改动较大，不现实）</li>\n<li>\n<p>在 worker-loader 前插入新的 loader，此 loader 插入以上代码，注意只在 development 环境插入一行代码</p>\n<ol>\n<li>找现成的插入代码的 loader</li>\n<li>自己写 loader</li>\n</ol>\n</li>\n</ol>\n<h2 id="懒编译"><a href="#%E6%87%92%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒编译</h2>\n<h3 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>目前老项目在开发模式下全量编译过慢，而有时只需要开发少数几个页面</p>\n<h3 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>因老项目使用的是 webpack4，历史代码太多不好升级，所以需要通过模仿 webpack5 的懒编译实现，有以下几个选型</p>\n<ol>\n<li><a href="https://github.com/bahmutov/web-packing" target="_blank" rel="nofollow noreferrer noopener">web-packing</a> 实现了网络请求来打包对应组件，实现思路类似懒编译，但和理想中的相差较远</li>\n<li><a href="https://github.com/sysgears/webpack-virtual-modules" target="_blank" rel="nofollow noreferrer noopener">webpack-virtual-modules</a> 实现了在内存中动态创建文件，但需要重新开始写懒编译效果</li>\n<li><a href="https://github.com/lisiyizu/vue-dynamic-module-example" target="_blank" rel="nofollow noreferrer noopener">vue-dynamic-module-example</a> 实现了在 vue 中懒编译文件，但只能在命令行中指定要编译哪些模块，不能从网络请求来决定编译哪些模块</li>\n<li><a href="https://github.com/liximomo/lazy-compile-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-compile-webpack-plugin</a> 基本实现了根据请求来编译对应页面的效果，但请求一个页面会触发多次编译，且二次请求这个页面还会触发编译</li>\n<li><a href="https://github.com/devtreehouse/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a> 修复以上问题，但在老项目里面运行会出现循环依赖的报错</li>\n<li><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">towavephone/lazy-build-webpack-plugin</a> 修复循环依赖问题</li>\n</ol>\n<h3 id="具体实现"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实现</h3>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89497633905297820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const LazyBuildWebpackPlugin = require(\'@towavephone/lazy-build-webpack-plugin\');\n\nconst { LAZY_BUILD } = process.env;\n\n// 默认不开启懒编译\nLAZY_BUILD &&\n   addWebpackPlugin(\n      // 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下\n      // https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15\n      new LazyBuildWebpackPlugin({\n         ignores: [/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/]\n      })\n   );`, `89497633905297820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> LazyBuildWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@towavephone/lazy-build-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\n<span class="token comment">// 默认不开启懒编译</span>\n<span class="token constant">LAZY_BUILD</span> <span class="token operator">&amp;&amp;</span>\n   <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n      <span class="token comment">// 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下</span>\n      <span class="token comment">// https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15</span>\n      <span class="token keyword">new</span> <span class="token class-name">LazyBuildWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ignores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52875309746702740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主入口需要加这几行代码，否则懒编译完成后页面不刷新\nif (module.hot) {\n   module.hot.accept();\n}`, `52875309746702740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主入口需要加这几行代码，否则懒编译完成后页面不刷新</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="编译效果"><a href="#%E7%BC%96%E8%AF%91%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译效果</h3>\n<ol>\n<li>懒编译开启前，即全量编译．时长在 3 分钟左右</li>\n<li>懒编译开启后，即单页面编译，随机挑选一个页面，时长在 20 秒左右</li>\n</ol>\n<h3 id="源码解析"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h3>\n<p>// TODO 懒编译插件源码解析</p>\n<h1 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h1>\n<h2 id="生产环境"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h2>\n<p>只算前端编译过程，原来的正在用的前端编译时间 9 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-602dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.15426781519186%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABlUlEQVQoz01RC8+cIBD0//+0Jl++tPf0TgVUFHycb/T0dLpim5aELLO7LDODUzcN4kTCjCP29VlXLOvnX9z+x8f5Pc9YPkdtz8/LYvG6bXDwZ/0tNm2LMIowThParkPf9+BCoKNzW70wUGSc25oxhvYIxjh0lmGjOU7TDyirClmeoyhLJDrFk/tIiwxZVSAi/NgxbeZ5kIEHEQskuUZKW5UZ/JAhVokl5cjiBS5T1E1tpYS9wr3jYFOKcKXmUcI1Efz8QfmQoocH1fc8X5Ttu/cCbEiwkkKnHSfokqSYwUqXU24bxKIRbQX4mxiaGPzl4dmH4CXFIQSjvPhoiFnDJcxNenhY9QYiUSS3wPR+g7USp2q/TKymBG4rCPt46hsxExTvuNBwl87+JOENMc61B6+J7B84r45MlwmUVvZD3JzhS13oko9by/GLpP6QJ5zDn7jQ4Gt8xre64lQ+qc5wrQJ86StuRXAwrIcRgjxs2gaEEZsMt91DkrR7FOwsycMgc+HSI0y7lqk/JiQ5A5/V0b97SAN+AyGCWTyEvk29AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 27 36" title="" data-src="/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-fee1c.png" data-srcset="/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-a67b7.png 200w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-0b187.png 400w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-fee1c.png 800w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-b1a91.png 1200w,\n/static/2022-12-16-19-27-36-54ebaff2e200d2d16c0523415ce70c5c-602dc.png 1277w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>优化缓存过后，分 2 种情况，初次编译完全无缓存的情况下编译时间 8 分钟，第二次有缓存的情况下 3 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0f56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABUUlEQVQoz22R6W6DQAyEef/Hq6oCCTfhhnAEWEiAr2bTSv1RS6MZjb22VzbariUIQ7I8Zzt29uNg5+CM/XirQ+tf781nbD/5v57BPzGpmTTPWNaV4THQC9bnKkMzZqU4l2iaWrwnVV2hloVu6CmrEuPs/ZJJwzTSivmYJ5q25cu0uLcdwzhK05FatGlftJdXNUGc8JhmbkkqA3ryosSXnxpz01BFMYXrUAe+ICDxL3jXTyLfJokdUoHvWjiXT26BTSh5+2rpvGN/ELimrjlhPGR609zJ0oRlUezbRjSmmIOHO8WEr1zDm29Y/ds7tafebA0+zhgRrJkgxaiHkfze0/Ud6+spB4F4LrDGUB6lRHulcerLHOMKn/qX7SnCnRPCrdQwntuLtu8pykIf4ZCLxargawzwlpTwkMK9xBVtTaFmRza7qpvOm1LnqIRgK/DlJ99HFBFOtd8jtQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 28 35" title="" data-src="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-fee1c.png" data-srcset="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-a67b7.png 200w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0b187.png 400w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-fee1c.png 800w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0f56a.png 1050w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="开发环境"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境</h2>\n<p>看自己电脑配置来定，目前本人电脑上前端初次编译 5 分钟，二次编译 2 分钟（不过不建议开启缓存插件，会影响热更新速度且时间长会报错，可通过上面提到的 <code class="language-text">DISABLE_HARD_SOURCE_PLUGIN</code> 关闭）</p>\n<h1 id="后期优化"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h1>\n<p>后期优化偏向页面加载性能方面，有以下几点可以考虑：</p>\n<ol>\n<li>页面分包优化</li>\n<li>worker.js loader 优化</li>\n<li>不必要的三方库优化</li>\n</ol>',
excerpt:"需求背景 由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验 核心功能 cra 配置优化（webpack 配置优化） Dockerfile 配置缓存优化 npm 切换到 pnpm…",frontmatter:{date:"2022-12-16 17:34:33",path:"/cra-project-build-speed-optimize/",tags:"前端, webpack, Docker, 预研",title:"CRA 项目构建速度优化",draft:null}},prePost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>接上文 <a href="/cra-project-build-speed-optimize/">CRA 项目构建速度优化</a></p>\n<p>由下图可以看出此项目的 <code class="language-text">Clone Repo</code>，<code class="language-text">Scp to build_node</code> 耗时较长，需要优化</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0f56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABUUlEQVQoz22R6W6DQAyEef/Hq6oCCTfhhnAEWEiAr2bTSv1RS6MZjb22VzbariUIQ7I8Zzt29uNg5+CM/XirQ+tf781nbD/5v57BPzGpmTTPWNaV4THQC9bnKkMzZqU4l2iaWrwnVV2hloVu6CmrEuPs/ZJJwzTSivmYJ5q25cu0uLcdwzhK05FatGlftJdXNUGc8JhmbkkqA3ryosSXnxpz01BFMYXrUAe+ICDxL3jXTyLfJokdUoHvWjiXT26BTSh5+2rpvGN/ELimrjlhPGR609zJ0oRlUezbRjSmmIOHO8WEr1zDm29Y/ds7tafebA0+zhgRrJkgxaiHkfze0/Ud6+spB4F4LrDGUB6lRHulcerLHOMKn/qX7SnCnRPCrdQwntuLtu8pykIf4ZCLxargawzwlpTwkMK9xBVtTaFmRza7qpvOm1LnqIRgK/DlJ99HFBFOtd8jtQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 28 35" title="" data-src="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-fee1c.png" data-srcset="/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-a67b7.png 200w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0b187.png 400w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-fee1c.png 800w,\n/static/2022-12-16-19-28-35-93d0552bd01b11529dfeb32d5a3c8d4b-0f56a.png 1050w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h1>\n<p>目前是全量更新，需要改成增量更新</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<h2 id="原始版本"><a href="#%E5%8E%9F%E5%A7%8B%E7%89%88%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原始版本</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3024079982061467000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n        stage(\'Clean workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n          agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n            bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                pwd\n                rsync -Lrav --relative \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n             sh &quot;&quot;&quot;\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                # docker info\n                docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                pwd\n                ls\n                rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Set tag\') {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n             dir(&quot;\\${repo_name1}_\\${branch_name}&quot;){\n                sh &quot;&quot;&quot;\n                echo \'escape git tag\'\n                    #git tag -m &quot;Build docker image \\${image_version} for \\${branch_name}/\\${image_version}&quot; \\${branch_name}/\\${image_version}\n                    #git describe\n                    #git push origin \\${branch_name}/\\${image_version}\n                rm -fr \\${work_dir}\n                &quot;&quot;&quot;\n             }\n         }\n      }\n\n    }\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `3024079982061467000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy"\n              >\n                <span class="gatsby-code-button-language">groovy</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\nwork_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Clean workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n                rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n          agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n            bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n                pwd\n                rsync -Lrav --relative <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/\n                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             sh <span class="token string gstring">"""\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                # docker info\n                docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                pwd\n                ls\n                rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Set tag\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             <span class="token function">dir</span><span class="token punctuation">(</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name1<span class="token punctuation">}</span></span>_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n                sh <span class="token string gstring">"""\n                echo \'escape git tag\'\n                    #git tag -m "Build docker image <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> for <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>" <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                    #git describe\n                    #git push origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                """</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本一"><a href="#%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本一</h2>\n<ol>\n<li>固定使用一个目录为缓存目录，拉取代码和构建代码都在这个缓存目录上</li>\n<li>利用 git 和 rsync 的增量更新</li>\n<li>不使用缓存时删除固定目录的缓存</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50048847053370204000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage(\'Clean workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n            if [ \\${is_cache_project} = \'false\' ]\n            then\n               rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            fi\n            &quot;&quot;&quot;\n        }\n      }\n      stage(&quot;Clone Repo&quot;){\n          agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            if [ \\${is_cache_project} = \'false\' ]\n            then\n               rm -rf \\${work_dir} || true\n            fi\n            if [ ! -d \\${work_dir} ]\n            then\n               cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n               bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n               cd \\${work_dir}\n               # 1、为了让脚本检测，2、master 拉取最新\n               git checkout master\n               git pull origin master\n\n               if [ \\${branch_name} != \'master\' ]\n               then\n                  git checkout \\${branch_name}\n                  # 强制拉取远程代码到本地\n                  git pull --force origin \\${branch_name}:\\${branch_name}\n               fi\n               cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                # pwd\n                rsync -Lazv -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n             sh &quot;&quot;&quot;\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                  echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                  exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n                # rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            &quot;&quot;&quot;\n        }\n      }\n   }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `50048847053370204000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{12,34,74-77,89-112,128-129,134,159-161}"\n              >\n                <span class="gatsby-code-button-language">groovy{12,34,74-77,89-112,128-129,134,159-161}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\n<span class="gatsby-highlight-code-line">is_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span></span>\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\n<span class="gatsby-highlight-code-line">work_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称"</span></span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Clean workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">            if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'false\' ]</span><span class="gatsby-highlight-code-line">            then</span><span class="gatsby-highlight-code-line">               rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span><span class="gatsby-highlight-code-line">            fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n          agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">            # ls -la</span><span class="gatsby-highlight-code-line">            if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'false\' ]</span><span class="gatsby-highlight-code-line">            then</span><span class="gatsby-highlight-code-line">               rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span><span class="gatsby-highlight-code-line">            fi</span><span class="gatsby-highlight-code-line">            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">            then</span><span class="gatsby-highlight-code-line">               cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .</span><span class="gatsby-highlight-code-line">               bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">            else</span><span class="gatsby-highlight-code-line">               cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">               # 1、为了让脚本检测，2、master 拉取最新</span><span class="gatsby-highlight-code-line">               git checkout master</span><span class="gatsby-highlight-code-line">               git pull origin master</span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">               if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]</span><span class="gatsby-highlight-code-line">               then</span><span class="gatsby-highlight-code-line">                  git checkout <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                  # 强制拉取远程代码到本地</span><span class="gatsby-highlight-code-line">                  git pull --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">               fi</span><span class="gatsby-highlight-code-line">               cd ..</span><span class="gatsby-highlight-code-line">            fi</span><span class="gatsby-highlight-code-line">            # ls -la</span>            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                # pwd</span><span class="gatsby-highlight-code-line">                rsync -Lazv -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/</span>                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n<span class="gatsby-highlight-code-line">                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span>            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             sh <span class="token string gstring">"""\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                  echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                  exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n<span class="gatsby-highlight-code-line">                # pwd</span><span class="gatsby-highlight-code-line">                # ls</span><span class="gatsby-highlight-code-line">                # rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本二"><a href="#%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本二</h2>\n<ol>\n<li>固定使用一个目录为缓存目录，拷贝到带有新后缀的目录（拉取代码和构建代码的目录），和之前逻辑一样，解决并行执行问题</li>\n<li>不使用缓存时不拷贝到对应目录</li>\n<li>独立出缓存步骤，减少并行执行时带来的文件互操作问题</li>\n<li>修复非 master 分支时拉取代码的错误逻辑，强制更新远程代码到本地代码</li>\n<li>rsync 添加 <code class="language-text">-cr</code> 选项，去掉 <code class="language-text">-a</code> 选项，即更新时只比较所有文件的校验和，不再通过文件的更新时间比较（即不需要通过 <code class="language-text">-a</code> 传递所有的文件信息）</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51412867557594464000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\nwork_cache_dir = &quot;项目名称_cache&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage(\'Cache Workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\n                # rm -rf \\${work_cache_dir}\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    if [ ! -d \\${work_cache_dir} ]\n                    then\n                        echo &quot;Cache Workspace not found&quot;\n                    else\n                        cp -r \\${work_cache_dir} \\${work_dir}\n                        cd \\${work_dir} && ls\n                        echo &quot;Cache Workspace restore successful&quot;\n                    fi\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Cache Repo\') {\n        agent {\n            node {\n                label &quot;\\${clone_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                # vi clone.sh\n                # rm -rf \\${work_cache_dir}\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    if [ ! -d \\${work_cache_dir} ]\n                    then\n                        echo &quot;Cache Repo not found&quot;\n                    else\n                        cp -r \\${work_cache_dir} \\${work_dir}\n                        cd \\${work_dir} && ls\n                        echo &quot;Cache Repo restore successful&quot;\n                    fi\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n          agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            if [ ! -d \\${work_dir} ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n                cd \\${work_dir}\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ \\${branch_name} != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin \\${branch_name}:\\${branch_name}\n                    git checkout origin/\\${branch_name}\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n             sh &quot;&quot;&quot;\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Post Cache Workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    rm -rf \\${work_cache_dir}\n                    mv \\${work_dir} \\${work_cache_dir}\n                    echo \'Post Cache Workspace\'\n                else\n                    rm -rf \\${work_dir}\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Post Cache Repo\') {\n        agent {\n            node {\n                label &quot;\\${clone_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    rm -rf \\${work_cache_dir}\n                    mv \\${work_dir} \\${work_cache_dir}\n                    echo \'Post Cache Repo successful\'\n                else\n                    rm -rf \\${work_dir}\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n    }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `51412867557594464000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{34-35,75-87,100-112,138-140,161-162,206-214,227-234}"\n              >\n                <span class="gatsby-code-button-language">groovy{34-35,75-87,100-112,138-140,161-162,206-214,227-234}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\nis_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\n<span class="gatsby-highlight-code-line">work_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span></span><span class="gatsby-highlight-code-line">work_cache_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_cache"</span></span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                    then</span><span class="gatsby-highlight-code-line">                        echo "Cache Workspace not found"</span><span class="gatsby-highlight-code-line">                    else</span><span class="gatsby-highlight-code-line">                        cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                        echo "Cache Workspace restore successful"</span><span class="gatsby-highlight-code-line">                    fi</span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                # vi clone.sh</span><span class="gatsby-highlight-code-line">                # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                    then</span><span class="gatsby-highlight-code-line">                        echo "Cache Repo not found"</span><span class="gatsby-highlight-code-line">                    else</span><span class="gatsby-highlight-code-line">                        cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                        echo "Cache Repo restore successful"</span><span class="gatsby-highlight-code-line">                    fi</span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n          agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            # ls -la\n            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            else\n                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]\n                then\n<span class="gatsby-highlight-code-line">                    # 强制拉取远程代码到本地</span><span class="gatsby-highlight-code-line">                    git fetch --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    git checkout origin/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span>                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n                # pwd\n<span class="gatsby-highlight-code-line">                # 这里的 -c 选项比较重要，比较校验和</span><span class="gatsby-highlight-code-line">                rsync -Lrzvc -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/</span>                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             sh <span class="token string gstring">"""\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                # pwd\n                # ls\n            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    echo \'Post Cache Workspace\'</span><span class="gatsby-highlight-code-line">                else</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    echo \'Post Cache Repo successful\'</span><span class="gatsby-highlight-code-line">                else</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本三"><a href="#%E7%89%88%E6%9C%AC%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本三</h2>\n<ol>\n<li>缓存步骤并行执行</li>\n<li>对同一机器上的缓存操作时加锁，防止缓存失效</li>\n<li>因为运维那边对应的机器在同一时间执行时会在新的目录里面操作（会生成 <code class="language-text">@2</code>，<code class="language-text">＠3</code> 这样的目录），所以为了防止读不到缓存，需要在连接到机器时强制在同一目录里面操作</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63453881392473300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\nwork_cache_dir = &quot;项目名称_cache&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage (\'Cache\') {\n         failFast true\n         parallel {\n            stage(\'Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Workspace not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Workspace restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        # vi clone.sh\n                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Repo not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Repo restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n         agent {\n            node {\n                label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n            }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n            if [ ! -d \\${work_dir} ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n                cd \\${work_dir}\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ \\${branch_name} != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin \\${branch_name}:\\${branch_name}\n                    git checkout origin/\\${branch_name}\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                if [ ! -f Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n             &quot;&quot;&quot;\n        }\n      }\n\n      stage (\'Post Cache\') {\n         failFast true\n         parallel {\n            stage(\'Post Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            rm -rf \\${work_cache_dir}\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Workspace\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Post Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存\n                            rm -rf \\${work_cache_dir}\n                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑\n                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Repo successful\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n    }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `63453881392473300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{67-77,79-91,97-104,106-120,137,172,193-194,222-230,245-256}"\n              >\n                <span class="gatsby-code-button-language">groovy{67-77,79-91,97-104,106-120,137,172,193-194,222-230,245-256}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\nis_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\nwork_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\nwork_cache_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_cache"</span>\n\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      stage <span class="token punctuation">(</span><span class="token string">\'Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">         failFast <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">         parallel <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                agent <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    node <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                steps <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                            then</span><span class="gatsby-highlight-code-line">                                echo "Cache Workspace not found"</span><span class="gatsby-highlight-code-line">                            else</span><span class="gatsby-highlight-code-line">                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                                echo "Cache Workspace restore successful"</span><span class="gatsby-highlight-code-line">                            fi</span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line">            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                agent <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    node <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                steps <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        # vi clone.sh</span><span class="gatsby-highlight-code-line">                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录</span><span class="gatsby-highlight-code-line">                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span><span class="gatsby-highlight-code-line">                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                            then</span><span class="gatsby-highlight-code-line">                                echo "Cache Repo not found"</span><span class="gatsby-highlight-code-line">                            else</span><span class="gatsby-highlight-code-line">                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                                echo "Cache Repo restore successful"</span><span class="gatsby-highlight-code-line">                            fi</span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            # ls -la\n<span class="gatsby-highlight-code-line">            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span>            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            else\n                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                    git checkout origin/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span>                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/\n                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/</span><span class="gatsby-highlight-code-line">                if [ ! -f Dockerfile-client-buildkit ]</span>                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                # pwd\n                # ls\n             """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      stage <span class="token punctuation">(</span><span class="token string">\'Post Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         failFast <span class="token boolean">true</span>\n         parallel <span class="token punctuation">{</span>\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            echo \'Post Cache Workspace\'</span><span class="gatsby-highlight-code-line">                        else</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑</span><span class="gatsby-highlight-code-line">                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名</span><span class="gatsby-highlight-code-line">                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            echo \'Post Cache Repo successful\'</span><span class="gatsby-highlight-code-line">                        else</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本四"><a href="#%E7%89%88%E6%9C%AC%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本四</h2>\n<ol>\n<li>生成时间戳优化，因为现有的时间戳是精确到秒的，还是有产生冲突的概率，改成毫秒（更好的方式是生成唯一性的 id）</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82179948378504840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\ndef createVersion() {\n   long ymd = System.currentTimeMillis()\n   return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\nwork_cache_dir = &quot;项目名称_cache&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage (\'Cache\') {\n         failFast true\n         parallel {\n            stage(\'Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Workspace not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Workspace restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        # vi clone.sh\n                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Repo not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Repo restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n         agent {\n            node {\n                label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n            }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n            if [ ! -d \\${work_dir} ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n                cd \\${work_dir}\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ \\${branch_name} != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin \\${branch_name}:\\${branch_name}\n                    git checkout origin/\\${branch_name}\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                if [ ! -f Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n             &quot;&quot;&quot;\n        }\n      }\n\n      stage (\'Post Cache\') {\n         failFast true\n         parallel {\n            stage(\'Post Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            rm -rf \\${work_cache_dir}\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Workspace\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Post Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存\n                            rm -rf \\${work_cache_dir}\n                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑\n                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Repo successful\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n    }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `82179948378504840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{25-26}"\n              >\n                <span class="gatsby-code-button-language">groovy{25-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\nis_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   <span class="token keyword">long</span> ymd <span class="token operator">=</span> System<span class="token operator">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span></span><span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\nwork_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\nwork_cache_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_cache"</span>\n\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n      stage <span class="token punctuation">(</span><span class="token string">\'Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         failFast <span class="token boolean">true</span>\n         parallel <span class="token punctuation">{</span>\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]\n                            then\n                                echo "Cache Workspace not found"\n                            else\n                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls\n                                echo "Cache Workspace restore successful"\n                            fi\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        # vi clone.sh\n                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]\n                            then\n                                echo "Cache Repo not found"\n                            else\n                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls\n                                echo "Cache Repo restore successful"\n                            fi\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            # ls -la\n            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            else\n                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                    git checkout origin/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/\n                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                if [ ! -f Dockerfile-client-buildkit ]\n                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                # pwd\n                # ls\n             """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      stage <span class="token punctuation">(</span><span class="token string">\'Post Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         failFast <span class="token boolean">true</span>\n         parallel <span class="token punctuation">{</span>\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            echo \'Post Cache Workspace\'\n                        else\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑\n                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名\n                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            echo \'Post Cache Repo successful\'\n                        else\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="优化效果"><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化效果</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.10937499999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABTUlEQVQY0y1Qy26rMBTk/3+nm7uvVHV3V22jhKcxTcCPGNsYCMbTE9rFaObMyKNznA1C7d67fds2EFKMkbDhsa5wo4O3Dna0hw5TgJYa5j5iJFhjSRsYbXBXmjyDzFgP6zy89ynMMwwVSCEhtEQ1NOjMFY1o0SiO77FHI1vyOYqeETPKb6gpZ6rDt+mRSa3fKt7/p0Isy5KENmkJM/wekAcG9rginxjKhYPvw8HVzFH+oTny5vC7KJD1SrxqJd+ds1jXR7oJlTStL73GhzrjYmt8yDO+dI7CM3zdc9LFMT9xHqvf/F6g9C2yQcl/QoiXaZrSFiOug0zPv9DB4JMe577Bp77gZEpUgeM0liho46d/MgUujnJ1Ofw6dMjKtl7rqpqttSnuO7T1ad8ifAwopxbtekPh2FHWRTqZmG8D2kePauJgK538zOcO1yjxA4YbwRb5pYhaAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 12 22 15" title="" data-src="/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-fee1c.png" data-srcset="/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-a67b7.png 200w,\n/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-0b187.png 400w,\n/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-fee1c.png 800w,\n/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-b1a91.png 1200w,\n/static/2023-02-10-12-22-15-2b4b76a1c67b50267371caf56e1c0884-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="后期展望"><a href="#%E5%90%8E%E6%9C%9F%E5%B1%95%E6%9C%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期展望</h1>\n<ol>\n<li>后端 jenkins 增量构建优化</li>\n<li>gitlab 发布评论触发 jenkins 等环境的一键部署</li>\n<li><a href="https://github.com/towavephone/webpack-lazy-build-demo" target="_blank" rel="nofollow noreferrer noopener">webpack 懒编译</a>，模仿 webpack5 与 vite 的懒编译思路</li>\n<li><a href="https://github.com/i5ting/learn-rust-for-fe" target="_blank" rel="nofollow noreferrer noopener">rust 相关前端工具链</a>，例如 Bun，Next.js，swc，Turbopack</li>\n</ol>',
excerpt:"需求背景 接上文  CRA 项目构建速度优化 由下图可以看出此项目的  ，  耗时较长，需要优化 方案 目前是全量更新，需要改成增量更新 实现 原始版本 版本一 固定使用一个目录为缓存目录，拉取代码和构建代码都在这个缓存目录上 利用 git 和 rsync…",frontmatter:{date:"2023-02-10 12:06:31",path:"/jenkins-build-speed-optimize/",tags:"运维, jenkins, 预研",title:"jenkins 编译速度优化",draft:null}}},pathContext:{mainPostPath:"/three-js-practice-test/",nextPostPath:"/cra-project-build-speed-optimize/",prePostPath:"/jenkins-build-speed-optimize/"}}}});